<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Non-Gaussian Mixed Models • JMbayes2</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<!-- katex math --><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" integrity="sha384-nB0miv6/jRmo5UMMR1wu3Gz6NLsoTkbqJghGIsx//Rlm+ZU03BU6SQNC66uf4l5+" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js" integrity="sha384-7zkQWkzuo3B5mTepMUcHkMB5jZaolc2xDwL6VFqjFALcbeS9Ggm/Yr2r3Dy4lfFg" crossorigin="anonymous"></script><script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js" integrity="sha384-43gviWU0YVjaDtb/GhzOouOXtZMP/7XUzwPTstBeZFe/+rCMvRwr4yROQP43s0Xk" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script><script src="../katex-auto.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Non-Gaussian Mixed Models">
<meta name="robots" content="noindex">
<!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-YDBZ5DBBSP"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-YDBZ5DBBSP');
</script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">JMbayes2</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.5-91</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/JMbayes2.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/Baseline_Hazard.html">Baseline Hazard Function</a></li>
    <li><a class="dropdown-item" href="../articles/Causal_Effects.html">Causal Effects</a></li>
    <li><a class="dropdown-item" href="../articles/Competing_Risks.html">Competing Risks</a></li>
    <li><a class="dropdown-item" href="../articles/Dynamic_Predictions.html">Dynamic Predictions</a></li>
    <li><a class="dropdown-item" href="../articles/Multi_State_Processes.html">Multi-State Processes</a></li>
    <li><a class="dropdown-item" href="../articles/Non_Gaussian_Mixed_Models.html">Non-Gaussian Mixed Models</a></li>
    <li><a class="dropdown-item" href="../articles/Recurring_Events.html">Recurrent Events</a></li>
    <li><a class="dropdown-item" href="../articles/Super_Learning.html">Combined Dynamic Predictions via Super Learning</a></li>
    <li><a class="dropdown-item" href="../articles/Time_Varying_Effects.html">Time Varying Effects</a></li>
    <li><a class="dropdown-item" href="../articles/Transformation_Functions.html">Transformation Functions for Functional Forms</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/drizopoulos/JMbayes2/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Non-Gaussian Mixed Models</h1>
                        <h4 data-toc-skip class="author">Dimitris
Rizopoulos</h4>
            
            <h4 data-toc-skip class="date">2025-08-22</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/drizopoulos/JMbayes2/blob/HEAD/vignettes/Non_Gaussian_Mixed_Models.Rmd" class="external-link"><code>vignettes/Non_Gaussian_Mixed_Models.Rmd</code></a></small>
      <div class="d-none name"><code>Non_Gaussian_Mixed_Models.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="non-gaussian-joint-models-with-jmbayes2">Non-Gaussian Joint Models with JMbayes2<a class="anchor" aria-label="anchor" href="#non-gaussian-joint-models-with-jmbayes2"></a>
</h2>
<p>Taking advantage of the versatility of the <a href="https://drizopoulos.github.io/GLMMadaptive/" class="external-link"><strong>GLMMadaptive</strong></a>
package, <strong>JMbayes2</strong> can fit joint models with several
different types of mixed-effects models. The following examples
illustrate these capabilities. All examples have the same structure,
namely, first, a short motivation for each mixed-model is given,
followed by a piece of R code simulating data from a joint model with
the respective mixed-effects sub-model, closing by the syntax to fit the
joint model. In this last part, the main difference per example is the
call to <code><a href="https://drizopoulos.github.io/GLMMadaptive/reference/mixed_model.html" class="external-link">mixed_model()</a></code>.</p>
<div class="section level3">
<h3 id="beta-mixed-models">Beta mixed models<a class="anchor" aria-label="anchor" href="#beta-mixed-models"></a>
</h3>
<p>With very few exceptions, continuous outcomes that we wish to analyze
have some natural bounds. For example, the levels of blood biomarkers
for a set of patients. However, most observations are often located far
away from these natural bounds, and an assumption of a normal
distribution for the outcome can be safely made. In some settings,
though, we can have outcomes for which a substantial percentage of the
observations are located near the boundaries, leading to skewed or
U-shaped distributions. A linear mixed model with normal error terms
often does not fit such longitudinal outcomes well. A natural
alternative is to select a distribution that respects the bounded nature
of the outcome. The most well-known distribution for such outcomes is
the Beta distribution defined in the <span class="math inline">(0,
1)</span> interval (<em>note:</em> a bounded outcome <span class="math inline">Y^*</span> in the <span class="math inline">(a,
b)</span> interval can be transformed to the <span class="math inline">Y
= (Y^* - a) / (b - a)</span> in the <span class="math inline">(0,
1)</span> interval).</p>
<p>The following code illustrates how to simulate data from a joint
model with a Beta mixed effects model. The default functional form is
assumed, i.e., that the linear predictor <span class="math inline">\eta(t)</span> of the mixed model is associated with
the hazard of an event at time <span class="math inline">t</span>. The
linear predictor is related to the mean <span class="math inline">\mu(t)</span> of the Beta distribution under the
logit link function, i.e., <span class="math inline">\log[\mu(t) / \{1 -
\mu(t)\}] = \eta(t)</span>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1234</span><span class="op">)</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">200</span> <span class="co"># number of subjects</span></span>
<span><span class="va">K</span> <span class="op">&lt;-</span> <span class="fl">8</span> <span class="co"># number of measurements per subject</span></span>
<span><span class="va">t_max</span> <span class="op">&lt;-</span> <span class="fl">10</span> <span class="co"># maximum follow-up time</span></span>
<span></span>
<span><span class="co"># we construct a data frame with the design:</span></span>
<span><span class="co"># everyone has a baseline measurement, and then measurements at random </span></span>
<span><span class="co"># follow-up times up to t_max</span></span>
<span><span class="va">DF</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>, each <span class="op">=</span> <span class="va">K</span><span class="op">)</span>,</span>
<span>                 time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">replicate</a></span><span class="op">(</span><span class="va">n</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">K</span> <span class="op">-</span> <span class="fl">1</span>, <span class="fl">0</span>, <span class="va">t_max</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                 sex <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/gl.html" class="external-link">gl</a></span><span class="op">(</span><span class="fl">2</span>, <span class="va">n</span><span class="op">/</span><span class="fl">2</span>, labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"male"</span>, <span class="st">"female"</span><span class="op">)</span><span class="op">)</span>, each <span class="op">=</span> <span class="va">K</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># design matrices for the fixed and random effects</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/methods.html">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="va">sex</span> <span class="op">*</span> <span class="va">time</span>, data <span class="op">=</span> <span class="va">DF</span><span class="op">)</span></span>
<span><span class="va">Z</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/methods.html">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="va">time</span>, data <span class="op">=</span> <span class="va">DF</span><span class="op">)</span></span>
<span></span>
<span><span class="va">betas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2.2</span>, <span class="op">-</span><span class="fl">0.25</span>, <span class="fl">0.24</span>, <span class="op">-</span><span class="fl">0.05</span><span class="op">)</span> <span class="co"># fixed effects coefficients</span></span>
<span><span class="va">phi</span> <span class="op">&lt;-</span> <span class="fl">5</span> <span class="co"># precision parameter of the Beta distribution</span></span>
<span><span class="va">D11</span> <span class="op">&lt;-</span> <span class="fl">1.0</span> <span class="co"># variance of random intercepts</span></span>
<span><span class="va">D22</span> <span class="op">&lt;-</span> <span class="fl">0.5</span> <span class="co"># variance of random slopes</span></span>
<span></span>
<span><span class="co"># we simulate random effects</span></span>
<span><span class="va">b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span>, sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">D11</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span>, sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">D22</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># linear predictor</span></span>
<span><span class="va">eta_y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">X</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">betas</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">Z</span> <span class="op">*</span> <span class="va">b</span><span class="op">[</span><span class="va">DF</span><span class="op">$</span><span class="va">id</span>, <span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># mean of the Beta distribution</span></span>
<span><span class="va">mu_y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Logistic.html" class="external-link">plogis</a></span><span class="op">(</span><span class="va">eta_y</span><span class="op">)</span> <span class="co"># plogis(eta_y) = exp(eta_y) / (1 + exp(eta_y))</span></span>
<span><span class="co"># we simulate Beta longitudinal data</span></span>
<span><span class="va">DF</span><span class="op">$</span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Beta.html" class="external-link">rbeta</a></span><span class="op">(</span><span class="va">n</span> <span class="op">*</span> <span class="va">K</span>, shape1 <span class="op">=</span> <span class="va">mu_y</span> <span class="op">*</span> <span class="va">phi</span>, shape2 <span class="op">=</span> <span class="va">phi</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">mu_y</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># we transform to (0, 1)</span></span>
<span><span class="va">DF</span><span class="op">$</span><span class="va">y</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">DF</span><span class="op">$</span><span class="va">y</span> <span class="op">*</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">DF</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">DF</span><span class="op">)</span></span>
<span></span>
<span><span class="va">upp_Cens</span> <span class="op">&lt;-</span> <span class="fl">15</span> <span class="co"># fixed Type I censoring time</span></span>
<span><span class="va">shape_wb</span> <span class="op">&lt;-</span> <span class="fl">5</span> <span class="co"># shape Weibull</span></span>
<span><span class="va">alpha</span> <span class="op">&lt;-</span> <span class="fl">0.8</span> <span class="co"># association coefficients</span></span>
<span><span class="va">gammas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"(Intercept)"</span> <span class="op">=</span> <span class="op">-</span><span class="fl">9</span>, <span class="st">"sex"</span> <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span><span class="va">W</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/methods.html">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="va">sex</span>, data <span class="op">=</span> <span class="va">DF</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/duplicated.html" class="external-link">duplicated</a></span><span class="op">(</span><span class="va">DF</span><span class="op">$</span><span class="va">id</span><span class="op">)</span>, <span class="op">]</span><span class="op">)</span></span>
<span><span class="co"># linear predictor for the survival model</span></span>
<span><span class="va">eta_t</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">W</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">gammas</span><span class="op">)</span></span>
<span><span class="co"># to simulate event times we use inverse transform sampling</span></span>
<span><span class="co"># (https://en.wikipedia.org/wiki/Inverse_transform_sampling). Namely, we want </span></span>
<span><span class="co"># to find t, such that S(t) = u, where S(.) is the survival function, and u a </span></span>
<span><span class="co"># number from the Unif(0, 1) distribution. The function below calculates </span></span>
<span><span class="co"># log(u) - log(S(t)), and for a given u, we want to find t for which it equals</span></span>
<span><span class="co"># zero. We do that below using the uniroot() function</span></span>
<span><span class="va">invS</span> <span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="va">t</span>, <span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># i denotes the subject</span></span>
<span>  <span class="va">sex_i</span> <span class="op">&lt;-</span> <span class="va">W</span><span class="op">[</span><span class="va">i</span>, <span class="fl">2L</span><span class="op">]</span></span>
<span>  <span class="co"># h() is the hazard function and we assume a Weibull baseline hazard</span></span>
<span>  <span class="va">h</span> <span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="va">s</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">X_at_s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">sex_i</span>, <span class="va">s</span>, <span class="va">sex_i</span> <span class="op">*</span> <span class="va">s</span><span class="op">)</span></span>
<span>    <span class="va">Z_at_s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">s</span><span class="op">)</span></span>
<span>    <span class="co"># the linear predictor from the mixed model evaluated at time s</span></span>
<span>    <span class="va">f</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">X_at_s</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">betas</span> <span class="op">+</span></span>
<span>                     <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">Z_at_s</span> <span class="op">*</span> <span class="va">b</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">i</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">Z_at_s</span><span class="op">)</span><span class="op">)</span>, <span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">shape_wb</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="va">shape_wb</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">s</span><span class="op">)</span> <span class="op">+</span> <span class="va">eta_t</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">+</span> <span class="va">f</span> <span class="op">*</span> <span class="va">alpha</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="co"># -log(S(t)) = H(t), where H(t) is the cumulative hazard function</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/integrate.html" class="external-link">integrate</a></span><span class="op">(</span><span class="va">h</span>, lower <span class="op">=</span> <span class="fl">0</span>, upper <span class="op">=</span> <span class="va">t</span><span class="op">)</span><span class="op">$</span><span class="va">value</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">u</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co"># we simulate the event times</span></span>
<span><span class="va">u</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="va">trueTimes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">Up</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span>    <span class="va">Root</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/try.html" class="external-link">try</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/uniroot.html" class="external-link">uniroot</a></span><span class="op">(</span><span class="va">invS</span>, interval <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1e-05</span>, <span class="va">Up</span><span class="op">)</span>, i <span class="op">=</span> <span class="va">i</span><span class="op">)</span><span class="op">$</span><span class="va">root</span>, <span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="va">trueTimes</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">inherits</a></span><span class="op">(</span><span class="va">Root</span>, <span class="st">"try-error"</span><span class="op">)</span><span class="op">)</span> <span class="va">Root</span> <span class="kw">else</span> <span class="fl">150</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># we use fixed Type I right censoring denoting the end of the trial.</span></span>
<span><span class="va">Ctimes</span> <span class="op">&lt;-</span> <span class="va">upp_Cens</span></span>
<span><span class="va">Time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmin</a></span><span class="op">(</span><span class="va">trueTimes</span>, <span class="va">Ctimes</span><span class="op">)</span></span>
<span><span class="va">event</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">trueTimes</span> <span class="op">&lt;=</span> <span class="va">Ctimes</span><span class="op">)</span> <span class="co"># event indicator</span></span>
<span></span>
<span><span class="co"># we keep the longitudinal measurements before the event times</span></span>
<span><span class="va">DF</span><span class="op">$</span><span class="va">Time</span> <span class="op">&lt;-</span> <span class="va">Time</span><span class="op">[</span><span class="va">DF</span><span class="op">$</span><span class="va">id</span><span class="op">]</span></span>
<span><span class="va">DF</span><span class="op">$</span><span class="va">event</span> <span class="op">&lt;-</span> <span class="va">event</span><span class="op">[</span><span class="va">DF</span><span class="op">$</span><span class="va">id</span><span class="op">]</span></span>
<span><span class="va">DF</span> <span class="op">&lt;-</span> <span class="va">DF</span><span class="op">[</span><span class="va">DF</span><span class="op">$</span><span class="va">time</span> <span class="op">&lt;=</span> <span class="va">DF</span><span class="op">$</span><span class="va">Time</span>, <span class="op">]</span></span></code></pre></div>
<p>To fit the corresponding joint model, we fit first a Beta mixed model
using the <code><a href="https://drizopoulos.github.io/GLMMadaptive/reference/extra_fams.html" class="external-link">beta.fam()</a></code> family object into the call of
<code><a href="https://drizopoulos.github.io/GLMMadaptive/reference/mixed_model.html" class="external-link">mixed_model()</a></code>:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">DF_id</span> <span class="op">&lt;-</span> <span class="va">DF</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/duplicated.html" class="external-link">duplicated</a></span><span class="op">(</span><span class="va">DF</span><span class="op">$</span><span class="va">id</span><span class="op">)</span>, <span class="op">]</span></span>
<span><span class="va">Cox_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html" class="external-link">coxph</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">Time</span>, <span class="va">event</span><span class="op">)</span> <span class="op">~</span> <span class="va">sex</span>, data <span class="op">=</span> <span class="va">DF_id</span><span class="op">)</span></span>
<span><span class="va">Beta_MixMod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://drizopoulos.github.io/GLMMadaptive/reference/mixed_model.html" class="external-link">mixed_model</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">sex</span> <span class="op">*</span> <span class="va">time</span>, random <span class="op">=</span> <span class="op">~</span> <span class="va">time</span> <span class="op">|</span> <span class="va">id</span>, data <span class="op">=</span> <span class="va">DF</span>,</span>
<span>                           family <span class="op">=</span> <span class="fu"><a href="https://drizopoulos.github.io/GLMMadaptive/reference/extra_fams.html" class="external-link">beta.fam</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">jointFit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/jm.html">jm</a></span><span class="op">(</span><span class="va">Cox_fit</span>, <span class="va">Beta_MixMod</span>, time_var <span class="op">=</span> <span class="st">"time"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">jointFit</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; jm(Surv_object = Cox_fit, Mixed_objects = Beta_MixMod, time_var = "time")</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Data Descriptives:</span></span>
<span><span class="co">#&gt; Number of Groups: 200        Number of events: 158 (79%)</span></span>
<span><span class="co">#&gt; Number of Observations:</span></span>
<span><span class="co">#&gt;   y: 1182</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                   DIC      WAIC     LPML</span></span>
<span><span class="co">#&gt; marginal    -4018.171 -4061.024 1910.317</span></span>
<span><span class="co">#&gt; conditional -3837.701 -3938.538 1799.508</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Random-effects covariance matrix:</span></span>
<span><span class="co">#&gt;                     </span></span>
<span><span class="co">#&gt;        StdDev   Corr</span></span>
<span><span class="co">#&gt; (Intr) 0.8436 (Intr)</span></span>
<span><span class="co">#&gt; time   0.4664 0.0812</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Survival Outcome:</span></span>
<span><span class="co">#&gt;             Mean  StDev    2.5%  97.5%      P   Rhat</span></span>
<span><span class="co">#&gt; sexfemale 0.2153 0.2944 -0.3672 0.7865 0.4669 1.0030</span></span>
<span><span class="co">#&gt; value(y)  1.0656 0.1018  0.8866 1.2781 0.0000 1.0832</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Longitudinal Outcome: y (family = beta, link = logit)</span></span>
<span><span class="co">#&gt;                   Mean  StDev    2.5%   97.5%      P   Rhat</span></span>
<span><span class="co">#&gt; (Intercept)    -2.3410 0.1115 -2.5592 -2.1270 0.0000 1.0046</span></span>
<span><span class="co">#&gt; sexfemale      -0.0689 0.1486 -0.3584  0.2241 0.6462 1.0144</span></span>
<span><span class="co">#&gt; time            0.3271 0.0523  0.2258  0.4312 0.0000 1.0022</span></span>
<span><span class="co">#&gt; sexfemale:time -0.0615 0.0729 -0.2035  0.0801 0.3898 1.0059</span></span>
<span><span class="co">#&gt; sigma           6.2757 0.3932  5.5169  7.0813 0.0000 1.0064</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; MCMC summary:</span></span>
<span><span class="co">#&gt; chains: 3 </span></span>
<span><span class="co">#&gt; iterations per chain: 3500 </span></span>
<span><span class="co">#&gt; burn-in per chain: 500 </span></span>
<span><span class="co">#&gt; thinning: 1 </span></span>
<span><span class="co">#&gt; time: 20 sec</span></span></code></pre></div>
<div align="right">
<a href="#top">Back to top</a>
</div>
</div>
<div class="section level3">
<h3 id="censored-linear-mixed-models">Censored linear mixed models<a class="anchor" aria-label="anchor" href="#censored-linear-mixed-models"></a>
</h3>
<p>Some continuous longitudinal outcomes may have a censored nature. A
typical example of such outcomes is when we have a limit of detection
issue. That is, the values of the outcome cannot be detected below a
specified threshold having to do with the (laboratory) equipment used to
determine the measurements. In these settings, even if the complete data
follows a normal distribution the observed censored data cannot be
analyzed using a standard mixed model. The <code><a href="https://drizopoulos.github.io/GLMMadaptive/reference/mixed_model.html" class="external-link">mixed_model()</a></code>
function can accommodate such outcomes using the
<code><a href="https://drizopoulos.github.io/GLMMadaptive/reference/extra_fams.html" class="external-link">censored.normal()</a></code> family object.</p>
<p>The following code simulates data from a joint model with a linear
mixed model for the longitudinal outcomes but applies censoring in the
realized longitudinal observations.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1234</span><span class="op">)</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">200</span> <span class="co"># number of subjects</span></span>
<span><span class="va">K</span> <span class="op">&lt;-</span> <span class="fl">12</span> <span class="co"># number of measurements per subject</span></span>
<span><span class="va">t_max</span> <span class="op">&lt;-</span> <span class="fl">14</span> <span class="co"># maximum follow-up time</span></span>
<span></span>
<span><span class="co"># we construct a data frame with the design:</span></span>
<span><span class="co"># everyone has a baseline measurement, and then measurements at random </span></span>
<span><span class="co"># follow-up times up to t_max</span></span>
<span><span class="va">DF</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>, each <span class="op">=</span> <span class="va">K</span><span class="op">)</span>,</span>
<span>                 time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">replicate</a></span><span class="op">(</span><span class="va">n</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">K</span> <span class="op">-</span> <span class="fl">1</span>, <span class="fl">0</span>, <span class="va">t_max</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                 sex <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/gl.html" class="external-link">gl</a></span><span class="op">(</span><span class="fl">2</span>, <span class="va">n</span><span class="op">/</span><span class="fl">2</span>, labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"male"</span>, <span class="st">"female"</span><span class="op">)</span><span class="op">)</span>, each <span class="op">=</span> <span class="va">K</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># design matrices for the fixed and random effects</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/methods.html">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="va">sex</span> <span class="op">*</span> <span class="va">time</span>, data <span class="op">=</span> <span class="va">DF</span><span class="op">)</span></span>
<span><span class="va">Z</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/methods.html">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="va">time</span>, data <span class="op">=</span> <span class="va">DF</span><span class="op">)</span></span>
<span></span>
<span><span class="va">betas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2.2</span>, <span class="op">-</span><span class="fl">0.25</span>, <span class="fl">0.24</span>, <span class="op">-</span><span class="fl">0.05</span><span class="op">)</span> <span class="co"># fixed effects coefficients</span></span>
<span><span class="va">sigma</span> <span class="op">&lt;-</span> <span class="fl">0.5</span> <span class="co"># errors' standard deviation</span></span>
<span><span class="va">D11</span> <span class="op">&lt;-</span> <span class="fl">1.0</span> <span class="co"># variance of random intercepts</span></span>
<span><span class="va">D22</span> <span class="op">&lt;-</span> <span class="fl">0.5</span> <span class="co"># variance of random slopes</span></span>
<span></span>
<span><span class="co"># we simulate random effects</span></span>
<span><span class="va">b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span>, sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">D11</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span>, sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">D22</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># linear predictor</span></span>
<span><span class="va">eta_y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">X</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">betas</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">Z</span> <span class="op">*</span> <span class="va">b</span><span class="op">[</span><span class="va">DF</span><span class="op">$</span><span class="va">id</span>, <span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># we simulate normal longitudinal data</span></span>
<span><span class="va">DF</span><span class="op">$</span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span> <span class="op">*</span> <span class="va">K</span>, mean <span class="op">=</span> <span class="va">eta_y</span>, sd <span class="op">=</span> <span class="va">sigma</span><span class="op">)</span></span>
<span><span class="co"># we assume that values below -4 are not observed, and set equal to -4</span></span>
<span><span class="va">DF</span><span class="op">$</span><span class="va">ind</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">DF</span><span class="op">$</span><span class="va">y</span> <span class="op">&lt;</span> <span class="op">-</span><span class="fl">4</span><span class="op">)</span></span>
<span><span class="va">DF</span><span class="op">$</span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmax</a></span><span class="op">(</span><span class="va">DF</span><span class="op">$</span><span class="va">y</span>, <span class="op">-</span><span class="fl">4</span><span class="op">)</span></span>
<span></span>
<span><span class="va">upp_Cens</span> <span class="op">&lt;-</span> <span class="fl">15</span> <span class="co"># fixed Type I censoring time</span></span>
<span><span class="va">shape_wb</span> <span class="op">&lt;-</span> <span class="fl">5</span> <span class="co"># shape Weibull</span></span>
<span><span class="va">alpha</span> <span class="op">&lt;-</span> <span class="fl">0.8</span> <span class="co"># association coefficients</span></span>
<span><span class="va">gammas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"(Intercept)"</span> <span class="op">=</span> <span class="op">-</span><span class="fl">9</span>, <span class="st">"sex"</span> <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span><span class="va">W</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/methods.html">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="va">sex</span>, data <span class="op">=</span> <span class="va">DF</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/duplicated.html" class="external-link">duplicated</a></span><span class="op">(</span><span class="va">DF</span><span class="op">$</span><span class="va">id</span><span class="op">)</span>, <span class="op">]</span><span class="op">)</span></span>
<span><span class="co"># linear predictor for the survival model</span></span>
<span><span class="va">eta_t</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">W</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">gammas</span><span class="op">)</span></span>
<span><span class="co"># to simulate event times we use inverse transform sampling</span></span>
<span><span class="co"># (https://en.wikipedia.org/wiki/Inverse_transform_sampling). Namely, we want </span></span>
<span><span class="co"># to find t, such that S(t) = u, where S(.) is the survival function, and u a </span></span>
<span><span class="co"># number from the Unif(0, 1) distribution. The function below calculates </span></span>
<span><span class="co"># log(u) - log(S(t)), and for a given u, we want to find t for which it equals</span></span>
<span><span class="co"># zero. We do that below using the uniroot() function</span></span>
<span><span class="va">invS</span> <span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="va">t</span>, <span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># i denotes the subject</span></span>
<span>  <span class="va">sex_i</span> <span class="op">&lt;-</span> <span class="va">W</span><span class="op">[</span><span class="va">i</span>, <span class="fl">2L</span><span class="op">]</span></span>
<span>  <span class="co"># h() is the hazard function and we assume a Weibull baseline hazard</span></span>
<span>  <span class="va">h</span> <span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="va">s</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">X_at_s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">sex_i</span>, <span class="va">s</span>, <span class="va">sex_i</span> <span class="op">*</span> <span class="va">s</span><span class="op">)</span></span>
<span>    <span class="va">Z_at_s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">s</span><span class="op">)</span></span>
<span>    <span class="co"># the linear predictor from the mixed model evaluated at time s</span></span>
<span>    <span class="va">f</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">X_at_s</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">betas</span> <span class="op">+</span></span>
<span>                     <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">Z_at_s</span> <span class="op">*</span> <span class="va">b</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">i</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">Z_at_s</span><span class="op">)</span><span class="op">)</span>, <span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">shape_wb</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="va">shape_wb</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">s</span><span class="op">)</span> <span class="op">+</span> <span class="va">eta_t</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">+</span> <span class="va">f</span> <span class="op">*</span> <span class="va">alpha</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="co"># -log(S(t)) = H(t), where H(t) is the cumulative hazard function</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/integrate.html" class="external-link">integrate</a></span><span class="op">(</span><span class="va">h</span>, lower <span class="op">=</span> <span class="fl">0</span>, upper <span class="op">=</span> <span class="va">t</span><span class="op">)</span><span class="op">$</span><span class="va">value</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">u</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co"># we simulate the event times</span></span>
<span><span class="va">u</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="va">trueTimes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">Up</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span>    <span class="va">Root</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/try.html" class="external-link">try</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/uniroot.html" class="external-link">uniroot</a></span><span class="op">(</span><span class="va">invS</span>, interval <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1e-05</span>, <span class="va">Up</span><span class="op">)</span>, i <span class="op">=</span> <span class="va">i</span><span class="op">)</span><span class="op">$</span><span class="va">root</span>, <span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="va">trueTimes</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">inherits</a></span><span class="op">(</span><span class="va">Root</span>, <span class="st">"try-error"</span><span class="op">)</span><span class="op">)</span> <span class="va">Root</span> <span class="kw">else</span> <span class="fl">150</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># we use fixed Type I right censoring denoting the end of the trial.</span></span>
<span><span class="va">Ctimes</span> <span class="op">&lt;-</span> <span class="va">upp_Cens</span></span>
<span><span class="va">Time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmin</a></span><span class="op">(</span><span class="va">trueTimes</span>, <span class="va">Ctimes</span><span class="op">)</span></span>
<span><span class="va">event</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">trueTimes</span> <span class="op">&lt;=</span> <span class="va">Ctimes</span><span class="op">)</span> <span class="co"># event indicator</span></span>
<span></span>
<span><span class="co"># we keep the longitudinal measurements before the event times</span></span>
<span><span class="va">DF</span><span class="op">$</span><span class="va">Time</span> <span class="op">&lt;-</span> <span class="va">Time</span><span class="op">[</span><span class="va">DF</span><span class="op">$</span><span class="va">id</span><span class="op">]</span></span>
<span><span class="va">DF</span><span class="op">$</span><span class="va">event</span> <span class="op">&lt;-</span> <span class="va">event</span><span class="op">[</span><span class="va">DF</span><span class="op">$</span><span class="va">id</span><span class="op">]</span></span>
<span><span class="va">DF</span> <span class="op">&lt;-</span> <span class="va">DF</span><span class="op">[</span><span class="va">DF</span><span class="op">$</span><span class="va">time</span> <span class="op">&lt;=</span> <span class="va">DF</span><span class="op">$</span><span class="va">Time</span>, <span class="op">]</span></span></code></pre></div>
<p>The corresponding joint model is fitted with the following
syntax:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">DF_id</span> <span class="op">&lt;-</span> <span class="va">DF</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/duplicated.html" class="external-link">duplicated</a></span><span class="op">(</span><span class="va">DF</span><span class="op">$</span><span class="va">id</span><span class="op">)</span>, <span class="op">]</span></span>
<span><span class="va">Cox_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html" class="external-link">coxph</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">Time</span>, <span class="va">event</span><span class="op">)</span> <span class="op">~</span> <span class="va">sex</span>, data <span class="op">=</span> <span class="va">DF_id</span><span class="op">)</span></span>
<span><span class="va">CensNorm_MixMod</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="https://drizopoulos.github.io/GLMMadaptive/reference/mixed_model.html" class="external-link">mixed_model</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">y</span>, <span class="va">ind</span><span class="op">)</span> <span class="op">~</span> <span class="va">sex</span> <span class="op">*</span> <span class="va">time</span>, random <span class="op">=</span> <span class="op">~</span> <span class="va">time</span> <span class="op">|</span> <span class="va">id</span>, data <span class="op">=</span> <span class="va">DF</span>,</span>
<span>                family <span class="op">=</span> <span class="fu"><a href="https://drizopoulos.github.io/GLMMadaptive/reference/extra_fams.html" class="external-link">censored.normal</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">jointFit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/jm.html">jm</a></span><span class="op">(</span><span class="va">Cox_fit</span>, <span class="va">CensNorm_MixMod</span>, time_var <span class="op">=</span> <span class="st">"time"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">jointFit</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; jm(Surv_object = Cox_fit, Mixed_objects = CensNorm_MixMod, time_var = "time")</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Data Descriptives:</span></span>
<span><span class="co">#&gt; Number of Groups: 200        Number of events: 165 (82.5%)</span></span>
<span><span class="co">#&gt; Number of Observations:</span></span>
<span><span class="co">#&gt;   cbind(y, ind): 1346</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                  DIC     WAIC      LPML</span></span>
<span><span class="co">#&gt; marginal    3718.336 4647.791 -3267.595</span></span>
<span><span class="co">#&gt; conditional 3330.882 3218.840 -1744.693</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Random-effects covariance matrix:</span></span>
<span><span class="co">#&gt;                     </span></span>
<span><span class="co">#&gt;        StdDev   Corr</span></span>
<span><span class="co">#&gt; (Intr) 0.9502 (Intr)</span></span>
<span><span class="co">#&gt; time   0.6633 0.1447</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Survival Outcome:</span></span>
<span><span class="co">#&gt;                        Mean  StDev   2.5%  97.5%      P   Rhat</span></span>
<span><span class="co">#&gt; sexfemale            0.6065 0.2483 0.1192 1.0889 0.0107 1.0027</span></span>
<span><span class="co">#&gt; value(cbind(y, ind)) 0.8702 0.0641 0.7540 1.0005 0.0000 1.0477</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Longitudinal Outcome: cbind(y, ind) (family = censored normal, link = identity)</span></span>
<span><span class="co">#&gt;                   Mean  StDev    2.5%   97.5%      P   Rhat</span></span>
<span><span class="co">#&gt; (Intercept)    -2.2588 0.1023 -2.4597 -2.0543 0.0000 1.0019</span></span>
<span><span class="co">#&gt; sexfemale      -0.0300 0.1433 -0.3120  0.2483 0.8382 1.0011</span></span>
<span><span class="co">#&gt; time            0.3344 0.0698  0.1989  0.4710 0.0000 1.0001</span></span>
<span><span class="co">#&gt; sexfemale:time -0.1175 0.0983 -0.3082  0.0732 0.2260 1.0011</span></span>
<span><span class="co">#&gt; sigma           0.4947 0.0138  0.4690  0.5227 0.0000 1.0028</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; MCMC summary:</span></span>
<span><span class="co">#&gt; chains: 3 </span></span>
<span><span class="co">#&gt; iterations per chain: 3500 </span></span>
<span><span class="co">#&gt; burn-in per chain: 500 </span></span>
<span><span class="co">#&gt; thinning: 1 </span></span>
<span><span class="co">#&gt; time: 14 sec</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="studentss-t-mixed-models">Students’s-t mixed models<a class="anchor" aria-label="anchor" href="#studentss-t-mixed-models"></a>
</h3>
<p>Outlying observations are a common issue in practice. Several methods
have been proposed in the literature for identifying such observations
in the context of longitudinal data. However, removing such values from
the analysis is generally not recommended unless we also have external
information as to why these values are outlying. Hence, we would need to
fit mixed models to accommodate these observations in these settings. A
well-known approach to achieve this is replacing the normal distribution
for the error terms in the linear mixed model with a Student’s-t
distribution with heavier tails.</p>
<p>The following syntax simulates data from a joint model with a
Student’s-t mixed effects model:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1234</span><span class="op">)</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">200</span> <span class="co"># number of subjects</span></span>
<span><span class="va">K</span> <span class="op">&lt;-</span> <span class="fl">12</span> <span class="co"># number of measurements per subject</span></span>
<span><span class="va">t_max</span> <span class="op">&lt;-</span> <span class="fl">14</span> <span class="co"># maximum follow-up time</span></span>
<span></span>
<span><span class="co"># we construct a data frame with the design:</span></span>
<span><span class="co"># everyone has a baseline measurement, and then measurements at random </span></span>
<span><span class="co"># follow-up times up to t_max</span></span>
<span><span class="va">DF</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>, each <span class="op">=</span> <span class="va">K</span><span class="op">)</span>,</span>
<span>                 time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">replicate</a></span><span class="op">(</span><span class="va">n</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">K</span> <span class="op">-</span> <span class="fl">1</span>, <span class="fl">0</span>, <span class="va">t_max</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                 sex <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/gl.html" class="external-link">gl</a></span><span class="op">(</span><span class="fl">2</span>, <span class="va">n</span><span class="op">/</span><span class="fl">2</span>, labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"male"</span>, <span class="st">"female"</span><span class="op">)</span><span class="op">)</span>, each <span class="op">=</span> <span class="va">K</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># design matrices for the fixed and random effects</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/methods.html">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="va">sex</span> <span class="op">*</span> <span class="va">time</span>, data <span class="op">=</span> <span class="va">DF</span><span class="op">)</span></span>
<span><span class="va">Z</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/methods.html">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="va">time</span>, data <span class="op">=</span> <span class="va">DF</span><span class="op">)</span></span>
<span></span>
<span><span class="va">betas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2.2</span>, <span class="op">-</span><span class="fl">0.25</span>, <span class="fl">0.24</span>, <span class="op">-</span><span class="fl">0.05</span><span class="op">)</span> <span class="co"># fixed effects coefficients</span></span>
<span><span class="va">sigma</span> <span class="op">&lt;-</span> <span class="fl">0.5</span> <span class="co"># error standard deviation</span></span>
<span><span class="va">D11</span> <span class="op">&lt;-</span> <span class="fl">1.0</span> <span class="co"># variance of random intercepts</span></span>
<span><span class="va">D22</span> <span class="op">&lt;-</span> <span class="fl">0.5</span> <span class="co"># variance of random slopes</span></span>
<span></span>
<span><span class="co"># we simulate random effects</span></span>
<span><span class="va">b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span>, sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">D11</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span>, sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">D22</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># linear predictor</span></span>
<span><span class="va">eta_y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">X</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">betas</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">Z</span> <span class="op">*</span> <span class="va">b</span><span class="op">[</span><span class="va">DF</span><span class="op">$</span><span class="va">id</span>, <span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># we simulate Student's-t longitudinal data</span></span>
<span><span class="va">DF</span><span class="op">$</span><span class="va">y</span> <span class="op">&lt;-</span> <span class="va">eta_y</span> <span class="op">+</span> <span class="va">sigma</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/TDist.html" class="external-link">rt</a></span><span class="op">(</span><span class="va">n</span> <span class="op">*</span> <span class="va">K</span>, df <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span></span>
<span><span class="va">upp_Cens</span> <span class="op">&lt;-</span> <span class="fl">15</span> <span class="co"># fixed Type I censoring time</span></span>
<span><span class="va">shape_wb</span> <span class="op">&lt;-</span> <span class="fl">5</span> <span class="co"># shape Weibull</span></span>
<span><span class="va">alpha</span> <span class="op">&lt;-</span> <span class="fl">0.8</span> <span class="co"># association coefficients</span></span>
<span><span class="va">gammas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"(Intercept)"</span> <span class="op">=</span> <span class="op">-</span><span class="fl">9</span>, <span class="st">"sex"</span> <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span><span class="va">W</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/methods.html">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="va">sex</span>, data <span class="op">=</span> <span class="va">DF</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/duplicated.html" class="external-link">duplicated</a></span><span class="op">(</span><span class="va">DF</span><span class="op">$</span><span class="va">id</span><span class="op">)</span>, <span class="op">]</span><span class="op">)</span></span>
<span><span class="co"># linear predictor for the survival model</span></span>
<span><span class="va">eta_t</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">W</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">gammas</span><span class="op">)</span></span>
<span><span class="co"># to simulate event times we use inverse transform sampling</span></span>
<span><span class="co"># (https://en.wikipedia.org/wiki/Inverse_transform_sampling). Namely, we want </span></span>
<span><span class="co"># to find t, such that S(t) = u, where S(.) is the survival function, and u a </span></span>
<span><span class="co"># number from the Unif(0, 1) distribution. The function below calculates </span></span>
<span><span class="co"># log(u) - log(S(t)), and for a given u, we want to find t for which it equals</span></span>
<span><span class="co"># zero. We do that below using the uniroot() function</span></span>
<span><span class="va">invS</span> <span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="va">t</span>, <span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># i denotes the subject</span></span>
<span>  <span class="va">sex_i</span> <span class="op">&lt;-</span> <span class="va">W</span><span class="op">[</span><span class="va">i</span>, <span class="fl">2L</span><span class="op">]</span></span>
<span>  <span class="co"># h() is the hazard function and we assume a Weibull baseline hazard</span></span>
<span>  <span class="va">h</span> <span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="va">s</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">X_at_s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">sex_i</span>, <span class="va">s</span>, <span class="va">sex_i</span> <span class="op">*</span> <span class="va">s</span><span class="op">)</span></span>
<span>    <span class="va">Z_at_s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">s</span><span class="op">)</span></span>
<span>    <span class="co"># the linear predictor from the mixed model evaluated at time s</span></span>
<span>    <span class="va">f</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">X_at_s</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">betas</span> <span class="op">+</span></span>
<span>                     <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">Z_at_s</span> <span class="op">*</span> <span class="va">b</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">i</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">Z_at_s</span><span class="op">)</span><span class="op">)</span>, <span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">shape_wb</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="va">shape_wb</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">s</span><span class="op">)</span> <span class="op">+</span> <span class="va">eta_t</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">+</span> <span class="va">f</span> <span class="op">*</span> <span class="va">alpha</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="co"># -log(S(t)) = H(t), where H(t) is the cumulative hazard function</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/integrate.html" class="external-link">integrate</a></span><span class="op">(</span><span class="va">h</span>, lower <span class="op">=</span> <span class="fl">0</span>, upper <span class="op">=</span> <span class="va">t</span><span class="op">)</span><span class="op">$</span><span class="va">value</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">u</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co"># we simulate the event times</span></span>
<span><span class="va">u</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="va">trueTimes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">Up</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span>    <span class="va">Root</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/try.html" class="external-link">try</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/uniroot.html" class="external-link">uniroot</a></span><span class="op">(</span><span class="va">invS</span>, interval <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1e-05</span>, <span class="va">Up</span><span class="op">)</span>, i <span class="op">=</span> <span class="va">i</span><span class="op">)</span><span class="op">$</span><span class="va">root</span>, <span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="va">trueTimes</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">inherits</a></span><span class="op">(</span><span class="va">Root</span>, <span class="st">"try-error"</span><span class="op">)</span><span class="op">)</span> <span class="va">Root</span> <span class="kw">else</span> <span class="fl">150</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># we use fixed Type I right censoring denoting the end of the trial.</span></span>
<span><span class="va">Ctimes</span> <span class="op">&lt;-</span> <span class="va">upp_Cens</span></span>
<span><span class="va">Time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmin</a></span><span class="op">(</span><span class="va">trueTimes</span>, <span class="va">Ctimes</span><span class="op">)</span></span>
<span><span class="va">event</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">trueTimes</span> <span class="op">&lt;=</span> <span class="va">Ctimes</span><span class="op">)</span> <span class="co"># event indicator</span></span>
<span></span>
<span><span class="co"># we keep the longitudinal measurements before the event times</span></span>
<span><span class="va">DF</span><span class="op">$</span><span class="va">Time</span> <span class="op">&lt;-</span> <span class="va">Time</span><span class="op">[</span><span class="va">DF</span><span class="op">$</span><span class="va">id</span><span class="op">]</span></span>
<span><span class="va">DF</span><span class="op">$</span><span class="va">event</span> <span class="op">&lt;-</span> <span class="va">event</span><span class="op">[</span><span class="va">DF</span><span class="op">$</span><span class="va">id</span><span class="op">]</span></span>
<span><span class="va">DF</span> <span class="op">&lt;-</span> <span class="va">DF</span><span class="op">[</span><span class="va">DF</span><span class="op">$</span><span class="va">time</span> <span class="op">&lt;=</span> <span class="va">DF</span><span class="op">$</span><span class="va">Time</span>, <span class="op">]</span></span></code></pre></div>
<p>To fit the corresponding joint model we use the
<code><a href="https://drizopoulos.github.io/GLMMadaptive/reference/extra_fams.html" class="external-link">students.t()</a></code> family object in the call to
<code><a href="https://drizopoulos.github.io/GLMMadaptive/reference/mixed_model.html" class="external-link">mixed_model()</a></code>:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">DF_id</span> <span class="op">&lt;-</span> <span class="va">DF</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/duplicated.html" class="external-link">duplicated</a></span><span class="op">(</span><span class="va">DF</span><span class="op">$</span><span class="va">id</span><span class="op">)</span>, <span class="op">]</span></span>
<span><span class="va">Cox_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html" class="external-link">coxph</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">Time</span>, <span class="va">event</span><span class="op">)</span> <span class="op">~</span> <span class="va">sex</span>, data <span class="op">=</span> <span class="va">DF_id</span><span class="op">)</span></span>
<span><span class="va">Stdt_MixMod</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="https://drizopoulos.github.io/GLMMadaptive/reference/mixed_model.html" class="external-link">mixed_model</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">sex</span> <span class="op">*</span> <span class="va">time</span>, random <span class="op">=</span> <span class="op">~</span> <span class="va">time</span> <span class="op">|</span> <span class="va">id</span>, data <span class="op">=</span> <span class="va">DF</span>,</span>
<span>                family <span class="op">=</span> <span class="fu"><a href="https://drizopoulos.github.io/GLMMadaptive/reference/extra_fams.html" class="external-link">students.t</a></span><span class="op">(</span>df <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">jointFit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/jm.html">jm</a></span><span class="op">(</span><span class="va">Cox_fit</span>, <span class="va">Stdt_MixMod</span>, time_var <span class="op">=</span> <span class="st">"time"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">jointFit</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; jm(Surv_object = Cox_fit, Mixed_objects = Stdt_MixMod, time_var = "time")</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Data Descriptives:</span></span>
<span><span class="co">#&gt; Number of Groups: 200        Number of events: 165 (82.5%)</span></span>
<span><span class="co">#&gt; Number of Observations:</span></span>
<span><span class="co">#&gt;   y: 1347</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                  DIC     WAIC      LPML</span></span>
<span><span class="co">#&gt; marginal    5197.868 6842.793 -3988.557</span></span>
<span><span class="co">#&gt; conditional 4447.164 4349.718 -2333.522</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Random-effects covariance matrix:</span></span>
<span><span class="co">#&gt;                     </span></span>
<span><span class="co">#&gt;        StdDev   Corr</span></span>
<span><span class="co">#&gt; (Intr) 0.9791 (Intr)</span></span>
<span><span class="co">#&gt; time   0.6749 0.1175</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Survival Outcome:</span></span>
<span><span class="co">#&gt;             Mean  StDev    2.5%  97.5%     P   Rhat</span></span>
<span><span class="co">#&gt; sexfemale 0.0207 0.2538 -0.4730 0.5131 0.932 1.0012</span></span>
<span><span class="co">#&gt; value(y)  0.8350 0.0647  0.7152 0.9658 0.000 1.0569</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Longitudinal Outcome: y (family = Student's-t, link = identity)</span></span>
<span><span class="co">#&gt;                   Mean  StDev    2.5%   97.5%      P   Rhat</span></span>
<span><span class="co">#&gt; (Intercept)    -2.2485 0.1083 -2.4626 -2.0334 0.0000 1.0038</span></span>
<span><span class="co">#&gt; sexfemale      -0.1212 0.1513 -0.4205  0.1691 0.4267 1.0005</span></span>
<span><span class="co">#&gt; time            0.2828 0.0710  0.1455  0.4235 0.0000 1.0007</span></span>
<span><span class="co">#&gt; sexfemale:time -0.0335 0.0993 -0.2263  0.1598 0.7318 1.0007</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; MCMC summary:</span></span>
<span><span class="co">#&gt; chains: 3 </span></span>
<span><span class="co">#&gt; iterations per chain: 3500 </span></span>
<span><span class="co">#&gt; burn-in per chain: 500 </span></span>
<span><span class="co">#&gt; thinning: 1 </span></span>
<span><span class="co">#&gt; time: 15 sec</span></span></code></pre></div>
<div align="right">
<a href="#top">Back to top</a>
</div>
</div>
<div class="section level3">
<h3 id="negative-binomial-mixed-models">Negative binomial mixed models<a class="anchor" aria-label="anchor" href="#negative-binomial-mixed-models"></a>
</h3>
<p>Count longitudinal outcomes are typically modeled with the Poisson
distribution. However, these outcomes often exhibit more variance than
what is allowed from the Poisson distribution, leading to the well-known
problem of over-dispersion. To accommodate this over-dispersion,
typically, the negative binomial distribution is used.</p>
<p>The following piece of code simulates data from a joint model for
count longitudinal data that follow the negative binomial
distribution:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1234</span><span class="op">)</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">500</span> <span class="co"># number of subjects</span></span>
<span><span class="va">K</span> <span class="op">&lt;-</span> <span class="fl">10</span> <span class="co"># number of measurements per subject</span></span>
<span><span class="va">t_max</span> <span class="op">&lt;-</span> <span class="fl">5</span> <span class="co"># maximum follow-up time</span></span>
<span></span>
<span><span class="co"># we construct a data frame with the design:</span></span>
<span><span class="co"># everyone has a baseline measurement, and then measurements at random </span></span>
<span><span class="co"># follow-up times up to t_max</span></span>
<span><span class="va">DF</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>, each <span class="op">=</span> <span class="va">K</span><span class="op">)</span>,</span>
<span>                 time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">replicate</a></span><span class="op">(</span><span class="va">n</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">K</span> <span class="op">-</span> <span class="fl">1</span>, <span class="fl">0</span>, <span class="va">t_max</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                 sex <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/gl.html" class="external-link">gl</a></span><span class="op">(</span><span class="fl">2</span>, <span class="va">n</span><span class="op">/</span><span class="fl">2</span>, labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"male"</span>, <span class="st">"female"</span><span class="op">)</span><span class="op">)</span>, each <span class="op">=</span> <span class="va">K</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># design matrices for the fixed and random effects</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/methods.html">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="va">sex</span> <span class="op">*</span> <span class="va">time</span>, data <span class="op">=</span> <span class="va">DF</span><span class="op">)</span></span>
<span><span class="va">Z</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/methods.html">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="va">time</span>, data <span class="op">=</span> <span class="va">DF</span><span class="op">)</span></span>
<span></span>
<span><span class="va">betas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.8</span>, <span class="op">-</span><span class="fl">0.5</span>, <span class="fl">0.8</span>, <span class="op">-</span><span class="fl">0.5</span><span class="op">)</span> <span class="co"># fixed effects coefficients</span></span>
<span><span class="va">shape</span> <span class="op">&lt;-</span> <span class="fl">2</span> <span class="co"># shape/size parameter of the negative binomial distribution</span></span>
<span><span class="va">D11</span> <span class="op">&lt;-</span> <span class="fl">1.0</span> <span class="co"># variance of random intercepts</span></span>
<span><span class="va">D22</span> <span class="op">&lt;-</span> <span class="fl">0.3</span> <span class="co"># variance of random slopes</span></span>
<span></span>
<span><span class="co"># we simulate random effects</span></span>
<span><span class="va">b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span>, sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">D11</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span>, sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">D22</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># linear predictor</span></span>
<span><span class="va">eta_y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">X</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">betas</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">Z</span> <span class="op">*</span> <span class="va">b</span><span class="op">[</span><span class="va">DF</span><span class="op">$</span><span class="va">id</span>, <span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># mean of the Beta distribution</span></span>
<span><span class="va">mu_y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Logistic.html" class="external-link">plogis</a></span><span class="op">(</span><span class="va">eta_y</span><span class="op">)</span> <span class="co"># plogis(eta_y) = exp(eta_y) / (1 + exp(eta_y))</span></span>
<span><span class="co"># we simulate negative binomial longitudinal data</span></span>
<span><span class="va">DF</span><span class="op">$</span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/NegBinomial.html" class="external-link">rnbinom</a></span><span class="op">(</span><span class="va">n</span> <span class="op">*</span> <span class="va">K</span>, size <span class="op">=</span> <span class="va">shape</span>, mu <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">eta_y</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># simulate event times</span></span>
<span><span class="va">upp_Cens</span> <span class="op">&lt;-</span> <span class="fl">5</span> <span class="co"># fixed Type I censoring time</span></span>
<span><span class="va">shape_wb</span> <span class="op">&lt;-</span> <span class="fl">5</span> <span class="co"># shape Weibull</span></span>
<span><span class="va">alpha</span> <span class="op">&lt;-</span> <span class="fl">0.8</span> <span class="co"># association coefficient</span></span>
<span><span class="va">gammas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"(Intercept)"</span> <span class="op">=</span> <span class="op">-</span><span class="fl">9</span>, <span class="st">"sex"</span> <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span><span class="va">W</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/methods.html">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="va">sex</span>, data <span class="op">=</span> <span class="va">DF</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/duplicated.html" class="external-link">duplicated</a></span><span class="op">(</span><span class="va">DF</span><span class="op">$</span><span class="va">id</span><span class="op">)</span>, <span class="op">]</span><span class="op">)</span></span>
<span><span class="co"># linear predictor for the survival model</span></span>
<span><span class="va">eta_t</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">W</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">gammas</span><span class="op">)</span></span>
<span><span class="co"># to simulate event times we use inverse transform sampling</span></span>
<span><span class="co"># (https://en.wikipedia.org/wiki/Inverse_transform_sampling). Namely, we want </span></span>
<span><span class="co"># to find t, such that S(t) = u, where S(.) is the survival function, and u a </span></span>
<span><span class="co"># number from the Unif(0, 1) distribution. The function below calculates </span></span>
<span><span class="co"># log(u) - log(S(t)), and for a given u, we want to find t for which it equals</span></span>
<span><span class="co"># zero. We do that below using the uniroot() function</span></span>
<span><span class="va">invS</span> <span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="va">t</span>, <span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># i denotes the subject</span></span>
<span>  <span class="va">sex_i</span> <span class="op">&lt;-</span> <span class="va">W</span><span class="op">[</span><span class="va">i</span>, <span class="fl">2L</span><span class="op">]</span></span>
<span>  <span class="co"># h() is the hazard function and we assume a Weibull baseline hazard</span></span>
<span>  <span class="va">h</span> <span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="va">s</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">X_at_s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">sex_i</span>, <span class="va">s</span>, <span class="va">sex_i</span> <span class="op">*</span> <span class="va">s</span><span class="op">)</span></span>
<span>    <span class="va">Z_at_s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">s</span><span class="op">)</span></span>
<span>    <span class="co"># the linear predictor from the mixed model evaluated at time s</span></span>
<span>    <span class="va">f</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">X_at_s</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">betas</span> <span class="op">+</span></span>
<span>                     <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">Z_at_s</span> <span class="op">*</span> <span class="va">b</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">i</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">Z_at_s</span><span class="op">)</span><span class="op">)</span>, <span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">shape_wb</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="va">shape_wb</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">s</span><span class="op">)</span> <span class="op">+</span> <span class="va">eta_t</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">+</span> <span class="va">f</span> <span class="op">*</span> <span class="va">alpha</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="co"># -log(S(t)) = H(t), where H(t) is the cumulative hazard function</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/integrate.html" class="external-link">integrate</a></span><span class="op">(</span><span class="va">h</span>, lower <span class="op">=</span> <span class="fl">0</span>, upper <span class="op">=</span> <span class="va">t</span><span class="op">)</span><span class="op">$</span><span class="va">value</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">u</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co"># we simulate the event times</span></span>
<span><span class="va">u</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="va">trueTimes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">Up</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span>    <span class="va">Root</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/try.html" class="external-link">try</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/uniroot.html" class="external-link">uniroot</a></span><span class="op">(</span><span class="va">invS</span>, interval <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1e-05</span>, <span class="va">Up</span><span class="op">)</span>, i <span class="op">=</span> <span class="va">i</span><span class="op">)</span><span class="op">$</span><span class="va">root</span>, <span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="va">trueTimes</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">inherits</a></span><span class="op">(</span><span class="va">Root</span>, <span class="st">"try-error"</span><span class="op">)</span><span class="op">)</span> <span class="va">Root</span> <span class="kw">else</span> <span class="fl">150</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># we use fixed Type I right censoring denoting the end of the trial.</span></span>
<span><span class="va">Ctimes</span> <span class="op">&lt;-</span> <span class="va">upp_Cens</span></span>
<span><span class="va">Time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmin</a></span><span class="op">(</span><span class="va">trueTimes</span>, <span class="va">Ctimes</span><span class="op">)</span></span>
<span><span class="va">event</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">trueTimes</span> <span class="op">&lt;=</span> <span class="va">Ctimes</span><span class="op">)</span> <span class="co"># event indicator</span></span>
<span></span>
<span><span class="co"># we keep the longitudinal measurements before the event times</span></span>
<span><span class="va">DF</span><span class="op">$</span><span class="va">Time</span> <span class="op">&lt;-</span> <span class="va">Time</span><span class="op">[</span><span class="va">DF</span><span class="op">$</span><span class="va">id</span><span class="op">]</span></span>
<span><span class="va">DF</span><span class="op">$</span><span class="va">event</span> <span class="op">&lt;-</span> <span class="va">event</span><span class="op">[</span><span class="va">DF</span><span class="op">$</span><span class="va">id</span><span class="op">]</span></span>
<span><span class="va">DF</span> <span class="op">&lt;-</span> <span class="va">DF</span><span class="op">[</span><span class="va">DF</span><span class="op">$</span><span class="va">time</span> <span class="op">&lt;=</span> <span class="va">DF</span><span class="op">$</span><span class="va">Time</span>, <span class="op">]</span></span></code></pre></div>
<p>The corresponding joint model is the fitted using the following
syntax:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">DF_id</span> <span class="op">&lt;-</span> <span class="va">DF</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/duplicated.html" class="external-link">duplicated</a></span><span class="op">(</span><span class="va">DF</span><span class="op">$</span><span class="va">id</span><span class="op">)</span>, <span class="op">]</span></span>
<span><span class="va">Cox_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html" class="external-link">coxph</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">Time</span>, <span class="va">event</span><span class="op">)</span> <span class="op">~</span> <span class="va">sex</span>, data <span class="op">=</span> <span class="va">DF_id</span><span class="op">)</span></span>
<span><span class="va">NB_MixMod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://drizopoulos.github.io/GLMMadaptive/reference/mixed_model.html" class="external-link">mixed_model</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">sex</span> <span class="op">*</span> <span class="va">time</span>, random <span class="op">=</span> <span class="op">~</span> <span class="va">time</span> <span class="op">|</span> <span class="va">id</span>, data <span class="op">=</span> <span class="va">DF</span>,</span>
<span>                         family <span class="op">=</span> <span class="fu"><a href="https://drizopoulos.github.io/GLMMadaptive/reference/negative_binomial.html" class="external-link">negative.binomial</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">jointFit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/jm.html">jm</a></span><span class="op">(</span><span class="va">Cox_fit</span>, <span class="va">NB_MixMod</span>, time_var <span class="op">=</span> <span class="st">"time"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">jointFit</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; jm(Surv_object = Cox_fit, Mixed_objects = NB_MixMod, time_var = "time")</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Data Descriptives:</span></span>
<span><span class="co">#&gt; Number of Groups: 500        Number of events: 409 (81.8%)</span></span>
<span><span class="co">#&gt; Number of Observations:</span></span>
<span><span class="co">#&gt;   y: 3842</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                  DIC     WAIC      LPML</span></span>
<span><span class="co">#&gt; marginal    21347.40 21300.55 -10650.44</span></span>
<span><span class="co">#&gt; conditional 22639.19 22350.27 -11565.82</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Random-effects covariance matrix:</span></span>
<span><span class="co">#&gt;                      </span></span>
<span><span class="co">#&gt;        StdDev   Corr </span></span>
<span><span class="co">#&gt; (Intr) 1.0401 (Intr) </span></span>
<span><span class="co">#&gt; time   0.5382 -0.0551</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Survival Outcome:</span></span>
<span><span class="co">#&gt;             Mean  StDev   2.5%  97.5% P   Rhat</span></span>
<span><span class="co">#&gt; sexfemale 0.6141 0.1608 0.2967 0.9385 0 1.0126</span></span>
<span><span class="co">#&gt; value(y)  0.8114 0.0536 0.7136 0.9274 0 1.0458</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Longitudinal Outcome: y (family = negative binomial, link = log)</span></span>
<span><span class="co">#&gt;                   Mean  StDev    2.5%   97.5% P   Rhat</span></span>
<span><span class="co">#&gt; (Intercept)     0.8422 0.0791  0.6852  0.9952 0 1.0116</span></span>
<span><span class="co">#&gt; sexfemale      -0.5812 0.1143 -0.8014 -0.3573 0 1.0035</span></span>
<span><span class="co">#&gt; time            0.8617 0.0415  0.7813  0.9427 0 1.0053</span></span>
<span><span class="co">#&gt; sexfemale:time -0.5161 0.0591 -0.6298 -0.3989 0 1.0010</span></span>
<span><span class="co">#&gt; sigma           1.9921 0.0848  1.8281  2.1608 0 1.0027</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; MCMC summary:</span></span>
<span><span class="co">#&gt; chains: 3 </span></span>
<span><span class="co">#&gt; iterations per chain: 3500 </span></span>
<span><span class="co">#&gt; burn-in per chain: 500 </span></span>
<span><span class="co">#&gt; thinning: 1 </span></span>
<span><span class="co">#&gt; time: 26 sec</span></span></code></pre></div>
<div align="right">
<a href="#top">Back to top</a>
</div>
</div>
<div class="section level3">
<h3 id="beta-binomial-longitudinal-outcomes">Beta-binomial longitudinal outcomes<a class="anchor" aria-label="anchor" href="#beta-binomial-longitudinal-outcomes"></a>
</h3>
<p>For count data and binomial data, we may have an over-dispersion
problem. To accommodate this, we can change the standard binomial
distribution to a beta-binomial one.</p>
<p>The following piece of code simulates data from a joint model for
binomial longitudinal data that follow the beta-binomial
distribution:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1234</span><span class="op">)</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">500</span> <span class="co"># number of subjects</span></span>
<span><span class="va">K</span> <span class="op">&lt;-</span> <span class="fl">8</span> <span class="co"># number of measurements per subject</span></span>
<span><span class="va">t_max</span> <span class="op">&lt;-</span> <span class="fl">10</span> <span class="co"># maximum follow-up time</span></span>
<span></span>
<span><span class="co"># we construct a data frame with the design:</span></span>
<span><span class="co"># everyone has a baseline measurement, and then measurements at random </span></span>
<span><span class="co"># follow-up times up to t_max</span></span>
<span><span class="va">DF</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>, each <span class="op">=</span> <span class="va">K</span><span class="op">)</span>,</span>
<span>                 time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">replicate</a></span><span class="op">(</span><span class="va">n</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">K</span> <span class="op">-</span> <span class="fl">1</span>, <span class="fl">0</span>, <span class="va">t_max</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                 sex <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/gl.html" class="external-link">gl</a></span><span class="op">(</span><span class="fl">2</span>, <span class="va">n</span><span class="op">/</span><span class="fl">2</span>, labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"male"</span>, <span class="st">"female"</span><span class="op">)</span><span class="op">)</span>, each <span class="op">=</span> <span class="va">K</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># design matrices for the fixed and random effects</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/methods.html">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="va">sex</span> <span class="op">*</span> <span class="va">time</span>, data <span class="op">=</span> <span class="va">DF</span><span class="op">)</span></span>
<span><span class="va">Z</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/methods.html">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="va">time</span>, data <span class="op">=</span> <span class="va">DF</span><span class="op">)</span></span>
<span></span>
<span><span class="va">betas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2.2</span>, <span class="op">-</span><span class="fl">0.25</span>, <span class="fl">0.24</span>, <span class="op">-</span><span class="fl">0.05</span><span class="op">)</span> <span class="co"># fixed effects coefficients</span></span>
<span><span class="va">phi</span> <span class="op">&lt;-</span> <span class="fl">5</span> <span class="co"># precision parameter of the Beta distribution</span></span>
<span><span class="va">D11</span> <span class="op">&lt;-</span> <span class="fl">1.0</span> <span class="co"># variance of random intercepts</span></span>
<span><span class="va">D22</span> <span class="op">&lt;-</span> <span class="fl">0.5</span> <span class="co"># variance of random slopes</span></span>
<span></span>
<span><span class="co"># we simulate random effects</span></span>
<span><span class="va">b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span>, sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">D11</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span>, sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">D22</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># linear predictor</span></span>
<span><span class="va">eta_y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">X</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">betas</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">Z</span> <span class="op">*</span> <span class="va">b</span><span class="op">[</span><span class="va">DF</span><span class="op">$</span><span class="va">id</span>, <span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># mean of the Beta distribution</span></span>
<span><span class="va">mu_y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Logistic.html" class="external-link">plogis</a></span><span class="op">(</span><span class="va">eta_y</span><span class="op">)</span> <span class="co"># plogis(eta_y) = exp(eta_y) / (1 + exp(eta_y))</span></span>
<span><span class="co"># we simulate probabilities from the Beta distribution</span></span>
<span><span class="va">probs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Beta.html" class="external-link">rbeta</a></span><span class="op">(</span><span class="va">n</span> <span class="op">*</span> <span class="va">K</span>, shape1 <span class="op">=</span> <span class="va">mu_y</span> <span class="op">*</span> <span class="va">phi</span>, shape2 <span class="op">=</span> <span class="va">phi</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">mu_y</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># we transform to (0, 1)</span></span>
<span><span class="va">probs</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">probs</span> <span class="op">*</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">DF</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">DF</span><span class="op">)</span></span>
<span><span class="co"># we simulate binomial data use the probs</span></span>
<span><span class="va">DF</span><span class="op">$</span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="va">n</span> <span class="op">*</span> <span class="va">K</span>, size <span class="op">=</span> <span class="fl">20</span>, prob <span class="op">=</span> <span class="va">probs</span><span class="op">)</span></span>
<span></span>
<span><span class="va">upp_Cens</span> <span class="op">&lt;-</span> <span class="fl">15</span> <span class="co"># fixed Type I censoring time</span></span>
<span><span class="va">shape_wb</span> <span class="op">&lt;-</span> <span class="fl">5</span> <span class="co"># shape Weibull</span></span>
<span><span class="va">alpha</span> <span class="op">&lt;-</span> <span class="fl">0.8</span> <span class="co"># association coefficients</span></span>
<span><span class="va">gammas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"(Intercept)"</span> <span class="op">=</span> <span class="op">-</span><span class="fl">9</span>, <span class="st">"sex"</span> <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span><span class="va">W</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/methods.html">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="va">sex</span>, data <span class="op">=</span> <span class="va">DF</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/duplicated.html" class="external-link">duplicated</a></span><span class="op">(</span><span class="va">DF</span><span class="op">$</span><span class="va">id</span><span class="op">)</span>, <span class="op">]</span><span class="op">)</span></span>
<span><span class="co"># linear predictor for the survival model</span></span>
<span><span class="va">eta_t</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">W</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">gammas</span><span class="op">)</span></span>
<span><span class="co"># to simulate event times we use inverse transform sampling</span></span>
<span><span class="co"># (https://en.wikipedia.org/wiki/Inverse_transform_sampling). Namely, we want </span></span>
<span><span class="co"># to find t, such that S(t) = u, where S(.) is the survival function, and u a </span></span>
<span><span class="co"># number from the Unif(0, 1) distribution. The function below calculates </span></span>
<span><span class="co"># log(u) - log(S(t)), and for a given u, we want to find t for which it equals</span></span>
<span><span class="co"># zero. We do that below using the uniroot() function</span></span>
<span><span class="va">invS</span> <span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="va">t</span>, <span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># i denotes the subject</span></span>
<span>  <span class="va">sex_i</span> <span class="op">&lt;-</span> <span class="va">W</span><span class="op">[</span><span class="va">i</span>, <span class="fl">2L</span><span class="op">]</span></span>
<span>  <span class="co"># h() is the hazard function and we assume a Weibull baseline hazard</span></span>
<span>  <span class="va">h</span> <span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="va">s</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">X_at_s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">sex_i</span>, <span class="va">s</span>, <span class="va">sex_i</span> <span class="op">*</span> <span class="va">s</span><span class="op">)</span></span>
<span>    <span class="va">Z_at_s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">s</span><span class="op">)</span></span>
<span>    <span class="co"># the linear predictor from the mixed model evaluated at time s</span></span>
<span>    <span class="va">f</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">X_at_s</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">betas</span> <span class="op">+</span></span>
<span>                     <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">Z_at_s</span> <span class="op">*</span> <span class="va">b</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">i</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">Z_at_s</span><span class="op">)</span><span class="op">)</span>, <span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">shape_wb</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="va">shape_wb</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">s</span><span class="op">)</span> <span class="op">+</span> <span class="va">eta_t</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">+</span> <span class="va">f</span> <span class="op">*</span> <span class="va">alpha</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="co"># -log(S(t)) = H(t), where H(t) is the cumulative hazard function</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/integrate.html" class="external-link">integrate</a></span><span class="op">(</span><span class="va">h</span>, lower <span class="op">=</span> <span class="fl">0</span>, upper <span class="op">=</span> <span class="va">t</span><span class="op">)</span><span class="op">$</span><span class="va">value</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">u</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co"># we simulate the event times</span></span>
<span><span class="va">u</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="va">trueTimes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">Up</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span>    <span class="va">Root</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/try.html" class="external-link">try</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/uniroot.html" class="external-link">uniroot</a></span><span class="op">(</span><span class="va">invS</span>, interval <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1e-05</span>, <span class="va">Up</span><span class="op">)</span>, i <span class="op">=</span> <span class="va">i</span><span class="op">)</span><span class="op">$</span><span class="va">root</span>, <span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="va">trueTimes</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">inherits</a></span><span class="op">(</span><span class="va">Root</span>, <span class="st">"try-error"</span><span class="op">)</span><span class="op">)</span> <span class="va">Root</span> <span class="kw">else</span> <span class="fl">150</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># we use fixed Type I right censoring denoting the end of the trial.</span></span>
<span><span class="va">Ctimes</span> <span class="op">&lt;-</span> <span class="va">upp_Cens</span></span>
<span><span class="va">Time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmin</a></span><span class="op">(</span><span class="va">trueTimes</span>, <span class="va">Ctimes</span><span class="op">)</span></span>
<span><span class="va">event</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">trueTimes</span> <span class="op">&lt;=</span> <span class="va">Ctimes</span><span class="op">)</span> <span class="co"># event indicator</span></span>
<span></span>
<span><span class="co"># we keep the longitudinal measurements before the event times</span></span>
<span><span class="va">DF</span><span class="op">$</span><span class="va">Time</span> <span class="op">&lt;-</span> <span class="va">Time</span><span class="op">[</span><span class="va">DF</span><span class="op">$</span><span class="va">id</span><span class="op">]</span></span>
<span><span class="va">DF</span><span class="op">$</span><span class="va">event</span> <span class="op">&lt;-</span> <span class="va">event</span><span class="op">[</span><span class="va">DF</span><span class="op">$</span><span class="va">id</span><span class="op">]</span></span>
<span><span class="va">DF</span> <span class="op">&lt;-</span> <span class="va">DF</span><span class="op">[</span><span class="va">DF</span><span class="op">$</span><span class="va">time</span> <span class="op">&lt;=</span> <span class="va">DF</span><span class="op">$</span><span class="va">Time</span>, <span class="op">]</span></span></code></pre></div>
<p>The corresponding joint model is then fitted with the syntax:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">DF_id</span> <span class="op">&lt;-</span> <span class="va">DF</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/duplicated.html" class="external-link">duplicated</a></span><span class="op">(</span><span class="va">DF</span><span class="op">$</span><span class="va">id</span><span class="op">)</span>, <span class="op">]</span></span>
<span><span class="va">Cox_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html" class="external-link">coxph</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">Time</span>, <span class="va">event</span><span class="op">)</span> <span class="op">~</span> <span class="va">sex</span>, data <span class="op">=</span> <span class="va">DF_id</span><span class="op">)</span></span>
<span><span class="va">BetaBinom_MixMod</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="https://drizopoulos.github.io/GLMMadaptive/reference/mixed_model.html" class="external-link">mixed_model</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">y</span>, <span class="fl">20</span> <span class="op">-</span> <span class="va">y</span><span class="op">)</span> <span class="op">~</span> <span class="va">sex</span> <span class="op">*</span> <span class="va">time</span>, random <span class="op">=</span> <span class="op">~</span> <span class="va">time</span> <span class="op">|</span> <span class="va">id</span>, data <span class="op">=</span> <span class="va">DF</span>,</span>
<span>                family <span class="op">=</span> <span class="fu"><a href="https://drizopoulos.github.io/GLMMadaptive/reference/extra_fams.html" class="external-link">beta.binomial</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">jointFit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/jm.html">jm</a></span><span class="op">(</span><span class="va">Cox_fit</span>, <span class="va">BetaBinom_MixMod</span>, time_var <span class="op">=</span> <span class="st">"time"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">jointFit</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; jm(Surv_object = Cox_fit, Mixed_objects = BetaBinom_MixMod, time_var = "time")</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Data Descriptives:</span></span>
<span><span class="co">#&gt; Number of Groups: 500        Number of events: 395 (79%)</span></span>
<span><span class="co">#&gt; Number of Observations:</span></span>
<span><span class="co">#&gt;   cbind(y, 20 - y): 2837</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                  DIC     WAIC      LPML</span></span>
<span><span class="co">#&gt; marginal    11921.66 11871.70 -5942.471</span></span>
<span><span class="co">#&gt; conditional 13491.02 13297.62 -7547.969</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Random-effects covariance matrix:</span></span>
<span><span class="co">#&gt;                      </span></span>
<span><span class="co">#&gt;        StdDev   Corr </span></span>
<span><span class="co">#&gt; (Intr) 1.0077 (Intr) </span></span>
<span><span class="co">#&gt; time   0.7146 -0.0045</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Survival Outcome:</span></span>
<span><span class="co">#&gt;                           Mean  StDev   2.5%  97.5%      P   Rhat</span></span>
<span><span class="co">#&gt; sexfemale               0.5800 0.1952 0.2149 0.9642 0.0036 1.0050</span></span>
<span><span class="co">#&gt; value(cbind(y, 20 - y)) 0.9346 0.0598 0.8248 1.0519 0.0000 1.0299</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Longitudinal Outcome: cbind(y, 20 - y) (family = beta binomial, link = logit)</span></span>
<span><span class="co">#&gt;                   Mean  StDev    2.5%   97.5%      P   Rhat</span></span>
<span><span class="co">#&gt; (Intercept)    -2.1593 0.0940 -2.3486 -1.9754 0.0000 1.0194</span></span>
<span><span class="co">#&gt; sexfemale      -0.2722 0.1310 -0.5360 -0.0178 0.0336 1.0087</span></span>
<span><span class="co">#&gt; time            0.3316 0.0522  0.2299  0.4334 0.0000 1.0039</span></span>
<span><span class="co">#&gt; sexfemale:time -0.1798 0.0749 -0.3276 -0.0368 0.0142 1.0007</span></span>
<span><span class="co">#&gt; sigma           4.8145 0.2810  4.2778  5.3776 0.0000 1.0262</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; MCMC summary:</span></span>
<span><span class="co">#&gt; chains: 3 </span></span>
<span><span class="co">#&gt; iterations per chain: 3500 </span></span>
<span><span class="co">#&gt; burn-in per chain: 500 </span></span>
<span><span class="co">#&gt; thinning: 1 </span></span>
<span><span class="co">#&gt; time: 50 sec</span></span></code></pre></div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://www.drizopoulos.com/" class="external-link">Dimitris Rizopoulos</a>, <a href="https://pafonso.com/" class="external-link">Pedro Miranda Afonso</a>, <a href="https://gregpapageorgiou.com/" class="external-link">Grigorios Papageorgiou</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
