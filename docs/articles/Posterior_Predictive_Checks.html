<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Posterior Predictive Checks • JMbayes2</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<!-- katex math --><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" integrity="sha384-nB0miv6/jRmo5UMMR1wu3Gz6NLsoTkbqJghGIsx//Rlm+ZU03BU6SQNC66uf4l5+" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js" integrity="sha384-7zkQWkzuo3B5mTepMUcHkMB5jZaolc2xDwL6VFqjFALcbeS9Ggm/Yr2r3Dy4lfFg" crossorigin="anonymous"></script><script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js" integrity="sha384-43gviWU0YVjaDtb/GhzOouOXtZMP/7XUzwPTstBeZFe/+rCMvRwr4yROQP43s0Xk" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script><script src="../katex-auto.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Posterior Predictive Checks">
<meta name="robots" content="noindex">
<!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-YDBZ5DBBSP"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-YDBZ5DBBSP');
</script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">JMbayes2</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.6-0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/JMbayes2.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/Baseline_Hazard.html">Baseline Hazard Function</a></li>
    <li><a class="dropdown-item" href="../articles/Causal_Effects.html">Causal Effects</a></li>
    <li><a class="dropdown-item" href="../articles/Competing_Risks.html">Competing Risks</a></li>
    <li><a class="dropdown-item" href="../articles/Consensus.html">Fitting Joint Models to Big Datasets with Consensus Monte Carlo</a></li>
    <li><a class="dropdown-item" href="../articles/Dynamic_Predictions.html">Dynamic Predictions</a></li>
    <li><a class="dropdown-item" href="../articles/Multi_State_Processes.html">Multi-State Processes</a></li>
    <li><a class="dropdown-item" href="../articles/Non_Gaussian_Mixed_Models.html">Non-Gaussian Mixed Models</a></li>
    <li><a class="dropdown-item" href="../articles/Posterior_Predictive_Checks.html">Posterior Predictive Checks</a></li>
    <li><a class="dropdown-item" href="../articles/Recurring_Events.html">Recurrent Events</a></li>
    <li><a class="dropdown-item" href="../articles/Super_Learning.html">Combined Dynamic Predictions via Super Learning</a></li>
    <li><a class="dropdown-item" href="../articles/Time_Varying_Effects.html">Time Varying Effects</a></li>
    <li><a class="dropdown-item" href="../articles/Transformation_Functions.html">Transformation Functions for Functional Forms</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/drizopoulos/JMbayes2/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Posterior Predictive Checks</h1>
                        <h4 data-toc-skip class="author">Dimitris
Rizopoulos</h4>
            
            <h4 data-toc-skip class="date">2026-01-30</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/drizopoulos/JMbayes2/blob/HEAD/vignettes/Posterior_Predictive_Checks.Rmd" class="external-link"><code>vignettes/Posterior_Predictive_Checks.Rmd</code></a></small>
      <div class="d-none name"><code>Posterior_Predictive_Checks.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="goodness-of-fit-checks-for-joint-models">Goodness-of-Fit Checks for Joint Models<a class="anchor" aria-label="anchor" href="#goodness-of-fit-checks-for-joint-models"></a>
</h2>
<p>To investigate the fit of a joint model to the training dataset <span class="math inline">\mathcal D_n = \{T_i, \delta_i, \mathbf{y}_i,
\mathcal X_i; i = 1, \ldots, n\}</span>, we compare simulated
longitudinal measurements <span class="math inline">\mathbf{y}_i^{\sf
rep}</span> and event times <span class="math inline">T_i^{\sf
*rep}</span> from the fitted model with the observed data <span class="math inline">\mathcal D_n</span>. Ideally, we expect that
realizations from the fitted model are in close agreement with the
observed data. This framework supports multiple settings, including
checks for existing subjects, new subjects with only covariates, dynamic
prediction at intermediate follow-up times, and cross-validated
assessment. For the longitudinal component, goodness-of-fit is assessed
through the mean, variance, and correlation structure, while the
survival component is evaluated using empirical cumulative distributions
and probability integral transforms. The association between processes
is examined using time-dependent concordance statistics. A detailed
presentation of this framework is given in <a href="https://arxiv.org/abs/2601.18598" class="external-link">Rizopoulos, Taylor and Kardys
(2026)</a>.</p>
</div>
<div class="section level2">
<h2 id="posterior-posterior-predictive-checks">Posterior-Posterior Predictive Checks<a class="anchor" aria-label="anchor" href="#posterior-posterior-predictive-checks"></a>
</h2>
<p>We will illustrate the use of posterior predictive checks to evaluate
the fit of a joint model to the <code>prothro</code> dataset. We start
by fitting a Cox regression model for the time to death and include the
randomized treatment as a baseline covariate. Next, we fit a linear
mixed-effects model for the prothrombin time, with fixed effects the
linear effect of time, the main effect of treatment, and their
interaction, and random effects random intercepts and linear random
slopes. Finally, we fit the joint model that combines the two
submodels:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">CoxFit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sliced_model_generics.html">coxph</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">Time</span>, <span class="va">death</span><span class="op">)</span> <span class="op">~</span> <span class="va">treat</span>, data <span class="op">=</span> <span class="va">prothros</span><span class="op">)</span></span>
<span></span>
<span><span class="va">lmeFit1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sliced_model_generics.html">lme</a></span><span class="op">(</span><span class="va">pro</span> <span class="op">~</span> <span class="va">time</span> <span class="op">*</span> <span class="va">treat</span>, data <span class="op">=</span> <span class="va">prothro</span>, random <span class="op">=</span> <span class="op">~</span> <span class="va">time</span> <span class="op">|</span> <span class="va">id</span><span class="op">)</span></span>
<span></span>
<span><span class="va">jointFit1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/jm.html">jm</a></span><span class="op">(</span><span class="va">CoxFit</span>, <span class="va">lmeFit1</span>, time_var <span class="op">=</span> <span class="st">"time"</span>, save_random_effects <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>In the call to <code><a href="../reference/jm.html">jm()</a></code>, we set the control argument
<code>save_random_effects</code> to <code>TRUE</code> such that the MCMC
iterations for the random effects are saved in the resulting model
object. Using the MCMC sample of the parameters and the random effects,
we perform posterior-posterior predictive checks, i.e., we evaluate the
model’s fit to the patients of this study.</p>
<p>First, we evaluate the fit of the longitudinal submodel. A standard
fit measure used in the context of posterior predictive checks is to
compare the distribution of the observed outcome with the distributions
of the simulated outcomes using the empirical cumulative distribution
function (eCDF). Following this recommendation, we use the eCDF as a
global fit measure to assess the joint model’s fit to the marginal
distribution of the longitudinal outcome. This comparison is achieved
with the following call to the <code><a href="../reference/ppcheck.html">ppcheck()</a></code> function:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ppcheck.html">ppcheck</a></span><span class="op">(</span><span class="va">jointFit1</span>, random_effects <span class="op">=</span> <span class="st">"mcmc"</span>, type <span class="op">=</span> <span class="st">"ecdf"</span><span class="op">)</span></span></code></pre></div>
<p><img src="Posterior_Predictive_Checks_files/figure-html/Joint1-Long-eCDF-1.png" class="r-plt" alt="" width="816" style="display: block; margin: auto;"></p>
<p>The grey lines represent eCDF curves from the 40 simulated datasets
(default value), and the superimposed black line is the eCDF curve of
the observed data. The MISE value shown in the figure is the mean
integrated squared error between the eCDF of the simulated data and that
of the observed data.</p>
<p>However, the eCDF does not provide insight into key aspects of the
longitudinal outcome distribution, namely, the mean, variance, and
correlation structure. In particular, the mean function describes the
average longitudinal evolution of the outcome, the variance function the
longitudinal outcome’s variance over time, and the correlation structure
the pairwise correlations of the longitudinal responses as a function of
the time lags (i.e., time elapsed) between measurements. To evaluate the
joint model’s fit to the mean function of the longitudinal submodel, we
compare the loess curve of the observed longitudinal responses with the
loess curves of the simulated data:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ppcheck.html">ppcheck</a></span><span class="op">(</span><span class="va">jointFit1</span>, random_effects <span class="op">=</span> <span class="st">"mcmc"</span>, type <span class="op">=</span> <span class="st">"average"</span><span class="op">)</span></span></code></pre></div>
<p><img src="Posterior_Predictive_Checks_files/figure-html/Joint1-Long-mean-1.png" class="r-plt" alt="" width="816" style="display: block; margin: auto;"></p>
<p>Again, the grey lines are the loess curves of the simulated data, and
the superimposed black line is the loess curve of the observed data. For
the variance function, we compare the loess curves of the square root of
the absolute non-parametric residuals from the observed and simulated
data. The non-parametric residuals are defined as the observed/simulated
longitudinal responses minus the corresponding loess estimates over
time. This check is performed with the following call:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ppcheck.html">ppcheck</a></span><span class="op">(</span><span class="va">jointFit1</span>, random_effects <span class="op">=</span> <span class="st">"mcmc"</span>, type <span class="op">=</span> <span class="st">"variance"</span><span class="op">)</span></span></code></pre></div>
<p><img src="Posterior_Predictive_Checks_files/figure-html/Joint1-Long-variance-1.png" class="r-plt" alt="" width="816" style="display: block; margin: auto;"></p>
<p>Finally, to assess the model’s fit to the correlation structure of
the repeated measurements, we use the sample semi-variogram. That is, we
compare the half-squared differences of the non-parametric residuals
over the time lags for the observed and the simulated data:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ppcheck.html">ppcheck</a></span><span class="op">(</span><span class="va">jointFit1</span>, random_effects <span class="op">=</span> <span class="st">"mcmc"</span>, type <span class="op">=</span> <span class="st">"variogram"</span><span class="op">)</span></span></code></pre></div>
<p><img src="Posterior_Predictive_Checks_files/figure-html/Joint1-Long-variogram-1.png" class="r-plt" alt="" width="816" style="display: block; margin: auto;"></p>
<p>To assess the joint model’s fit to the event time, we use again the
eCDF as a global fit measure. To create simulated event time,
<code><a href="../reference/ppcheck.html">ppcheck()</a></code> requires a function that specifies the functional
form, i.e., the function of the longitudinal submodel’s linear predictor
that enters into the linear predictor of the survival submodel. For the
model we fitted above, the functional form is the current value. Hence,
the functional form function is specified as:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">FF1</span> <span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="va">t</span>, <span class="va">betas</span>, <span class="va">bi</span>, <span class="va">data</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># t is the time variable</span></span>
<span>    <span class="co"># betas are the fixed effects as a list</span></span>
<span>    <span class="co">#   in multivariate joint models each element of the list is the</span></span>
<span>    <span class="co">#   vector of fixed effects for the corresponding outcome</span></span>
<span>    <span class="co"># bi are the random effects as matrix</span></span>
<span>    <span class="co"># data is the dataset used in the longitudinal submodel</span></span>
<span>    <span class="co">#####</span></span>
<span>    <span class="co"># in the specified linear mixed model we used the treatment variable</span></span>
<span>    <span class="va">treat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">treat</span> <span class="op">==</span> <span class="st">"prednisone"</span><span class="op">)</span></span>
<span>    <span class="co"># the fixed effects design matrix has an intercept, the linear time effect</span></span>
<span>    <span class="co"># the treatment effect and their interaction</span></span>
<span>    <span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">t</span>, <span class="va">treat</span>, <span class="va">t</span> <span class="op">*</span> <span class="va">treat</span><span class="op">)</span></span>
<span>    <span class="co"># the random effects design matrix has an intercept and a linear slope</span></span>
<span>    <span class="va">Z</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">t</span><span class="op">)</span></span>
<span>    <span class="co"># we define the linear predictor</span></span>
<span>    <span class="va">eta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">X</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">betas</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">Z</span> <span class="op">*</span> <span class="va">bi</span><span class="op">)</span></span>
<span>    <span class="co"># we return as a matrix</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">eta</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>To perform the check, we use the <code>FF1</code> function in the
<code>Fforms_fun</code> of <code><a href="../reference/ppcheck.html">ppcheck()</a></code>; we also set the
<code>process</code> argument to <code>"event"</code>:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ppcheck.html">ppcheck</a></span><span class="op">(</span><span class="va">jointFit1</span>, random_effects <span class="op">=</span> <span class="st">"mcmc"</span>, process <span class="op">=</span> <span class="st">"event"</span>, Fforms_fun <span class="op">=</span> <span class="va">FF1</span>,</span>
<span>        type <span class="op">=</span> <span class="st">"ecdf"</span><span class="op">)</span></span></code></pre></div>
<p><img src="Posterior_Predictive_Checks_files/figure-html/Joint1-Surv-eCDF-1.png" class="r-plt" alt="" width="816" style="display: block; margin: auto;"></p>
<p>A second fit measure that focuses on individual level survival
functions, is to use the probability integral transform of the
subject-specific cumulative distribution functions. In particular, we
calculate the eCDF of each subject <span class="math inline">\{u_i =
F_i(t); i = 1, \ldots, n\}</span> using their simulated data <span class="math inline">\{T_{im}^{\sf *rep}; m = 1, \ldots, M\}</span>, with
<span class="math inline">m</span> denoting the realization of the
simulated event times for the <span class="math inline">i</span>-th
subject, i.e., <span class="math display">u_i = \frac{1}{M}
\sum\limits_{m = 1}^M \mathbb{I}(T_{im}^{\sf *rep} \leq t).</span> Using
the pairs <span class="math inline">\{u_i, \delta_i\}</span>, where
<span class="math inline">\delta_i</span> is the event indicator, we
calculate the Kaplan-Meier estimate of the probability <span class="math inline">\widehat{F}_i = \Pr(U_i \leq u)</span>. If the joint
model fits the marginal event time distribution well, we expect the
<span class="math inline">\widehat{F}_i</span> to be the cumulative
distribution function of the uniform distribution. This type of check is
performed using the following call to <code><a href="../reference/ppcheck.html">ppcheck()</a></code>:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ppcheck.html">ppcheck</a></span><span class="op">(</span><span class="va">jointFit1</span>, random_effects <span class="op">=</span> <span class="st">"mcmc"</span>, process <span class="op">=</span> <span class="st">"event"</span>, Fforms_fun <span class="op">=</span> <span class="va">FF1</span>,</span>
<span>        type <span class="op">=</span> <span class="st">"surv-uniform"</span><span class="op">)</span></span></code></pre></div>
<p><img src="Posterior_Predictive_Checks_files/figure-html/Joint1-Surv-ProbInt-1.png" class="r-plt" alt="" width="816" style="display: block; margin: auto;"></p>
<p>Finally, to evaluate whether the postulated joint model adequately
describes the association between the longitudinal and event-time
processes, we use the concordance statistic, which measures agreement
between the time-to-event outcome and the longitudinal predictor:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ppcheck.html">ppcheck</a></span><span class="op">(</span><span class="va">jointFit1</span>, random_effects <span class="op">=</span> <span class="st">"mcmc"</span>, process <span class="op">=</span> <span class="st">"joint"</span>, Fforms_fun <span class="op">=</span> <span class="va">FF1</span><span class="op">)</span></span></code></pre></div>
<p><img src="Posterior_Predictive_Checks_files/figure-html/Joint1-joint-1.png" class="r-plt" alt="" width="816" style="display: block; margin: auto;"></p>
</div>
<div class="section level2">
<h2 id="posterior-prior-predictive-checks">Posterior-Prior Predictive Checks<a class="anchor" aria-label="anchor" href="#posterior-prior-predictive-checks"></a>
</h2>
<p>We termed the predictive checks presented above as
`posterior-posterior predictive checks’ because we sampled the random
effects <span class="math inline">\mathbf{b}_i</span> for the posterior
distribution given the observed data of subject <span class="math inline">i</span>, which we have available in the training
dataset <span class="math inline">\mathcal D_n</span>. Alternatively, we
can perform posterior predictive checks for generic subjects from our
target population, i.e., subjects for whom we have no longitudinal or
event time information, but we do have covariate information. We
illustrate these checks in an updated joint model. In particular, the
event time submodel is the same, but in the longitudinal submodel we now
use natural cubic splines with three degrees of freedom for the time
effect in both the fixed- and random-effects parts:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lmeFit2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sliced_model_generics.html">lme</a></span><span class="op">(</span><span class="va">pro</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/splines/ns.html" class="external-link">ns</a></span><span class="op">(</span><span class="va">time</span>, <span class="fl">3</span><span class="op">)</span> <span class="op">*</span> <span class="va">treat</span>, data <span class="op">=</span> <span class="va">prothro</span>, </span>
<span>           random <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/nlme/man/pdDiag.html" class="external-link">pdDiag</a></span><span class="op">(</span><span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/splines/ns.html" class="external-link">ns</a></span><span class="op">(</span><span class="va">time</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">jointFit2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/jm.html">jm</a></span><span class="op">(</span><span class="va">CoxFit</span>, <span class="va">lmeFit2</span>, time_var <span class="op">=</span> <span class="st">"time"</span><span class="op">)</span></span></code></pre></div>
<p>To perform the posterior-prior checks, we also need to update the
functional forms function. This now takes the form:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">FF2</span> <span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="va">t</span>, <span class="va">betas</span>, <span class="va">bi</span>, <span class="va">data</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">treat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">treat</span> <span class="op">==</span> <span class="st">"prednisone"</span><span class="op">)</span></span>
<span>    <span class="va">NS</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/splines/ns.html" class="external-link">ns</a></span><span class="op">(</span><span class="va">t</span>, k <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.4928</span>, <span class="fl">2.1547</span><span class="op">)</span>, B <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">11.1078</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">NS</span>, <span class="va">treat</span>, <span class="va">NS</span> <span class="op">*</span> <span class="va">treat</span><span class="op">)</span></span>
<span>    <span class="va">Z</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">NS</span><span class="op">)</span></span>
<span>    <span class="va">eta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">X</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">betas</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">Z</span> <span class="op">*</span> <span class="va">bi</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">eta</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Note that, in the definition of the natural cubic spline basis, we
need to use the same internal and boundary knots as those used in the
linear mixed model. These can be found in the <code>predvars</code>
attribute of the <code>terms</code> component of the fitted model, i.e.,
using the call <code>attr(lmeFit2$terms, "predvars")</code>. The
following figures show the posterior-prior predictive checks for the
longitudinal outcome using the eCDF, the mean function, the variance
function, and the semi-variogram:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ppcheck.html">ppcheck</a></span><span class="op">(</span><span class="va">jointFit2</span>, random_effects <span class="op">=</span> <span class="st">"prior"</span>, type <span class="op">=</span> <span class="st">"ecdf"</span>, Fforms_fun <span class="op">=</span> <span class="va">FF2</span><span class="op">)</span></span></code></pre></div>
<p><img src="Posterior_Predictive_Checks_files/figure-html/Joint2-Long-1.png" class="r-plt" alt="" width="816" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ppcheck.html">ppcheck</a></span><span class="op">(</span><span class="va">jointFit2</span>, random_effects <span class="op">=</span> <span class="st">"prior"</span>, type <span class="op">=</span> <span class="st">"average"</span>, Fforms_fun <span class="op">=</span> <span class="va">FF2</span><span class="op">)</span></span></code></pre></div>
<p><img src="Posterior_Predictive_Checks_files/figure-html/Joint2-Long-2.png" class="r-plt" alt="" width="816" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ppcheck.html">ppcheck</a></span><span class="op">(</span><span class="va">jointFit2</span>, random_effects <span class="op">=</span> <span class="st">"prior"</span>, type <span class="op">=</span> <span class="st">"variance"</span>, Fforms_fun <span class="op">=</span> <span class="va">FF2</span><span class="op">)</span></span></code></pre></div>
<p><img src="Posterior_Predictive_Checks_files/figure-html/Joint2-Long-3.png" class="r-plt" alt="" width="816" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ppcheck.html">ppcheck</a></span><span class="op">(</span><span class="va">jointFit2</span>, random_effects <span class="op">=</span> <span class="st">"prior"</span>, type <span class="op">=</span> <span class="st">"variogram"</span>, Fforms_fun <span class="op">=</span> <span class="va">FF2</span><span class="op">)</span></span></code></pre></div>
<p><img src="Posterior_Predictive_Checks_files/figure-html/Joint2-Long-4.png" class="r-plt" alt="" width="816" style="display: block; margin: auto;"></p>
<p>Likewise, the following calls to <code><a href="../reference/ppcheck.html">ppcheck()</a></code> produce the
posterior-prior checks for the event time outcome:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ppcheck.html">ppcheck</a></span><span class="op">(</span><span class="va">jointFit2</span>, random_effects <span class="op">=</span> <span class="st">"prior"</span>, process <span class="op">=</span> <span class="st">"event"</span>, Fforms_fun <span class="op">=</span> <span class="va">FF2</span>,</span>
<span>        type <span class="op">=</span> <span class="st">"ecdf"</span><span class="op">)</span></span></code></pre></div>
<p><img src="Posterior_Predictive_Checks_files/figure-html/Joint2-Surv-1.png" class="r-plt" alt="" width="816" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ppcheck.html">ppcheck</a></span><span class="op">(</span><span class="va">jointFit2</span>, random_effects <span class="op">=</span> <span class="st">"prior"</span>, process <span class="op">=</span> <span class="st">"event"</span>, Fforms_fun <span class="op">=</span> <span class="va">FF2</span>,</span>
<span>        type <span class="op">=</span> <span class="st">"surv-uniform"</span><span class="op">)</span></span></code></pre></div>
<p><img src="Posterior_Predictive_Checks_files/figure-html/Joint2-Surv-2.png" class="r-plt" alt="" width="816" style="display: block; margin: auto;"></p>
</div>
<div class="section level2">
<h2 id="dynamic-posterior-posterior-predictive-checks">Dynamic-Posterior-Posterior Predictive Checks<a class="anchor" aria-label="anchor" href="#dynamic-posterior-posterior-predictive-checks"></a>
</h2>
<p>A popular use of joint models is the calculation of dynamic
predictions for longitudinal and survival outcomes. In this context, it
is relevant to assess a joint model’s fit at different follow-up times,
conditioning on the available information. In particular, we assume that
we collected longitudinal measurements <span class="math inline">\mathbf{y}_i(t_L)</span> up to time <span class="math inline">t_L</span>, and for the individuals at risk at this
time point, we are interested in assessing the fit after <span class="math inline">t_L</span>. As an example, we perform dynamic
posterior-posterior predictive checks for our model at the landmark time
<span class="math inline">t_L = 3</span> years. We create the dataset
with the available information at this time; we also set that the
observed time is equal to <span class="math inline">t_L</span> and that
the event has not occurred yet:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">t0</span> <span class="op">&lt;-</span> <span class="fl">3</span></span>
<span><span class="va">prothro_t0</span> <span class="op">&lt;-</span> <span class="va">prothro</span><span class="op">[</span><span class="va">prothro</span><span class="op">$</span><span class="va">Time</span> <span class="op">&gt;</span> <span class="va">t0</span> <span class="op">&amp;</span> <span class="va">prothro</span><span class="op">$</span><span class="va">time</span> <span class="op">&lt;=</span> <span class="va">t0</span>, <span class="op">]</span></span>
<span><span class="va">prothro_t0</span><span class="op">$</span><span class="va">Time</span> <span class="op">&lt;-</span> <span class="va">t0</span></span>
<span><span class="va">prothro_t0</span><span class="op">$</span><span class="va">death</span> <span class="op">&lt;-</span> <span class="fl">0</span></span></code></pre></div>
<p>Next, we use the <code><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict()</a></code> method to extract an MCMC
sample for the random effects using only the longitudinal measurements
up to year three:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">preds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">jointFit2</span>, newdata <span class="op">=</span> <span class="va">prothro_t0</span>, return_params_mcmc <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>Finally, to perform the dynamic posterior-posterior predictive checks
with <code><a href="../reference/ppcheck.html">ppcheck()</a></code>, we need to provide the data after the
landmark time in the <code>newdata</code> argument, and the MCMC sample
for the parameters and the random effects in the
<code>params_mcmc</code> argument, i.e.:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">test_prothro</span> <span class="op">&lt;-</span> <span class="va">prothro</span><span class="op">[</span><span class="va">prothro</span><span class="op">$</span><span class="va">Time</span> <span class="op">&gt;</span> <span class="va">t0</span> <span class="op">&amp;</span> <span class="va">prothro</span><span class="op">$</span><span class="va">time</span> <span class="op">&gt;</span> <span class="va">t0</span>, <span class="op">]</span></span>
<span><span class="fu"><a href="../reference/ppcheck.html">ppcheck</a></span><span class="op">(</span><span class="va">jointFit2</span>, random_effects <span class="op">=</span> <span class="st">"mcmc"</span>, type <span class="op">=</span> <span class="st">"average"</span>, </span>
<span>        newdata <span class="op">=</span> <span class="va">test_prothro</span>, params_mcmc <span class="op">=</span> <span class="va">preds</span><span class="op">$</span><span class="va">params_mcmc</span><span class="op">)</span></span></code></pre></div>
<p><img src="Posterior_Predictive_Checks_files/figure-html/Joint2-Long-dynamic-1.png" class="r-plt" alt="" width="816" style="display: block; margin: auto;"></p>
</div>
<div class="section level2">
<h2 id="cross-validated-checks">Cross-Validated Checks<a class="anchor" aria-label="anchor" href="#cross-validated-checks"></a>
</h2>
<p>A criticism of standard posterior predictive checks is that the
training dataset is used both to fit and to evaluate the model’s
goodness-of-fit, leading to potentially over-optimistic results. To
alleviate such concerns, we can evaluate the model fit in an independent
test dataset. In the absence of an external test dataset, we can utilize
a cross-validation procedure. We illustrate this approach using the
<code>prothro</code> dataset. We start by splitting the database into
five folds using the function <code><a href="../reference/accuracy.html">create_folds()</a></code>:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">CVdats</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/accuracy.html">create_folds</a></span><span class="op">(</span><span class="va">prothro</span>, V <span class="op">=</span> <span class="fl">5</span>, id_var <span class="op">=</span> <span class="st">"id"</span><span class="op">)</span></span></code></pre></div>
<p>The first argument for this function is the <code>data.frame</code>
we wish to split in <code>V</code> folds. The argument
<code>id_var</code> specifies the name of the subject’s id variable in
this dataset. The output of <code><a href="../reference/accuracy.html">create_folds()</a></code> is a list with
two components named <code>"training"</code> and <code>"testing"</code>.
Each component is another list with <code>V</code> data.frames.</p>
<p>Next, we define the function that will fit the joint model. This
function should accept a single <code>data.frame</code> argument to fit
the joint models. To optimize computational performance, we will use
parallel computing to fit the model to the different training datasets.
Hence, within the function, we should include the call
<code><a href="https://drizopoulos.github.io/JMbayes2/">library("JMbayes2")</a></code> to load the <strong>JMbayes2</strong>
package for each worker. The following code illustrates these steps:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_model</span> <span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://drizopoulos.github.io/JMbayes2/">"JMbayes2"</a></span><span class="op">)</span></span>
<span>    <span class="va">data_id</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/duplicated.html" class="external-link">duplicated</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">id</span><span class="op">)</span>, <span class="op">]</span></span>
<span>    <span class="va">CoxFit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sliced_model_generics.html">coxph</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">Time</span>, <span class="va">death</span><span class="op">)</span> <span class="op">~</span> <span class="va">treat</span>, data <span class="op">=</span> <span class="va">data_id</span><span class="op">)</span></span>
<span>    <span class="va">lmeFit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sliced_model_generics.html">lme</a></span><span class="op">(</span><span class="va">pro</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/splines/ns.html" class="external-link">ns</a></span><span class="op">(</span><span class="va">time</span>, <span class="fl">3</span><span class="op">)</span> <span class="op">*</span> <span class="va">treat</span>, data <span class="op">=</span> <span class="va">data</span>, </span>
<span>           random <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/nlme/man/pdDiag.html" class="external-link">pdDiag</a></span><span class="op">(</span><span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/splines/ns.html" class="external-link">ns</a></span><span class="op">(</span><span class="va">time</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="../reference/jm.html">jm</a></span><span class="op">(</span><span class="va">CoxFit</span>, <span class="va">lmeFit</span>, time_var <span class="op">=</span> <span class="st">"time"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">makeCluster</a></span><span class="op">(</span><span class="fl">5L</span><span class="op">)</span></span>
<span><span class="va">Models</span> <span class="op">&lt;-</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/clusterApply.html" class="external-link">parLapply</a></span><span class="op">(</span><span class="va">cl</span>, <span class="va">CVdats</span><span class="op">$</span><span class="va">training</span>, <span class="va">fit_model</span><span class="op">)</span></span>
<span><span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">stopCluster</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span></span></code></pre></div>
<p>When the first argument of <code><a href="../reference/ppcheck.html">ppcheck()</a></code> is a list of joint
models, and its <code>newdata</code> argument is a list of (testing)
datasets, the function will automatically loop over the elements of
these lists and combine the final results. The following call produces
the cross-validated posterior-prior predictive checks for the variance
function of the prothrombin outcome:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ppcheck.html">ppcheck</a></span><span class="op">(</span><span class="va">Models</span>, type <span class="op">=</span> <span class="st">"variance"</span>, newdata <span class="op">=</span> <span class="va">CVdats</span><span class="op">$</span><span class="va">testing</span>,</span>
<span>        random_effects <span class="op">=</span> <span class="st">"prior"</span>, Fforms_fun <span class="op">=</span> <span class="va">FF2</span><span class="op">)</span></span></code></pre></div>
<p><img src="Posterior_Predictive_Checks_files/figure-html/CV_check-1.png" class="r-plt" alt="" width="700"></p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://www.drizopoulos.com/" class="external-link">Dimitris Rizopoulos</a>, <a href="https://pafonso.com/" class="external-link">Pedro Miranda-Afonso</a>, <a href="https://gregpapageorgiou.com/" class="external-link">Grigorios Papageorgiou</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
