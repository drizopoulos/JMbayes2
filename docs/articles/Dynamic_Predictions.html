<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dynamic Predictions • JMbayes2</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/yeti/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><!-- docsearch --><script src="../docsearch.js"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.3/docsearch.min.css" integrity="sha256-QOSRU/ra9ActyXkIBbiIB144aDBdtvXBcNc3OTNuX/Q=" crossorigin="anonymous">
<link href="../docsearch.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script><meta property="og:title" content="Dynamic Predictions">
<meta property="og:description" content="JMbayes2">
<meta property="og:image" content="https://drizopoulos.github.io/JMbayes2/reference/figures/square_logo.png">
<meta property="og:image:alt" content="JMbayes2: Extended Joint Models for Longitudinal and Time-to-Event Data">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:creator" content="@drizopoulos">
<meta name="twitter:site" content="@drizopoulos">
<meta name="robots" content="noindex">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-YDBZ5DBBSP"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-YDBZ5DBBSP');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">JMbayes2</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.3-0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/JMbayes2.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Competing_Risks.html">Competing Risks</a>
    </li>
    <li>
      <a href="../articles/Dynamic_Predictions.html">Dynamic Predictions</a>
    </li>
    <li>
      <a href="../articles/Multi_State_Processes.html">Multi-State Processes</a>
    </li>
    <li>
      <a href="../articles/Non_Gaussian_Mixed_Models.html">Non-Gaussian Mixed Models</a>
    </li>
    <li>
      <a href="../articles/Recurring_Events.html">Recurrent Events</a>
    </li>
    <li>
      <a href="../articles/Transformation_Functions.html">Transformation Functions for Functional Forms</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/drizopoulos/JMbayes2/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
<form class="navbar-form navbar-right hidden-xs hidden-sm" role="search">
        <div class="form-group">
          <input type="search" class="form-control" name="search-input" id="search-input" placeholder="Search..." aria-label="Search for..." autocomplete="off">
</div>
      </form>
      
    </div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Dynamic Predictions</h1>
                        <h4 data-toc-skip class="author">Dimitris
Rizopoulos</h4>
            
            <h4 data-toc-skip class="date">2022-09-09</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/drizopoulos/JMbayes2/blob/HEAD/vignettes/Dynamic_Predictions.Rmd" class="external-link"><code>vignettes/Dynamic_Predictions.Rmd</code></a></small>
      <div class="hidden name"><code>Dynamic_Predictions.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="dynamic-predictions">Dynamic Predictions<a class="anchor" aria-label="anchor" href="#dynamic-predictions"></a>
</h2>
<div class="section level3">
<h3 id="theory">Theory<a class="anchor" aria-label="anchor" href="#theory"></a>
</h3>
<p>Based on the general framework of joint models presented earlier, we
are interested in deriving cumulative risk probabilities for a new
subject <span class="math inline">\(j\)</span> that has survived up to
time point <span class="math inline">\(t\)</span> and has provided
longitudinal measurements <span class="math inline">\(\mathcal Y_{kj}(t)
= \{ y_{kj}(t_{jl}); 0 \leq t_{jl} \leq t, l = 1, \ldots, n_j, k = 1,
\ldots, K\}\)</span>, with <span class="math inline">\(K\)</span>
denoting the number of longitudinal outcomes. The probabilities of
interest are <span class="math display">\[\begin{array}{l}
\pi_j(u \mid t) = \mbox{Pr}\{T_j^* \leq u \mid T_j^* &gt; t, \mathcal
Y_j(t), \mathcal D_n\}\\\\
= \displaystyle 1 - \int\int \frac{S(u \mid b_j, \theta)}{S(t \mid b_j,
\theta)} \; p\{b_j \mid T_j^* &gt; t, \mathcal Y_j(t), \theta\} \;
p(\theta \mid \mathcal D_n) \; db_j d\theta,
\end{array}\]</span> where <span class="math inline">\(S(\cdot)\)</span>
denotes the survival function conditional on the random effects, and
<span class="math inline">\(\mathcal Y_j(t) = \{\mathcal Y_{1j}(t),
\ldots, \mathcal Y_{Kj}(t)\}\)</span>. Combining the three terms in the
integrand we can device a Monte Carlo scheme to obtain estimates of
these probabilities, namely,</p>
<ol style="list-style-type: decimal">
<li><p>Sample a value <span class="math inline">\(\tilde \theta\)</span>
from the posterior of the parameters <span class="math inline">\([\theta
\mid \mathcal D_n]\)</span>.</p></li>
<li><p>Sample a value <span class="math inline">\(\tilde b_j\)</span>
from the posterior of the random effects <span class="math inline">\([b_j \mid T_j^* &gt; t, \mathcal Y_j(t), \tilde
\theta]\)</span>.</p></li>
<li><p>Compute the ratio of survival probabilities <span class="math inline">\(S(u \mid \tilde b_j, \tilde \theta) \Big / S(t
\mid \tilde b_j, \tilde \theta)\)</span>.</p></li>
</ol>
<p>Replicating these steps <span class="math inline">\(L\)</span> times,
we can estimate the conditional cumulative risk probabilities by <span class="math display">\[1 - \frac{1}{L} \sum_{l=1}^L \frac{S(u \mid
\tilde b_j^{(l)},
\tilde \theta^{(l)})}{S(t \mid \tilde b_j^{(l)},
\tilde \theta^{(l)})},\]</span> and their standard error by calculating
the standard deviation across the Monte Carlo samples.</p>
</div>
<div class="section level3">
<h3 id="example">Example<a class="anchor" aria-label="anchor" href="#example"></a>
</h3>
<p>We will illustrate the calculation of dynamic predictions using
package <strong>JMbayes2</strong> from a trivariate joint model fitted
to the PBC dataset for the longitudinal outcomes <code>serBilir</code>
(continuous), <code>prothrombin</code> time (continuous) and
<code>ascites</code> (dichotomous). We start by fitting the univariate
mixed models. For the two continuous outcomes, we allow for nonlinear
subject-specific time effects using natural cubic splines. For
<code>ascites</code>, we postulate linear subject-specific profiles for
the log odds. The code is:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fm1</span> <span class="op">&lt;-</span> <span class="fu">lme</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">serBilir</span><span class="op">)</span> <span class="op">~</span> <span class="fu">ns</span><span class="op">(</span><span class="va">year</span>, <span class="fl">3</span><span class="op">)</span> <span class="op">*</span> <span class="va">sex</span>, data <span class="op">=</span> <span class="va">pbc2</span>,</span>
<span>           random <span class="op">=</span> <span class="op">~</span> <span class="fu">ns</span><span class="op">(</span><span class="va">year</span>, <span class="fl">3</span><span class="op">)</span> <span class="op">|</span> <span class="va">id</span>, control <span class="op">=</span> <span class="fu">lmeControl</span><span class="op">(</span>opt <span class="op">=</span> <span class="st">'optim'</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fm2</span> <span class="op">&lt;-</span> <span class="fu">lme</span><span class="op">(</span><span class="va">prothrombin</span> <span class="op">~</span> <span class="fu">ns</span><span class="op">(</span><span class="va">year</span>, <span class="fl">2</span><span class="op">)</span> <span class="op">*</span> <span class="va">sex</span>, data <span class="op">=</span> <span class="va">pbc2</span>,</span>
<span>           random <span class="op">=</span> <span class="op">~</span> <span class="fu">ns</span><span class="op">(</span><span class="va">year</span>, <span class="fl">2</span><span class="op">)</span> <span class="op">|</span> <span class="va">id</span>, control <span class="op">=</span> <span class="fu">lmeControl</span><span class="op">(</span>opt <span class="op">=</span> <span class="st">'optim'</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fm3</span> <span class="op">&lt;-</span> <span class="fu">mixed_model</span><span class="op">(</span><span class="va">ascites</span> <span class="op">~</span> <span class="va">year</span> <span class="op">*</span> <span class="va">sex</span>, data <span class="op">=</span> <span class="va">pbc2</span>,</span>
<span>                   random <span class="op">=</span> <span class="op">~</span> <span class="va">year</span> <span class="op">|</span> <span class="va">id</span>, family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">binomial</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Following, we fit the Cox model for the time to either
transplantation or death. The first line defines the composite event
indicator, and the second one fits the Cox model in which we have also
included the baseline covariates <code>drug</code> and <code>age</code>.
The code is:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pbc2.id</span><span class="op">$</span><span class="va">event</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">pbc2.id</span><span class="op">$</span><span class="va">status</span> <span class="op">!=</span> <span class="st">"alive"</span><span class="op">)</span></span>
<span><span class="va">CoxFit</span> <span class="op">&lt;-</span> <span class="fu">coxph</span><span class="op">(</span><span class="fu">Surv</span><span class="op">(</span><span class="va">years</span>, <span class="va">event</span><span class="op">)</span> <span class="op">~</span> <span class="va">drug</span> <span class="op">+</span> <span class="va">age</span>, data <span class="op">=</span> <span class="va">pbc2.id</span><span class="op">)</span></span></code></pre></div>
<p>The joint model is fitted with the following call to
<code><a href="../reference/jm.html">jm()</a></code>:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">jointFit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/jm.html">jm</a></span><span class="op">(</span><span class="va">CoxFit</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">fm1</span>, <span class="va">fm2</span>, <span class="va">fm3</span><span class="op">)</span>, time_var <span class="op">=</span> <span class="st">"year"</span><span class="op">)</span></span></code></pre></div>
<p>We want to calculate predictions for the longitudinal and survival
outcomes for Patients 25 and 93. As a first step, we extract the data of
these patients and store them in the data.frame <code>ND</code> with the
code:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">t0</span> <span class="op">&lt;-</span> <span class="fl">5</span></span>
<span><span class="va">ND</span> <span class="op">&lt;-</span> <span class="va">pbc2</span><span class="op">[</span><span class="va">pbc2</span><span class="op">$</span><span class="va">id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">25</span>, <span class="fl">93</span><span class="op">)</span>, <span class="op">]</span></span>
<span><span class="va">ND</span> <span class="op">&lt;-</span> <span class="va">ND</span><span class="op">[</span><span class="va">ND</span><span class="op">$</span><span class="va">year</span> <span class="op">&lt;</span> <span class="va">t0</span>, <span class="op">]</span></span>
<span><span class="va">ND</span><span class="op">$</span><span class="va">status2</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="va">ND</span><span class="op">$</span><span class="va">years</span> <span class="op">&lt;-</span> <span class="va">t0</span></span></code></pre></div>
<p>We will only use the first five years of follow-up (line three), and
further we specify that the patients were event-free up to this time
point (lines four and five).</p>
<p>We start with predictions for the longitudinal outcomes. These are
produced by the <code><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict()</a></code> method for class <code>jm</code>
objects, and follow the same lines as the procedure described above for
cumulative risk probabilities. The only difference is in Step 3, where
instead of calculating the cumulative risk we calculate the predicted
values for the longitudinal outcomes. There are two options controlled
by the <code>type_pred</code> argument, namely predictions at the scale
of the response/outcome (default) or at the linear predictor level. The
<code>type</code> argument controls if the predictions will be for the
mean subject (i.e., including only the fixed effects) or
subject-specific including both the fixed and random effects. In the
<code>newdata</code> argument we provide the available measurements of
the two patients. This will be used to sample their random effects at
Step 2 presented above. This is done with a Metropolis-Hastings
algorithm that runs for <code>n_mcmc</code> iterations; all iterations
but the last one are discarded as burn-in. Finally, argument
<code>n_samples</code> corresponds to the value of <span class="math inline">\(L\)</span> defined above and specifies the number
of Monte Carlo samples:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">predLong1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">jointFit</span>, newdata <span class="op">=</span> <span class="va">ND</span>, return_newdata <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>Argument <code>return_newdata</code> specifies that the predictions
are returned as extra columns of the <code>newdata</code> data.frame. By
default the 95% credible intervals are also included. Using the
<code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code> method for objects returned by
<code>predict.jm(..., return_newdata = TRUE)</code>, we can display the
predictions. With the following code we do that for the first
longitudinal outcome:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">predLong1</span><span class="op">)</span></span></code></pre></div>
<p><img src="Dynamic_Predictions_files/figure-html/unnamed-chunk-6-1.png" width="816" style="display: block; margin: auto;"></p>
<p>When we want to calculate predictions for other, future time points,
we can accordingly specify the <code>times</code> argument. In the
following example, we calculate predictions from time <code>t0</code> to
time 12:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">predLong2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">jointFit</span>, newdata <span class="op">=</span> <span class="va">ND</span>,</span>
<span>                     times <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="va">t0</span>, <span class="fl">12</span>, length.out <span class="op">=</span> <span class="fl">51</span><span class="op">)</span>,</span>
<span>                     return_newdata <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>We show these predictions for the second outcome and the second
patient (i.e., Patient 93). This is achieved by suitably specifying the
<code>outcomes</code> and <code>subject</code> arguments of the
<code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code> method:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">predLong2</span>, outcomes <span class="op">=</span> <span class="fl">2</span>, subject <span class="op">=</span> <span class="fl">93</span><span class="op">)</span></span></code></pre></div>
<p><img src="Dynamic_Predictions_files/figure-html/unnamed-chunk-8-1.png" width="816" style="display: block; margin: auto;"></p>
<p>We continue with the predictions for the event outcome. To let
<code><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict()</a></code> know that we want the cumulative risk
probabilities, we specify <code>process = "event"</code>:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">predSurv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">jointFit</span>, newdata <span class="op">=</span> <span class="va">ND</span>, process <span class="op">=</span> <span class="st">"event"</span>,</span>
<span>                    times <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="va">t0</span>, <span class="fl">12</span>, length.out <span class="op">=</span> <span class="fl">51</span><span class="op">)</span>,</span>
<span>                    return_newdata <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>The predictions are included again as extra columns in the
corresponding data.frame. To depict the predictions of both the
longitudinal and survival outcomes combined, we provide both objects to
the <code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code> method:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">predLong2</span>, <span class="va">predSurv</span><span class="op">)</span></span></code></pre></div>
<p><img src="Dynamic_Predictions_files/figure-html/unnamed-chunk-10-1.png" width="816" style="display: block; margin: auto;"></p>
<p>Again by default, the plot is for the predictions of the first
subject (i.e., Patient 25) and for the first longitudinal outcome (i.e.,
<code>log(serBilir)</code>). However, the <code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code> method has
a series of arguments that allows users to customize the plot. We
illustrate some of these capabilities with the following figure. First,
we specify that we want to depict all three outcomes using
<code>outcomes = 1:3</code> (note: a max of three outcomes can be
simultaneously displayed). Next, we specify via the <code>subject</code>
argument that we want to show the predictions of Patient 93. Note, that
for serum bilirubin we used the log transformation in the specification
of the linear mixed model. Hence, we receive predictions on the
transformed scale. To show predictions on the original scale, we use the
<code>fun_long</code> argument. Because we have three outcomes, this
needs to be a list of three functions. The first one, corresponding to
serum bilirubin is the <code><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp()</a></code> and for the other two the
<code><a href="https://rdrr.io/r/base/identity.html" class="external-link">identity()</a></code> because we do not wish to transform the
predictions. Analogously, we also have the <code>fun_event</code>
argument to transform the predictions for the event outcome, and in the
example below we set that we want to obtain survival probabilities.
Using the arguments <code>bg</code>, <code>col_points</code>,
<code>col_line_long</code>, <code>col_line_event</code>,
<code>fill_CI_long</code>, and <code>fill_CI_event</code> we have
changed the appearance of the plot to a dark theme. Finally, the
<code>pos_ylab_long</code> specifies the relative positive of the y-axis
labels for the three longitudinal outcomes.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'#F25C78'</span>, <span class="st">'#D973B5'</span>, <span class="st">'#F28322'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">predLong2</span>, <span class="va">predSurv</span>, outcomes <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, subject <span class="op">=</span> <span class="fl">93</span>,</span>
<span>     fun_long <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">exp</span>, <span class="va">identity</span>, <span class="va">identity</span><span class="op">)</span>,</span>
<span>     fun_event <span class="op">=</span> <span class="kw">function</span> <span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fl">1</span> <span class="op">-</span> <span class="va">x</span>,</span>
<span>     ylab_event <span class="op">=</span> <span class="st">"Survival Probabilities"</span>,</span>
<span>     ylab_long <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Serum Bilirubin"</span>, <span class="st">"Prothrombin"</span>, <span class="st">"Ascites"</span><span class="op">)</span>,</span>
<span>     bg <span class="op">=</span> <span class="st">'#132743'</span>, col_points <span class="op">=</span> <span class="va">cols</span>, col_line_long <span class="op">=</span> <span class="va">cols</span>,</span>
<span>     col_line_event <span class="op">=</span> <span class="st">'#F7F7FF'</span>, col_axis <span class="op">=</span> <span class="st">"white"</span>, </span>
<span>     fill_CI_long <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#F25C7880"</span>, <span class="st">"#D973B580"</span>, <span class="st">"#F2832280"</span><span class="op">)</span>,</span>
<span>     fill_CI_event <span class="op">=</span> <span class="st">"#F7F7FF80"</span>,</span>
<span>     pos_ylab_long <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1.9</span>, <span class="fl">1.9</span>, <span class="fl">0.08</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="Dynamic_Predictions_files/figure-html/unnamed-chunk-12-1.png" width="816" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="predictive-accuracy">Predictive accuracy<a class="anchor" aria-label="anchor" href="#predictive-accuracy"></a>
</h3>
<p>We evaluate the discriminative capability of the model using ROC
methodology. We calculate the components of the ROC curve using
information up to year five, and we are interested in events occurring
within a three-year window. That is discriminating between patients who
will get the event in the interval <code>(t0, t0 + Dt]</code>, (i.e., in
our case <span class="math inline">\(T_j \in (5, 8]\)</span>) from
patients who will survive at least 8 years (i.e., <span class="math inline">\(T_j &gt; 8\)</span>). The calculations are
performed with the following call to <code><a href="../reference/accuracy.html">tvROC()</a></code>:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pbc2</span><span class="op">$</span><span class="va">event</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">pbc2</span><span class="op">$</span><span class="va">status</span> <span class="op">!=</span> <span class="st">"alive"</span><span class="op">)</span></span>
<span><span class="va">roc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/accuracy.html">tvROC</a></span><span class="op">(</span><span class="va">jointFit</span>, newdata <span class="op">=</span> <span class="va">pbc2</span>, Tstart <span class="op">=</span> <span class="va">t0</span>, Dt <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">roc</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Time-dependent Sensitivity and Specificity for the Joint Model jointFit</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; At time: 8</span></span>
<span><span class="co">#&gt; Using information up to time: 5 (202 subjects still at risk)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;    cut-off         SN         SP        qSN         qSP  </span></span>
<span><span class="co">#&gt; 1     0.05 0.02127789 1.00000000 0.01640862 1.000000000  </span></span>
<span><span class="co">#&gt; 2     0.07 0.06383366 1.00000000 0.04972059 1.000000000  </span></span>
<span><span class="co">#&gt; 3     0.08 0.08511154 1.00000000 0.06662895 1.000000000  </span></span>
<span><span class="co">#&gt; 4     0.09 0.10638943 1.00000000 0.08370895 1.000000000  </span></span>
<span><span class="co">#&gt; 5     0.10 0.12766731 1.00000000 0.10096325 1.000000000  </span></span>
<span><span class="co">#&gt; 6     0.11 0.14894520 1.00000000 0.11839451 1.000000000  </span></span>
<span><span class="co">#&gt; 7     0.12 0.14894520 0.99354851 0.11385015 0.837099767  </span></span>
<span><span class="co">#&gt; 8     0.16 0.17881374 0.98970172 0.13604362 0.791974645  </span></span>
<span><span class="co">#&gt; 9     0.19 0.20009162 0.98970172 0.15402360 0.810886041  </span></span>
<span><span class="co">#&gt; 10    0.20 0.22136951 0.98970172 0.17219285 0.826645537  </span></span>
<span><span class="co">#&gt; 11    0.21 0.23729845 0.98807991 0.18483750 0.814780085  </span></span>
<span><span class="co">#&gt; 12    0.23 0.25857634 0.98807991 0.20336394 0.828010078  </span></span>
<span><span class="co">#&gt; 13    0.26 0.27985422 0.98807991 0.22208852 0.839476073  </span></span>
<span><span class="co">#&gt; 14    0.28 0.32240999 0.98162841 0.25612402 0.793829958  </span></span>
<span><span class="co">#&gt; 15    0.31 0.32815646 0.97691926 0.25840222 0.754615269  </span></span>
<span><span class="co">#&gt; 16    0.34 0.34943435 0.96401627 0.26992077 0.669603927  </span></span>
<span><span class="co">#&gt; 17    0.36 0.37071223 0.96401627 0.28985403 0.683968974  </span></span>
<span><span class="co">#&gt; 18    0.43 0.37594851 0.95270093 0.28780565 0.617823516  </span></span>
<span><span class="co">#&gt; 19    0.45 0.39722640 0.95270093 0.30818030 0.632522612  </span></span>
<span><span class="co">#&gt; 20    0.47 0.41850428 0.95270093 0.32878780 0.646132885  </span></span>
<span><span class="co">#&gt; 21    0.48 0.42885604 0.94938811 0.33694781 0.634871342  </span></span>
<span><span class="co">#&gt; 22    0.49 0.45013392 0.94938811 0.35795984 0.647461985  </span></span>
<span><span class="co">#&gt; 23    0.50 0.47141181 0.94938811 0.37921619 0.659213252  </span></span>
<span><span class="co">#&gt; 24    0.51 0.47197345 0.93665541 0.37258022 0.600137276  </span></span>
<span><span class="co">#&gt; 25    0.52 0.49325134 0.93665541 0.39430042 0.612254328  </span></span>
<span><span class="co">#&gt; 26    0.53 0.50248356 0.93300314 0.40179571 0.601959841  </span></span>
<span><span class="co">#&gt; 27    0.55 0.50248356 0.92655165 0.39821364 0.576098078  </span></span>
<span><span class="co">#&gt; 28    0.56 0.52376144 0.92655165 0.42048079 0.587873131  </span></span>
<span><span class="co">#&gt; 29    0.58 0.54503933 0.92655165 0.44301784 0.599011695  </span></span>
<span><span class="co">#&gt; 30    0.59 0.54503933 0.92010015 0.43962161 0.575269233  </span></span>
<span><span class="co">#&gt; 31    0.60 0.55429802 0.91645591 0.44765767 0.567284460  </span></span>
<span><span class="co">#&gt; 32    0.63 0.59685379 0.91645591 0.49418922 0.588392535  </span></span>
<span><span class="co">#&gt; 33    0.64 0.61813167 0.91000442 0.51485911 0.577230048 *</span></span>
<span><span class="co">#&gt; 34    0.65 0.61813167 0.90355292 0.51178859 0.557220232  </span></span>
<span><span class="co">#&gt; 35    0.66 0.62426896 0.89896226 0.51657535 0.546452830  </span></span>
<span><span class="co">#&gt; 36    0.68 0.63153062 0.87535804 0.51352409 0.486169861  </span></span>
<span><span class="co">#&gt; 37    0.70 0.63464851 0.86985189 0.51446710 0.474201639  </span></span>
<span><span class="co">#&gt; 38    0.71 0.63489623 0.86347551 0.51158304 0.459255927  </span></span>
<span><span class="co">#&gt; 39    0.72 0.63489623 0.85057252 0.50502710 0.430483935  </span></span>
<span><span class="co">#&gt; 40    0.73 0.63489623 0.83766953 0.49829278 0.403804452  </span></span>
<span><span class="co">#&gt; 41    0.74 0.65617412 0.83766953 0.52429569 0.414450801  </span></span>
<span><span class="co">#&gt; 42    0.75 0.65617412 0.83121803 0.52101497 0.401860403  </span></span>
<span><span class="co">#&gt; 43    0.76 0.66044502 0.80670700 0.51354535 0.359914996  </span></span>
<span><span class="co">#&gt; 44    0.77 0.66044502 0.79380402 0.50654600 0.338863667  </span></span>
<span><span class="co">#&gt; 45    0.78 0.68172291 0.78735252 0.53071553 0.339157064  </span></span>
<span><span class="co">#&gt; 46    0.79 0.70372245 0.78111983 0.55668100 0.340092637  </span></span>
<span><span class="co">#&gt; 47    0.80 0.71443811 0.75211137 0.55628075 0.304534678  </span></span>
<span><span class="co">#&gt; 48    0.82 0.72186315 0.72855668 0.55409806 0.278532225  </span></span>
<span><span class="co">#&gt; 49    0.83 0.72596205 0.72334798 0.55715468 0.274237557  </span></span>
<span><span class="co">#&gt; 50    0.84 0.75096099 0.70512173 0.58424893 0.264624555  </span></span>
<span><span class="co">#&gt; 51    0.85 0.75157102 0.67950071 0.57108843 0.238342867  </span></span>
<span><span class="co">#&gt; 52    0.86 0.75645701 0.64872468 0.56075282 0.211582062  </span></span>
<span><span class="co">#&gt; 53    0.87 0.80384342 0.62438336 0.62619217 0.209639991  </span></span>
<span><span class="co">#&gt; 54    0.88 0.80709908 0.60601600 0.62168946 0.196113459  </span></span>
<span><span class="co">#&gt; 55    0.89 0.81160613 0.55577059 0.59941514 0.161361304  </span></span>
<span><span class="co">#&gt; 56    0.90 0.83451041 0.54336073 0.63664243 0.161444251  </span></span>
<span><span class="co">#&gt; 57    0.91 0.86095379 0.50621795 0.66956076 0.147487401  </span></span>
<span><span class="co">#&gt; 58    0.92 0.88223167 0.46105749 0.69104932 0.129068903  </span></span>
<span><span class="co">#&gt; 59    0.93 0.88400014 0.42933622 0.67455595 0.113276282  </span></span>
<span><span class="co">#&gt; 60    0.94 0.88689532 0.37860209 0.64301335 0.090417552  </span></span>
<span><span class="co">#&gt; 61    0.95 0.93071264 0.30156666 0.72007905 0.071818851  </span></span>
<span><span class="co">#&gt; 62    0.96 0.93255510 0.21180438 0.62155915 0.040870386  </span></span>
<span><span class="co">#&gt; 63    0.97 0.97711462 0.10273651 0.72806779 0.020285274  </span></span>
<span><span class="co">#&gt; 64    0.98 1.00000000 0.01935448 1.00000000 0.004570882</span></span></code></pre></div>
<p>In the first line we define the event indicator as we did in the
<code>pbc2.id</code> data.frame. The cut-point with the asterisk on the
right maximizes the <a href="https://en.wikipedia.org/wiki/Youden%27s_J_statistic" class="external-link">Youden’s
index</a>. To depict the ROC curve, we use the corresponding
<code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code> method:
<img src="Dynamic_Predictions_files/figure-html/unnamed-chunk-14-1.png" width="816" style="display: block; margin: auto;"></p>
<p>The area under the ROC curve is calculated with the
<code><a href="../reference/accuracy.html">tvAUC()</a></code> function:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/accuracy.html">tvAUC</a></span><span class="op">(</span><span class="va">roc</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Time-dependent AUC for the Joint Model jointFit</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Estimated AUC: 0.8042</span></span>
<span><span class="co">#&gt; At time: 8</span></span>
<span><span class="co">#&gt; Using information up to time: 5 (202 subjects still at risk)</span></span></code></pre></div>
<p>This function either accepts an object of class <code>tvROC</code> or
of class <code>jm</code>. In the latter case, the user must also provide
the <code>newdata</code>, <code>Tstart</code> and <code>Dt</code> or
<code>Thoriz</code> arguments. Here we have used the same dataset as the
one to fit the model, but, in principle, discrimination could be
(better) assessed in another dataset.</p>
<p>To assess the accuracy of the predictions we produce a calibration
plot:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/accuracy.html">calibration_plot</a></span><span class="op">(</span><span class="va">jointFit</span>, newdata <span class="op">=</span> <span class="va">pbc2</span>, Tstart <span class="op">=</span> <span class="va">t0</span>, Dt <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p><img src="Dynamic_Predictions_files/figure-html/unnamed-chunk-16-1.png" width="816" style="display: block; margin: auto;"></p>
<p>The syntax of the <code><a href="../reference/accuracy.html">calibration_plot()</a></code> function is almost
identical to that of <code><a href="../reference/accuracy.html">tvROC()</a></code>. The kernel density estimation
is of the estimated probabilities <span class="math inline">\(\pi_j(t +
\Delta t \mid t) = \pi_j(8 \mid 5)\)</span> for all individuals at risk
at year <code>t0</code> in the data frame provided in the
<code>newdata</code> argument. Using the
<code><a href="../reference/accuracy.html">calibration_metrics()</a></code> function we can also calculate
metrics for the accuracy of predictions:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/accuracy.html">calibration_metrics</a></span><span class="op">(</span><span class="va">jointFit</span>, <span class="va">pbc2</span>, Tstart <span class="op">=</span> <span class="fl">5</span>, Dt <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#&gt;        ICI        E50        E90 </span></span>
<span><span class="co">#&gt; 0.04122340 0.03436950 0.06498383</span></span></code></pre></div>
<p>The ICI is the mean absolute difference between the observed and
predicted probabilities, E50 is the median absolute difference, and E90
is the 90% percentile of the absolute differences. Finally, we calculate
the Brier score as an overall measure of predictive performance. This is
computed with the <code><a href="../reference/accuracy.html">tvBrier()</a></code> function:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/accuracy.html">tvBrier</a></span><span class="op">(</span><span class="va">jointFit</span>, newdata <span class="op">=</span> <span class="va">pbc2</span>, Tstart <span class="op">=</span> <span class="va">t0</span>, Dt <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Prediction Error for the Joint Model jointFit</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Estimated Brier score: 0.1267</span></span>
<span><span class="co">#&gt; At time: 8</span></span>
<span><span class="co">#&gt; Using information up to time: 5 (202 subjects still at risk)</span></span></code></pre></div>
<p><strong>Notes:</strong></p>
<ul>
<li>To obtain valid estimates of the predictive accuracy measures (i.e.,
time-varying sensitivity, specificity, and Brier score) we need to
account for censoring. A popular method to achieve this is via inverse
probability of censoring weighting. For this approach to be valid, we
need the model for the weights to be correctly specified. In standard
survival analysis, this is achieved either using the Kaplan-Meier
estimator or a Cox model for the censoring distribution. However, in the
settings where joint models are used, it is often the case that the
censoring mechanism may depend on the history of the longitudinal
outcomes in a complex manner. This is especially the case when we
consider multiple longitudinal outcomes in the analysis. Also, these
outcomes may be recorded at different time points per patient and have
missing data. Because of these reasons, in these settings,
Kaplan-Meier-based or Cox-based censoring weights may be difficult to
derive or be biased. The functions in <strong>JMbayes2</strong> that
calculate the predictive accuracy measures use joint-model-based weights
to account for censoring. These weights allow censoring to depend in any
possible manner on the history of the longitudinal outcomes. However,
they require that the model is appropriately calibrated.</li>
<li>The calibration curve, produced by <code><a href="../reference/accuracy.html">calibration_plot()</a></code>,
and the calibration metrics, produced by
<code>calibration_metrics())</code>, are calculated using the procedure
described in <a href="https://doi.org/10.1002/sim.8570" class="external-link">Austin et al.,
2020</a>.</li>
</ul>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by <a href="http://www.drizopoulos.com/" class="external-link">Dimitris Rizopoulos</a>, <a href="https://gregpapageorgiou.com/" class="external-link">Grigorios Papageorgiou</a>, <a href="https://pafonso.com/" class="external-link">Pedro Miranda Afonso</a>.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

      </footer>
</div>

  
<script src="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.1/docsearch.min.js" integrity="sha256-GKvGqXDznoRYHCwKXGnuchvKSwmx9SRMrZOTh2g4Sb0=" crossorigin="anonymous"></script><script>
  docsearch({
    
    
    apiKey: '66a8ef39105517ba1ce2f07aa1c70890',
    indexName: 'drizopoulos',
    inputSelector: 'input#search-input.form-control',
    transformData: function(hits) {
      return hits.map(function (hit) {
        hit.url = updateHitURL(hit);
        return hit;
      });
    }
  });
</script>
</body>
</html>
