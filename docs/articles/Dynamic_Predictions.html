<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Dynamic Predictions • JMbayes2</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<!-- katex math --><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" integrity="sha384-nB0miv6/jRmo5UMMR1wu3Gz6NLsoTkbqJghGIsx//Rlm+ZU03BU6SQNC66uf4l5+" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js" integrity="sha384-7zkQWkzuo3B5mTepMUcHkMB5jZaolc2xDwL6VFqjFALcbeS9Ggm/Yr2r3Dy4lfFg" crossorigin="anonymous"></script><script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js" integrity="sha384-43gviWU0YVjaDtb/GhzOouOXtZMP/7XUzwPTstBeZFe/+rCMvRwr4yROQP43s0Xk" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script><script src="../katex-auto.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Dynamic Predictions">
<meta name="robots" content="noindex">
<!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-YDBZ5DBBSP"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-YDBZ5DBBSP');
</script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">JMbayes2</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.5-91</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/JMbayes2.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/Baseline_Hazard.html">Baseline Hazard Function</a></li>
    <li><a class="dropdown-item" href="../articles/Causal_Effects.html">Causal Effects</a></li>
    <li><a class="dropdown-item" href="../articles/Competing_Risks.html">Competing Risks</a></li>
    <li><a class="dropdown-item" href="../articles/Dynamic_Predictions.html">Dynamic Predictions</a></li>
    <li><a class="dropdown-item" href="../articles/Multi_State_Processes.html">Multi-State Processes</a></li>
    <li><a class="dropdown-item" href="../articles/Non_Gaussian_Mixed_Models.html">Non-Gaussian Mixed Models</a></li>
    <li><a class="dropdown-item" href="../articles/Recurring_Events.html">Recurrent Events</a></li>
    <li><a class="dropdown-item" href="../articles/Super_Learning.html">Combined Dynamic Predictions via Super Learning</a></li>
    <li><a class="dropdown-item" href="../articles/Time_Varying_Effects.html">Time Varying Effects</a></li>
    <li><a class="dropdown-item" href="../articles/Transformation_Functions.html">Transformation Functions for Functional Forms</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/drizopoulos/JMbayes2/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Dynamic Predictions</h1>
                        <h4 data-toc-skip class="author">Dimitris
Rizopoulos</h4>
            
            <h4 data-toc-skip class="date">2025-08-21</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/drizopoulos/JMbayes2/blob/HEAD/vignettes/Dynamic_Predictions.Rmd" class="external-link"><code>vignettes/Dynamic_Predictions.Rmd</code></a></small>
      <div class="d-none name"><code>Dynamic_Predictions.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="dynamic-predictions">Dynamic Predictions<a class="anchor" aria-label="anchor" href="#dynamic-predictions"></a>
</h2>
<div class="section level3">
<h3 id="theory">Theory<a class="anchor" aria-label="anchor" href="#theory"></a>
</h3>
<p>Based on the general framework of joint models presented earlier, we
are interested in deriving cumulative risk probabilities for a new
subject <span class="math inline">j</span> that has survived up to time
point <span class="math inline">t</span> and has provided longitudinal
measurements <span class="math inline">\mathcal Y_{kj}(t) = \{
y_{kj}(t_{jl}); 0 \leq t_{jl} \leq t, l = 1, \ldots, n_j, k = 1, \ldots,
K\}</span>, with <span class="math inline">K</span> denoting the number
of longitudinal outcomes. The probabilities of interest are <span class="math display">\begin{array}{l}
\pi_j(u \mid t) = \mbox{Pr}\{T_j^* \leq u \mid T_j^* &gt; t, \mathcal
Y_j(t), \mathcal D_n\}\\\\
= \displaystyle 1 - \int\int \frac{S(u \mid b_j, \theta)}{S(t \mid b_j,
\theta)} \; p\{b_j \mid T_j^* &gt; t, \mathcal Y_j(t), \theta\} \;
p(\theta \mid \mathcal D_n) \; db_j d\theta,
\end{array}</span> where <span class="math inline">S(\cdot)</span>
denotes the survival function conditional on the random effects and
<span class="math inline">\mathcal Y_j(t) = \{\mathcal Y_{1j}(t),
\ldots, \mathcal Y_{Kj}(t)\}</span>. Combining the three terms in the
integrand, we can devise a Monte Carlo scheme to obtain estimates of
these probabilities, namely,</p>
<ol style="list-style-type: decimal">
<li><p>Sample a value <span class="math inline">\tilde \theta</span>
from the posterior of the parameters <span class="math inline">[\theta
\mid \mathcal D_n]</span>.</p></li>
<li><p>Sample a value <span class="math inline">\tilde b_j</span> from
the posterior of the random effects <span class="math inline">[b_j \mid
T_j^* &gt; t, \mathcal Y_j(t), \tilde \theta]</span>.</p></li>
<li><p>Compute the ratio of survival probabilities <span class="math inline">S(u \mid \tilde b_j,
\tilde \theta) \Big / S(t \mid \tilde b_j, \tilde
\theta)</span>.</p></li>
</ol>
<p>Replicating these steps <span class="math inline">L</span> times, we
can estimate the conditional cumulative risk probabilities by <span class="math display">1 - \frac{1}{L} \sum_{l=1}^L \frac{S(u \mid \tilde
b_j^{(l)},
\tilde \theta^{(l)})}{S(t \mid \tilde b_j^{(l)},
\tilde \theta^{(l)})},</span> and their standard error by calculating
the standard deviation across the Monte Carlo samples.</p>
</div>
<div class="section level3">
<h3 id="example">Example<a class="anchor" aria-label="anchor" href="#example"></a>
</h3>
<p>We will illustrate the calculation of dynamic predictions using
package <strong>JMbayes2</strong> from a trivariate joint model fitted
to the PBC dataset for the longitudinal outcomes <code>serBilir</code>
(continuous), <code>prothrombin</code> time (continuous), and
<code>ascites</code> (dichotomous). We start by fitting the univariate
mixed models. For the two continuous outcomes, we allow for nonlinear
subject-specific time effects using natural cubic splines. For
<code>ascites</code>, we postulate linear subject-specific profiles for
the log odds. The code is:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fm1</span> <span class="op">&lt;-</span> <span class="fu">lme</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">serBilir</span><span class="op">)</span> <span class="op">~</span> <span class="fu">ns</span><span class="op">(</span><span class="va">year</span>, <span class="fl">3</span><span class="op">)</span> <span class="op">*</span> <span class="va">sex</span>, data <span class="op">=</span> <span class="va">pbc2</span>,</span>
<span>           random <span class="op">=</span> <span class="op">~</span> <span class="fu">ns</span><span class="op">(</span><span class="va">year</span>, <span class="fl">3</span><span class="op">)</span> <span class="op">|</span> <span class="va">id</span>, control <span class="op">=</span> <span class="fu">lmeControl</span><span class="op">(</span>opt <span class="op">=</span> <span class="st">'optim'</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fm2</span> <span class="op">&lt;-</span> <span class="fu">lme</span><span class="op">(</span><span class="va">prothrombin</span> <span class="op">~</span> <span class="fu">ns</span><span class="op">(</span><span class="va">year</span>, <span class="fl">2</span><span class="op">)</span> <span class="op">*</span> <span class="va">sex</span>, data <span class="op">=</span> <span class="va">pbc2</span>,</span>
<span>           random <span class="op">=</span> <span class="op">~</span> <span class="fu">ns</span><span class="op">(</span><span class="va">year</span>, <span class="fl">2</span><span class="op">)</span> <span class="op">|</span> <span class="va">id</span>, control <span class="op">=</span> <span class="fu">lmeControl</span><span class="op">(</span>opt <span class="op">=</span> <span class="st">'optim'</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fm3</span> <span class="op">&lt;-</span> <span class="fu">mixed_model</span><span class="op">(</span><span class="va">ascites</span> <span class="op">~</span> <span class="va">year</span> <span class="op">*</span> <span class="va">sex</span>, data <span class="op">=</span> <span class="va">pbc2</span>,</span>
<span>                   random <span class="op">=</span> <span class="op">~</span> <span class="va">year</span> <span class="op">|</span> <span class="va">id</span>, family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">binomial</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Following, we fit the Cox model for the time to either
transplantation or death. The first line defines the composite event
indicator, and the second one fits the Cox model in which we have also
included the baseline covariates <code>drug</code> and <code>age</code>.
The code is:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pbc2.id</span><span class="op">$</span><span class="va">event</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">pbc2.id</span><span class="op">$</span><span class="va">status</span> <span class="op">!=</span> <span class="st">"alive"</span><span class="op">)</span></span>
<span><span class="va">CoxFit</span> <span class="op">&lt;-</span> <span class="fu">coxph</span><span class="op">(</span><span class="fu">Surv</span><span class="op">(</span><span class="va">years</span>, <span class="va">event</span><span class="op">)</span> <span class="op">~</span> <span class="va">drug</span> <span class="op">+</span> <span class="va">age</span>, data <span class="op">=</span> <span class="va">pbc2.id</span><span class="op">)</span></span></code></pre></div>
<p>The joint model is fitted with the following call to
<code><a href="../reference/jm.html">jm()</a></code>:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">jointFit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/jm.html">jm</a></span><span class="op">(</span><span class="va">CoxFit</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">fm1</span>, <span class="va">fm2</span>, <span class="va">fm3</span><span class="op">)</span>, time_var <span class="op">=</span> <span class="st">"year"</span><span class="op">)</span></span></code></pre></div>
<p>We want to calculate predictions for the longitudinal and survival
outcomes for Patients 25 and 93. As a first step, we extract the data of
these patients and store them in the data.frame <code>ND</code> with the
code:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">t0</span> <span class="op">&lt;-</span> <span class="fl">5</span></span>
<span><span class="va">ND</span> <span class="op">&lt;-</span> <span class="va">pbc2</span><span class="op">[</span><span class="va">pbc2</span><span class="op">$</span><span class="va">id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">25</span>, <span class="fl">93</span><span class="op">)</span>, <span class="op">]</span></span>
<span><span class="va">ND</span> <span class="op">&lt;-</span> <span class="va">ND</span><span class="op">[</span><span class="va">ND</span><span class="op">$</span><span class="va">year</span> <span class="op">&lt;</span> <span class="va">t0</span>, <span class="op">]</span></span>
<span><span class="va">ND</span><span class="op">$</span><span class="va">event</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="va">ND</span><span class="op">$</span><span class="va">years</span> <span class="op">&lt;-</span> <span class="va">t0</span></span></code></pre></div>
<p>We will only use the first five years of follow-up (line three) and
specify that the patients were event-free up to this point (lines four
and five).</p>
<p>We start with predictions for the longitudinal outcomes. These are
produced by the <code><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict()</a></code> method for class <code>jm</code>
objects and follow the same lines as the procedure described above for
cumulative risk probabilities. The only difference is in Step 3, where
instead of calculating the cumulative risk, we calculate the predicted
values for the longitudinal outcomes. There are two options controlled
by the <code>type_pred</code> argument, namely predictions at the scale
of the response/outcome (default) or at the linear predictor level. The
<code>type</code> argument controls whether the predictions will be for
the mean subject (i.e., including only the fixed effects) or
subject-specific, including both the fixed and random effects. In the
<code>newdata</code> argument we provide the available measurements of
the two patients. This will be used to sample their random effects in
Step 2, presented above. This is done with a Metropolis-Hastings
algorithm that runs for <code>n_mcmc</code> iterations; all iterations
but the last one are discarded as burn-in. Finally, argument
<code>n_samples</code> corresponds to the value of <span class="math inline">L</span> defined above and specifies the number of
Monte Carlo samples:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">predLong1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">jointFit</span>, newdata <span class="op">=</span> <span class="va">ND</span>, return_newdata <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>Argument <code>return_newdata</code> specifies that the predictions
are returned as extra columns of the <code>newdata</code> data.frame. By
default, the 95% credible intervals are also included. Using the
<code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code> method for objects returned by
<code>predict.jm(..., return_newdata = TRUE)</code>, we can display the
predictions. With the following code, we do that for the first
longitudinal outcome:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">predLong1</span><span class="op">)</span></span></code></pre></div>
<p><img src="Dynamic_Predictions_files/figure-html/unnamed-chunk-6-1.png" width="816" style="display: block; margin: auto;"></p>
<p>When we want to calculate predictions for other future time points,
we can accordingly specify the <code>times</code> argument. In the
following example, we calculate predictions from time <code>t0</code> to
time 12:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">predLong2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">jointFit</span>, newdata <span class="op">=</span> <span class="va">ND</span>,</span>
<span>                     times <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="va">t0</span>, <span class="fl">12</span>, length.out <span class="op">=</span> <span class="fl">51</span><span class="op">)</span>,</span>
<span>                     return_newdata <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>We show these predictions for the second outcome and the second
patient (i.e., Patient 93). This is achieved by suitably specifying the
<code>outcomes</code> and <code>subject</code> arguments of the
<code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code> method:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">predLong2</span>, outcomes <span class="op">=</span> <span class="fl">2</span>, subject <span class="op">=</span> <span class="fl">93</span><span class="op">)</span></span></code></pre></div>
<p><img src="Dynamic_Predictions_files/figure-html/unnamed-chunk-8-1.png" width="816" style="display: block; margin: auto;"></p>
<p>We continue with the predictions for the event outcome. To let
<code><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict()</a></code> know that we want the cumulative risk
probabilities, we specify <code>process = "event"</code>:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">predSurv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">jointFit</span>, newdata <span class="op">=</span> <span class="va">ND</span>, process <span class="op">=</span> <span class="st">"event"</span>,</span>
<span>                    times <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="va">t0</span>, <span class="fl">12</span>, length.out <span class="op">=</span> <span class="fl">51</span><span class="op">)</span>,</span>
<span>                    return_newdata <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>The predictions are included again as extra columns in the
corresponding data.frame. To depict the predictions of both the
longitudinal and survival outcomes combined, we provide both objects to
the <code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code> method:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">predLong2</span>, <span class="va">predSurv</span><span class="op">)</span></span></code></pre></div>
<p><img src="Dynamic_Predictions_files/figure-html/unnamed-chunk-10-1.png" width="816" style="display: block; margin: auto;"></p>
<p>Again, by default, the plot is for the predictions of the first
subject (i.e., Patient 25) and the first longitudinal outcome (i.e.,
<code>log(serBilir)</code>). However, the <code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code> method has
a series of arguments that allow users to customize the plot. We
illustrate some of these capabilities with the following figure. First,
we specify that we want to depict all three outcomes using
<code>outcomes = 1:3</code> (note: a max of three outcomes can be
simultaneously displayed). Next, we specify via the <code>subject</code>
argument that we want to show the predictions of Patient 93. Note that
for serum bilirubin, we used the log transformation in the specification
of the linear mixed model. Hence, we receive predictions on the
transformed scale. To show predictions on the original scale, we use the
<code>fun_long</code> argument. Because we have three outcomes, this
needs to be a list of three functions. The first one, corresponding to
serum bilirubin, is the <code><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp()</a></code>, and for the other two the
<code><a href="https://rdrr.io/r/base/identity.html" class="external-link">identity()</a></code> because we do not wish to transform the
predictions. Analogously, we also have the <code>fun_event</code>
argument to transform the predictions for the event outcome, and in the
example below, we set the goal of obtaining survival probabilities.
Using the arguments <code>bg</code>, <code>col_points</code>,
<code>col_line_long</code>, <code>col_line_event</code>,
<code>fill_CI_long</code>, and <code>fill_CI_event</code>, we have
changed the appearance of the plot to a dark theme. Finally, the
<code>pos_ylab_long</code> specifies the relative positive of the y-axis
labels for the three longitudinal outcomes.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'#F25C78'</span>, <span class="st">'#D973B5'</span>, <span class="st">'#F28322'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">predLong2</span>, <span class="va">predSurv</span>, outcomes <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, subject <span class="op">=</span> <span class="fl">93</span>,</span>
<span>     fun_long <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">exp</span>, <span class="va">identity</span>, <span class="va">identity</span><span class="op">)</span>,</span>
<span>     fun_event <span class="op">=</span> <span class="kw">function</span> <span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fl">1</span> <span class="op">-</span> <span class="va">x</span>,</span>
<span>     ylab_event <span class="op">=</span> <span class="st">"Survival Probabilities"</span>,</span>
<span>     ylab_long <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Serum Bilirubin"</span>, <span class="st">"Prothrombin"</span>, <span class="st">"Ascites"</span><span class="op">)</span>,</span>
<span>     bg <span class="op">=</span> <span class="st">'#132743'</span>, col_points <span class="op">=</span> <span class="va">cols</span>, col_line_long <span class="op">=</span> <span class="va">cols</span>,</span>
<span>     col_line_event <span class="op">=</span> <span class="st">'#F7F7FF'</span>, col_axis <span class="op">=</span> <span class="st">"white"</span>, </span>
<span>     fill_CI_long <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#F25C7880"</span>, <span class="st">"#D973B580"</span>, <span class="st">"#F2832280"</span><span class="op">)</span>,</span>
<span>     fill_CI_event <span class="op">=</span> <span class="st">"#F7F7FF80"</span>,</span>
<span>     pos_ylab_long <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1.9</span>, <span class="fl">1.9</span>, <span class="fl">0.08</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="Dynamic_Predictions_files/figure-html/unnamed-chunk-12-1.png" width="816" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="predictive-accuracy">Predictive accuracy<a class="anchor" aria-label="anchor" href="#predictive-accuracy"></a>
</h3>
<p>We evaluate the discriminative capability of the model using ROC
methodology. We calculate the components of the ROC curve using
information up to year five, and we are interested in events occurring
within a three-year window. That is discriminating between patients who
will get the event in the interval <code>(t0, t0 + Dt]</code>, (i.e., in
our case <span class="math inline">T_j \in (5, 8]</span>) from patients
who will survive at least 8 years (i.e., <span class="math inline">T_j
&gt; 8</span>). The calculations are performed with the following call
to <code><a href="../reference/accuracy.html">tvROC()</a></code>:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pbc2</span><span class="op">$</span><span class="va">event</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">pbc2</span><span class="op">$</span><span class="va">status</span> <span class="op">!=</span> <span class="st">"alive"</span><span class="op">)</span></span>
<span><span class="va">roc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/accuracy.html">tvROC</a></span><span class="op">(</span><span class="va">jointFit</span>, newdata <span class="op">=</span> <span class="va">pbc2</span>, Tstart <span class="op">=</span> <span class="va">t0</span>, Dt <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">roc</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Time-dependent Sensitivity and Specificity for the Joint Model jointFit</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; At time: 8</span></span>
<span><span class="co">#&gt; Using information up to time: 5 (202 subjects still at risk)</span></span>
<span><span class="co">#&gt; Accounting for censoring using model-based weights</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;    cut-off      SN      SP  </span></span>
<span><span class="co">#&gt; 1     0.00 0.00000 1.00000  </span></span>
<span><span class="co">#&gt; 2     0.03 0.01513 0.99812  </span></span>
<span><span class="co">#&gt; 3     0.08 0.03648 0.99812  </span></span>
<span><span class="co">#&gt; 4     0.09 0.03648 0.99168  </span></span>
<span><span class="co">#&gt; 5     0.11 0.10052 0.99168  </span></span>
<span><span class="co">#&gt; 6     0.12 0.11871 0.99072  </span></span>
<span><span class="co">#&gt; 7     0.13 0.11871 0.98428  </span></span>
<span><span class="co">#&gt; 8     0.14 0.11871 0.97783  </span></span>
<span><span class="co">#&gt; 9     0.16 0.15223 0.97506  </span></span>
<span><span class="co">#&gt; 10    0.18 0.17358 0.97506  </span></span>
<span><span class="co">#&gt; 11    0.20 0.21628 0.97506  </span></span>
<span><span class="co">#&gt; 12    0.21 0.23763 0.97506  </span></span>
<span><span class="co">#&gt; 13    0.25 0.25898 0.97506  </span></span>
<span><span class="co">#&gt; 14    0.27 0.28033 0.97506  </span></span>
<span><span class="co">#&gt; 15    0.30 0.32303 0.97506  </span></span>
<span><span class="co">#&gt; 16    0.31 0.34438 0.96862  </span></span>
<span><span class="co">#&gt; 17    0.33 0.37464 0.96486  </span></span>
<span><span class="co">#&gt; 18    0.36 0.41734 0.95842  </span></span>
<span><span class="co">#&gt; 19    0.37 0.41842 0.95230  </span></span>
<span><span class="co">#&gt; 20    0.40 0.43977 0.95230  </span></span>
<span><span class="co">#&gt; 21    0.44 0.47216 0.94919  </span></span>
<span><span class="co">#&gt; 22    0.46 0.49351 0.94919  </span></span>
<span><span class="co">#&gt; 23    0.48 0.53621 0.94919  </span></span>
<span><span class="co">#&gt; 24    0.52 0.53621 0.94274  </span></span>
<span><span class="co">#&gt; 25    0.53 0.53621 0.93630  </span></span>
<span><span class="co">#&gt; 26    0.55 0.53621 0.92985  </span></span>
<span><span class="co">#&gt; 27    0.56 0.57891 0.92985  </span></span>
<span><span class="co">#&gt; 28    0.58 0.60026 0.92985  </span></span>
<span><span class="co">#&gt; 29    0.65 0.60026 0.92341  </span></span>
<span><span class="co">#&gt; 30    0.66 0.62161 0.92341 *</span></span>
<span><span class="co">#&gt; 31    0.67 0.62429 0.91133  </span></span>
<span><span class="co">#&gt; 32    0.68 0.62429 0.90488  </span></span>
<span><span class="co">#&gt; 33    0.69 0.62466 0.89855  </span></span>
<span><span class="co">#&gt; 34    0.70 0.62466 0.89210  </span></span>
<span><span class="co">#&gt; 35    0.71 0.65737 0.86975  </span></span>
<span><span class="co">#&gt; 36    0.72 0.66079 0.85145  </span></span>
<span><span class="co">#&gt; 37    0.73 0.68214 0.84500  </span></span>
<span><span class="co">#&gt; 38    0.74 0.68625 0.83980  </span></span>
<span><span class="co">#&gt; 39    0.75 0.68827 0.82108  </span></span>
<span><span class="co">#&gt; 40    0.76 0.69335 0.80327  </span></span>
<span><span class="co">#&gt; 41    0.78 0.71470 0.78394  </span></span>
<span><span class="co">#&gt; 42    0.79 0.71976 0.77258  </span></span>
<span><span class="co">#&gt; 43    0.80 0.72024 0.76628  </span></span>
<span><span class="co">#&gt; 44    0.82 0.72769 0.74919  </span></span>
<span><span class="co">#&gt; 45    0.83 0.72996 0.73699  </span></span>
<span><span class="co">#&gt; 46    0.84 0.75692 0.71935  </span></span>
<span><span class="co">#&gt; 47    0.85 0.77904 0.70025  </span></span>
<span><span class="co">#&gt; 48    0.86 0.80261 0.68802  </span></span>
<span><span class="co">#&gt; 49    0.87 0.80679 0.66995  </span></span>
<span><span class="co">#&gt; 50    0.88 0.80679 0.66351  </span></span>
<span><span class="co">#&gt; 51    0.89 0.83360 0.63937  </span></span>
<span><span class="co">#&gt; 52    0.90 0.85677 0.60770  </span></span>
<span><span class="co">#&gt; 53    0.91 0.86058 0.55729  </span></span>
<span><span class="co">#&gt; 54    0.92 0.88370 0.52560  </span></span>
<span><span class="co">#&gt; 55    0.93 0.88683 0.42987  </span></span>
<span><span class="co">#&gt; 56    0.94 0.92953 0.40409  </span></span>
<span><span class="co">#&gt; 57    0.95 0.95217 0.32714  </span></span>
<span><span class="co">#&gt; 58    0.96 0.97586 0.24407  </span></span>
<span><span class="co">#&gt; 59    0.97 0.97829 0.15457  </span></span>
<span><span class="co">#&gt; 60    0.98 0.97829 0.09656  </span></span>
<span><span class="co">#&gt; 61    0.99 0.99989 0.01286  </span></span>
<span><span class="co">#&gt; 62    1.00 1.00000 0.00000</span></span></code></pre></div>
<p>In the first line we define the event indicator as we did in the
<code>pbc2.id</code> data.frame. The cut-point with the asterisk on the
right maximizes the <a href="https://en.wikipedia.org/wiki/Youden%27s_J_statistic" class="external-link">Youden’s
index</a>. To depict the ROC curve, we use the corresponding
<code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code> method:
<img src="Dynamic_Predictions_files/figure-html/unnamed-chunk-14-1.png" width="816" style="display: block; margin: auto;"></p>
<p>The area under the ROC curve is calculated with the
<code><a href="../reference/accuracy.html">tvAUC()</a></code> function:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/accuracy.html">tvAUC</a></span><span class="op">(</span><span class="va">roc</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Time-dependent AUC for the Joint Model jointFit</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Estimated AUC:  0.8282</span></span>
<span><span class="co">#&gt; At time: 8</span></span>
<span><span class="co">#&gt; Using information up to time: 5 (202 subjects still at risk)</span></span>
<span><span class="co">#&gt; Accounting for censoring using model-based weights</span></span></code></pre></div>
<p>This function either accepts an object of class <code>tvROC</code> or
of class <code>jm</code>. In the latter case, the user must also provide
the <code>newdata</code>, <code>Tstart</code> and <code>Dt</code> or
<code>Thoriz</code> arguments. Here we have used the same dataset as the
one to fit the model, but, in principle, discrimination could be
(better) assessed in another dataset.</p>
<p>The <code><a href="../reference/accuracy.html">tvROC()</a></code> and <code><a href="../reference/accuracy.html">tvAUC()</a></code> functions also work
for Cox regression models for right censored data. We compare the added
value of using the longitudinal data compared to only using the baseline
value of the markers,</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">baseline_Cox</span> <span class="op">&lt;-</span> <span class="fu">coxph</span><span class="op">(</span><span class="fu">Surv</span><span class="op">(</span><span class="va">years</span>, <span class="va">event</span><span class="op">)</span> <span class="op">~</span> <span class="va">drug</span> <span class="op">+</span> <span class="va">age</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">serBilir</span><span class="op">)</span> <span class="op">+</span> </span>
<span>                          <span class="va">prothrombin</span> <span class="op">+</span> <span class="va">ascites</span>, data <span class="op">=</span> <span class="va">pbc2.id</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/accuracy.html">tvAUC</a></span><span class="op">(</span><span class="va">baseline_Cox</span>, newdata <span class="op">=</span> <span class="va">pbc2.id</span>, Tstart <span class="op">=</span> <span class="va">t0</span>, Dt <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Time-dependent AUC for the Cox Model baseline_Cox</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Estimated AUC:  0.6736</span></span>
<span><span class="co">#&gt; At time: 8</span></span>
<span><span class="co">#&gt; Using information up to time: 5 (202 subjects still at risk)</span></span>
<span><span class="co">#&gt; Accounting for censoring using model-based weights</span></span></code></pre></div>
<p>To assess the accuracy of the predictions, we produce a calibration
plot:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/accuracy.html">calibration_plot</a></span><span class="op">(</span><span class="va">jointFit</span>, newdata <span class="op">=</span> <span class="va">pbc2</span>, Tstart <span class="op">=</span> <span class="va">t0</span>, Dt <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p><img src="Dynamic_Predictions_files/figure-html/unnamed-chunk-17-1.png" width="816" style="display: block; margin: auto;"></p>
<p>The syntax of the <code><a href="../reference/accuracy.html">calibration_plot()</a></code> function is almost
identical to that of <code><a href="../reference/accuracy.html">tvROC()</a></code>. The kernel density estimation
is of the estimated probabilities <span class="math inline">\pi_j(t +
\Delta t \mid t) = \pi_j(8 \mid 5)</span> for all individuals at risk at
year <code>t0</code> in the data frame provided in the
<code>newdata</code> argument. The grey shaded area represents the 95%
pointwise confidence intervals of the predicted cumulative risks
probabilities. Using the <code><a href="../reference/accuracy.html">calibration_metrics()</a></code> function we
can also calculate metrics for the accuracy of predictions:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/accuracy.html">calibration_metrics</a></span><span class="op">(</span><span class="va">jointFit</span>, <span class="va">pbc2</span>, Tstart <span class="op">=</span> <span class="fl">5</span>, Dt <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#&gt;        ICI        E50        E90 </span></span>
<span><span class="co">#&gt; 0.02984699 0.02453557 0.05820965</span></span></code></pre></div>
<p>The ICI is the mean absolute difference between the observed and
predicted probabilities, E50 is the median absolute difference, and E90
is the 90% percentile of the absolute differences. Finally, we calculate
the Brier score as an overall measure of predictive performance. This is
computed with the <code><a href="../reference/accuracy.html">tvBrier()</a></code> function:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/accuracy.html">tvBrier</a></span><span class="op">(</span><span class="va">jointFit</span>, newdata <span class="op">=</span> <span class="va">pbc2</span>, Tstart <span class="op">=</span> <span class="va">t0</span>, Dt <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Prediction Error for the Joint Model 'jointFit'</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Estimated Brier score: 0.1242</span></span>
<span><span class="co">#&gt; At time: 8</span></span>
<span><span class="co">#&gt; For the 202 subjects at risk at time 5</span></span>
<span><span class="co">#&gt; Number of subjects with an event in [5, 8): 40</span></span>
<span><span class="co">#&gt; Number of subjects with a censored time in [5, 8): 58</span></span>
<span><span class="co">#&gt; Accounting for censoring using model-based weights</span></span></code></pre></div>
<p>The Brier score evaluates the predictive accuracy at time
<code>Tstart + Dt</code>. To summarize the predictive accuracy in the
interval <code>(t0, t0 + Dt]</code> we can use the integrated Brier
score. The corresponding integral is approximated using the Simpson’s
rule:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/accuracy.html">tvBrier</a></span><span class="op">(</span><span class="va">jointFit</span>, newdata <span class="op">=</span> <span class="va">pbc2</span>, Tstart <span class="op">=</span> <span class="va">t0</span>, Dt <span class="op">=</span> <span class="fl">3</span>, integrated <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Prediction Error for the Joint Model 'jointFit'</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Estimated Integrated Brier score: 0.0829</span></span>
<span><span class="co">#&gt; In the time interval: [5, 8)</span></span>
<span><span class="co">#&gt; For the 202 subjects at risk at time 5</span></span>
<span><span class="co">#&gt; Number of subjects with an event in [5, 8): 40</span></span>
<span><span class="co">#&gt; Number of subjects with a censored time in [5, 8): 58</span></span>
<span><span class="co">#&gt; Accounting for censoring using model-based weights</span></span></code></pre></div>
<p>Function <code><a href="../reference/accuracy.html">tvBrier()</a></code> also works for Cox models, e.g.,</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/accuracy.html">tvBrier</a></span><span class="op">(</span><span class="va">baseline_Cox</span>, newdata <span class="op">=</span> <span class="va">pbc2.id</span>, Tstart <span class="op">=</span> <span class="va">t0</span>, Dt <span class="op">=</span> <span class="fl">3</span>, integrated <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Prediction Error for the Cox Model 'baseline_Cox'</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Estimated Integrated Brier score: 0.1163</span></span>
<span><span class="co">#&gt; In the time interval: [5, 8)</span></span>
<span><span class="co">#&gt; For the 202 subjects at risk at time 5</span></span>
<span><span class="co">#&gt; Number of subjects with an event in [5, 8): 40</span></span>
<span><span class="co">#&gt; Number of subjects with a censored time in [5, 8): 58</span></span>
<span><span class="co">#&gt; Accounting for censoring using model-based weights</span></span></code></pre></div>
<p>The <code><a href="../reference/accuracy.html">tvBrier()</a></code> and <code><a href="../reference/accuracy.html">tvROC()</a></code> also implement
inverse probability of censoring weights to account for censoring in the
interval <code>(t0, t0 + Dt]</code> using the Kaplan-Meier estimate of
the censoring distribution (however, see the note below):</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/accuracy.html">tvBrier</a></span><span class="op">(</span><span class="va">jointFit</span>, newdata <span class="op">=</span> <span class="va">pbc2</span>, Tstart <span class="op">=</span> <span class="va">t0</span>, Dt <span class="op">=</span> <span class="fl">3</span>, integrated <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>        type_weights <span class="op">=</span> <span class="st">"IPCW"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Prediction Error for the Joint Model 'jointFit'</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Estimated Integrated Brier score: 0.0841</span></span>
<span><span class="co">#&gt; In the time interval: [5, 8)</span></span>
<span><span class="co">#&gt; For the 202 subjects at risk at time 5</span></span>
<span><span class="co">#&gt; Number of subjects with an event in [5, 8): 40</span></span>
<span><span class="co">#&gt; Number of subjects with a censored time in [5, 8): 58</span></span>
<span><span class="co">#&gt; Accounting for censoring using inverse probability of censoring Kaplan-Meier weights</span></span></code></pre></div>
<p><strong>Notes:</strong></p>
<ul>
<li>To obtain valid estimates of the predictive accuracy measures (i.e.,
time-varying sensitivity, specificity, and Brier score) we need to
account for censoring. A popular method to achieve this is via the
inverse probability of censoring weighting. For this approach to be
valid, we need the model for the weights to be correctly specified. In
standard survival analysis, this is achieved either using the
Kaplan-Meier estimator or a Cox model for the censoring distribution.
However, in the settings where joint models are used, it is often the
case that the censoring mechanism may depend on the history of the
longitudinal outcomes in a complex manner. This is especially the case
when we consider multiple longitudinal outcomes in the analysis. Also,
these outcomes may be recorded at different time points per patient and
have missing data. Because of these reasons, in these settings,
Kaplan-Meier-based or Cox-based censoring weights may be difficult to
derive or be biased. The functions in <strong>JMbayes2</strong> that
calculate the predictive accuracy measures use joint-model-based weights
to account for censoring. These weights allow censoring to depend in any
possible manner on the history of the longitudinal outcomes. However,
they require that the model is appropriately calibrated.</li>
<li>The calibration curve, produced by <code><a href="../reference/accuracy.html">calibration_plot()</a></code>,
and the calibration metrics, produced by
<code>calibration_metrics())</code>, are calculated using the procedure
described in <a href="https://doi.org/10.1002/sim.8570" class="external-link">Austin et al.,
2020</a>.</li>
</ul>
</div>
<div class="section level3">
<h3 id="internal-validation">Internal Validation<a class="anchor" aria-label="anchor" href="#internal-validation"></a>
</h3>
<div class="section level4">
<h4 id="cross-validation">Cross-Validation<a class="anchor" aria-label="anchor" href="#cross-validation"></a>
</h4>
<p>In calculating the predictive accuracy measures presented above, we
used the same dataset in which we fitted the models. This is known to
produce overoptimistic accuracy estimates. More objective estimates can
be obtained using internal validation. This section illustrates how
internal validation can be performed in <strong>JMbayes2</strong> using
cross-validation and the Bootstrap methods.</p>
<p>Both testing and training datasets for both techniques can be created
using the <code><a href="../reference/accuracy.html">create_folds()</a></code> function. We start with
cross-validation and split the <code>pbc2</code> database into five
folds using the syntax:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">CVdats</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/accuracy.html">create_folds</a></span><span class="op">(</span><span class="va">pbc2</span>, V <span class="op">=</span> <span class="fl">5</span>, id_var <span class="op">=</span> <span class="st">"id"</span><span class="op">)</span></span></code></pre></div>
<p>The first argument for this function is the <code>data.frame</code>
we wish to split into <code>V</code> folds. The argument
<code>id_var</code> specifies the name of the subject’s id variable in
this dataset. The output of <code><a href="../reference/accuracy.html">create_folds()</a></code> is a list with
two components named <code>"training"</code> and <code>"testing"</code>.
Each component is another list with <code>V</code> data.frames.</p>
<p>Next, we define the function that will fit the joint models we wish
to consider for calculating predictions. This function should have as a
single argument a <code>data.frame</code> that will be used to fit the
joint models. We will use parallel computing to optimize computational
performance and fit these models to the different training datasets.
Hence, within the function we should have the call
<code><a href="https://drizopoulos.github.io/JMbayes2/">library("JMbayes2")</a></code> to load package
<strong>JMbayes2</strong> for each worker. The output of this function
is the fitted joint model we wish to internally validate.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_model</span> <span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://drizopoulos.github.io/JMbayes2/">"JMbayes2"</a></span><span class="op">)</span></span>
<span>    <span class="co"># data</span></span>
<span>    <span class="va">data</span><span class="op">$</span><span class="va">event</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">status</span> <span class="op">!=</span> <span class="st">"alive"</span><span class="op">)</span></span>
<span>    <span class="va">data_id</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/duplicated.html" class="external-link">duplicated</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">id</span><span class="op">)</span>, <span class="op">]</span></span>
<span>    <span class="co"># mixed-effects models</span></span>
<span>    <span class="va">fm1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nlme/man/lme.html" class="external-link">lme</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">serBilir</span><span class="op">)</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/splines/ns.html" class="external-link">ns</a></span><span class="op">(</span><span class="va">year</span>, <span class="fl">3</span><span class="op">)</span> <span class="op">*</span> <span class="va">sex</span>, data <span class="op">=</span> <span class="va">data</span>,</span>
<span>               random <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/nlme/man/pdDiag.html" class="external-link">pdDiag</a></span><span class="op">(</span>form <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/splines/ns.html" class="external-link">ns</a></span><span class="op">(</span><span class="va">year</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, </span>
<span>               control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/nlme/man/lmeControl.html" class="external-link">lmeControl</a></span><span class="op">(</span>opt <span class="op">=</span> <span class="st">'optim'</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">fm2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nlme/man/lme.html" class="external-link">lme</a></span><span class="op">(</span><span class="va">prothrombin</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/splines/ns.html" class="external-link">ns</a></span><span class="op">(</span><span class="va">year</span>, <span class="fl">2</span><span class="op">)</span> <span class="op">*</span> <span class="va">sex</span>, data <span class="op">=</span> <span class="va">data</span>,</span>
<span>               random <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/nlme/man/pdDiag.html" class="external-link">pdDiag</a></span><span class="op">(</span>form <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/splines/ns.html" class="external-link">ns</a></span><span class="op">(</span><span class="va">year</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, </span>
<span>               control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/nlme/man/lmeControl.html" class="external-link">lmeControl</a></span><span class="op">(</span>opt <span class="op">=</span> <span class="st">'optim'</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">fm3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://drizopoulos.github.io/GLMMadaptive/reference/mixed_model.html" class="external-link">mixed_model</a></span><span class="op">(</span><span class="va">ascites</span> <span class="op">~</span> <span class="va">year</span> <span class="op">*</span> <span class="va">sex</span>, data <span class="op">=</span> <span class="va">data</span>,</span>
<span>                       random <span class="op">=</span> <span class="op">~</span> <span class="va">year</span> <span class="op">|</span> <span class="va">id</span>, family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">binomial</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="co"># Cox model</span></span>
<span>    <span class="va">CoxFit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html" class="external-link">coxph</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">years</span>, <span class="va">event</span><span class="op">)</span> <span class="op">~</span> <span class="va">drug</span> <span class="op">+</span> <span class="va">age</span>, data <span class="op">=</span> <span class="va">data_id</span><span class="op">)</span></span>
<span>    <span class="co"># joint model</span></span>
<span>    <span class="fu"><a href="../reference/jm.html">jm</a></span><span class="op">(</span><span class="va">CoxFit</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">fm1</span>, <span class="va">fm2</span>, <span class="va">fm3</span><span class="op">)</span>, time_var <span class="op">=</span> <span class="st">"year"</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>We fit the model in the training datasets using parallel computing as
facilitated by the <strong>parallel</strong> package (<em>note</em>:
this and the subsequent computations require some time to perform
depending on the capabilities of your computing environment):</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">makeCluster</a></span><span class="op">(</span><span class="fl">5L</span><span class="op">)</span></span>
<span><span class="va">Model_folds</span> <span class="op">&lt;-</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/clusterApply.html" class="external-link">parLapply</a></span><span class="op">(</span><span class="va">cl</span>, <span class="va">CVdats</span><span class="op">$</span><span class="va">training</span>, <span class="va">fit_model</span><span class="op">)</span></span>
<span><span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">stopCluster</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span></span></code></pre></div>
<p>Before calculating the predictive accuracy measures in the testing
datasets, we must create the <code>event</code> variable in each one.
This is achieved with the following piece of code:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">CVdats</span><span class="op">$</span><span class="va">testing</span><span class="op">[</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">CVdats</span><span class="op">$</span><span class="va">testing</span>, <span class="kw">function</span> <span class="op">(</span><span class="va">d</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">d</span><span class="op">$</span><span class="va">event</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">d</span><span class="op">$</span><span class="va">status</span> <span class="op">!=</span> <span class="st">"alive"</span><span class="op">)</span></span>
<span>    <span class="va">d</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>The following syntax calculates the integrated Brier score in the
testing datasets at follow-up year <code>t0 = 5</code> and for a window
of <code>Dt = 3</code> years (we use parallel computing again):</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">calculate_Brier</span> <span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="va">v</span>, <span class="va">models</span>, <span class="va">testing_data</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://drizopoulos.github.io/JMbayes2/">"JMbayes2"</a></span><span class="op">)</span></span>
<span>    <span class="fu"><a href="../reference/accuracy.html">tvBrier</a></span><span class="op">(</span><span class="va">models</span><span class="op">[[</span><span class="va">v</span><span class="op">]</span><span class="op">]</span>, newdata <span class="op">=</span> <span class="va">testing_data</span><span class="op">[[</span><span class="va">v</span><span class="op">]</span><span class="op">]</span>, Tstart <span class="op">=</span> <span class="fl">5</span>, Dt <span class="op">=</span> <span class="fl">3</span>, </span>
<span>            integrated <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">makeCluster</a></span><span class="op">(</span><span class="fl">5L</span><span class="op">)</span></span>
<span><span class="va">Brier_per_fold</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/clusterApply.html" class="external-link">parLapply</a></span><span class="op">(</span><span class="va">cl</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span>, <span class="va">calculate_Brier</span>, models <span class="op">=</span> <span class="va">Model_folds</span>,</span>
<span>                        testing_data <span class="op">=</span> <span class="va">CVdats</span><span class="op">$</span><span class="va">testing</span><span class="op">)</span></span>
<span><span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">stopCluster</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span></span></code></pre></div>
<p>The cross-validated estimate of the integrated Brier score is the
average of the estimated Brier scores in the testing datasets:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">average_Brier</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">Brier_per_fold</span>, <span class="st">"[["</span>, <span class="st">"Brier"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">average_Brier</span></span>
<span><span class="co">#&gt; [1] 0.0862818</span></span></code></pre></div>
<p>The calculation of the cross-validated estimate of the AUC at
follow-up year 5 and for a window of 3 years proceeds similarly:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">calculate_AUC</span> <span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="va">v</span>, <span class="va">models</span>, <span class="va">testing_data</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://drizopoulos.github.io/JMbayes2/">"JMbayes2"</a></span><span class="op">)</span></span>
<span>    <span class="fu"><a href="../reference/accuracy.html">tvAUC</a></span><span class="op">(</span><span class="va">models</span><span class="op">[[</span><span class="va">v</span><span class="op">]</span><span class="op">]</span>, newdata <span class="op">=</span> <span class="va">testing_data</span><span class="op">[[</span><span class="va">v</span><span class="op">]</span><span class="op">]</span>, Tstart <span class="op">=</span> <span class="fl">5</span>, Dt <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">makeCluster</a></span><span class="op">(</span><span class="fl">5L</span><span class="op">)</span></span>
<span><span class="va">AUC_per_fold</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/clusterApply.html" class="external-link">parLapply</a></span><span class="op">(</span><span class="va">cl</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span>, <span class="va">calculate_AUC</span>, models <span class="op">=</span> <span class="va">Model_folds</span>,</span>
<span>                        testing_data <span class="op">=</span> <span class="va">CVdats</span><span class="op">$</span><span class="va">testing</span><span class="op">)</span></span>
<span><span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">stopCluster</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span></span>
<span></span>
<span><span class="va">average_AUC</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">AUC_per_fold</span>, <span class="st">"[["</span>, <span class="st">"auc"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">average_AUC</span></span>
<span><span class="co">#&gt; [1] 0.8183163</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="bootstrap">Bootstrap<a class="anchor" aria-label="anchor" href="#bootstrap"></a>
</h4>
<p>We continue the illustration of internal validation in
<strong>JMbayes2</strong> using the Bootstrap method. The training and
testing datasets are again created with the <code><a href="../reference/accuracy.html">create_folds()</a></code>
function by specifying <code>method = "Bootstrap"</code>:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bootDats</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/accuracy.html">create_folds</a></span><span class="op">(</span><span class="va">pbc2</span>, V <span class="op">=</span> <span class="fl">10</span>, id_var <span class="op">=</span> <span class="st">"id"</span>, method <span class="op">=</span> <span class="st">"Bootstrap"</span><span class="op">)</span></span></code></pre></div>
<p>Argument <code>V</code> now denotes the number of Bootstrap samples
we want to create. Each training Bootstrap sample is a sample with
replacement from the original dataset <code>pbc2</code>. The subjects
not used in the specific Bootstrap sample form the testing dataset. We
fit the joint model in the training datasets using parallel
computing:</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">makeCluster</a></span><span class="op">(</span><span class="fl">5L</span><span class="op">)</span></span>
<span><span class="va">Model_bootSamples</span> <span class="op">&lt;-</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/clusterApply.html" class="external-link">parLapply</a></span><span class="op">(</span><span class="va">cl</span>, <span class="va">bootDats</span><span class="op">$</span><span class="va">training</span>, <span class="va">fit_model</span><span class="op">)</span></span>
<span><span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">stopCluster</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span></span></code></pre></div>
<p>Before calculating the predictive accuracy measures in the testing
datasets, we must create again the <code>event</code> variable in each
one.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bootDats</span><span class="op">$</span><span class="va">testing</span><span class="op">[</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">bootDats</span><span class="op">$</span><span class="va">testing</span>, <span class="kw">function</span> <span class="op">(</span><span class="va">d</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">d</span><span class="op">$</span><span class="va">event</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">d</span><span class="op">$</span><span class="va">status</span> <span class="op">!=</span> <span class="st">"alive"</span><span class="op">)</span></span>
<span>    <span class="va">d</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>Following we calculate the integrated Brier score in each testing
dataset and compute the average:</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">makeCluster</a></span><span class="op">(</span><span class="fl">10L</span><span class="op">)</span></span>
<span><span class="va">Brier_per_bootSample</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/clusterApply.html" class="external-link">parLapply</a></span><span class="op">(</span><span class="va">cl</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>, <span class="va">calculate_Brier</span>, models <span class="op">=</span> <span class="va">Model_bootSamples</span>,</span>
<span>                        testing_data <span class="op">=</span> <span class="va">bootDats</span><span class="op">$</span><span class="va">testing</span><span class="op">)</span></span>
<span><span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">stopCluster</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span></span>
<span></span>
<span><span class="va">average_Brier_bootSamples</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">Brier_per_bootSample</span>, <span class="st">"[["</span>, <span class="st">"Brier"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The evaluation of the model’s predictive accuracy in the testing
datasets will produce a pessimistic estimate of model performance. On
the contrary, the estimate of the integrate Brier score in the
<code>pbc2</code> dataset used to fit the joint model will be highly
optimistic:</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">jointFit</span> <span class="op">&lt;-</span> <span class="fu">fit_model</span><span class="op">(</span><span class="va">pbc2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">Brier_original</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/accuracy.html">tvBrier</a></span><span class="op">(</span><span class="va">jointFit</span>, newdata <span class="op">=</span> <span class="va">pbc2</span>, Tstart <span class="op">=</span> <span class="va">t0</span>, Dt <span class="op">=</span> <span class="fl">3</span>, </span>
<span>                          integrated <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><a href="https://doi.org/10.1080/01621459.1997.10474007" class="external-link">Efron and
Tibshirani (1997)</a> proposed the .632 estimator, which combines the
performance obtained in the original dataset and the estimates from the
Bootstrap samples to reduce the upward bias:</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fl">0.368</span> <span class="op">*</span> <span class="va">Brier_original</span><span class="op">$</span><span class="va">Brier</span> <span class="op">+</span> <span class="fl">0.632</span> <span class="op">*</span> <span class="va">average_Brier_bootSamples</span></span>
<span><span class="co">#&gt; [1] 0.08199523</span></span></code></pre></div>
<p>We perform the same calculations also for the AUC:</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">makeCluster</a></span><span class="op">(</span><span class="fl">10L</span><span class="op">)</span></span>
<span><span class="va">AUC_per_bootSample</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/clusterApply.html" class="external-link">parLapply</a></span><span class="op">(</span><span class="va">cl</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>, <span class="va">calculate_AUC</span>, models <span class="op">=</span> <span class="va">Model_bootSamples</span>,</span>
<span>                        testing_data <span class="op">=</span> <span class="va">bootDats</span><span class="op">$</span><span class="va">testing</span><span class="op">)</span></span>
<span><span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">stopCluster</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span></span>
<span></span>
<span><span class="va">average_AUC_bootSamples</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">AUC_per_bootSample</span>, <span class="st">"[["</span>, <span class="st">"auc"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">AUC_original</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/accuracy.html">tvAUC</a></span><span class="op">(</span><span class="va">jointFit</span>, newdata <span class="op">=</span> <span class="va">pbc2</span>, Tstart <span class="op">=</span> <span class="va">t0</span>, Dt <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="fl">0.368</span> <span class="op">*</span> <span class="va">AUC_original</span><span class="op">$</span><span class="va">auc</span> <span class="op">+</span> <span class="fl">0.632</span> <span class="op">*</span> <span class="va">average_AUC_bootSamples</span></span>
<span><span class="co">#&gt; [1] 0.8165295</span></span></code></pre></div>
<p>A 95% confidence interval for the AUC in the original sample can be
derived by calculating the AUC in the Bootstrap training samples,
i.e.,</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bootDats</span><span class="op">$</span><span class="va">training</span><span class="op">[</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">bootDats</span><span class="op">$</span><span class="va">training</span>, <span class="kw">function</span> <span class="op">(</span><span class="va">d</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">d</span><span class="op">$</span><span class="va">event</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">d</span><span class="op">$</span><span class="va">status</span> <span class="op">!=</span> <span class="st">"alive"</span><span class="op">)</span></span>
<span>    <span class="va">d</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">makeCluster</a></span><span class="op">(</span><span class="fl">10L</span><span class="op">)</span></span>
<span><span class="va">AUC_per_bootSample_training</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/clusterApply.html" class="external-link">parLapply</a></span><span class="op">(</span><span class="va">cl</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>, <span class="va">calculate_AUC</span>, models <span class="op">=</span> <span class="va">Model_bootSamples</span>, </span>
<span>                        testing_data <span class="op">=</span> <span class="va">bootDats</span><span class="op">$</span><span class="va">training</span><span class="op">)</span></span>
<span><span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">stopCluster</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span></span>
<span><span class="va">AUC_per_bootSample_training</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">AUC_per_bootSample_training</span>, <span class="st">"[["</span>, <span class="st">"auc"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">AUC_original</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Time-dependent AUC for the Joint Model jointFit</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Estimated AUC:  0.8175</span></span>
<span><span class="co">#&gt; At time: 8</span></span>
<span><span class="co">#&gt; Using information up to time: 5 (202 subjects still at risk)</span></span>
<span><span class="co">#&gt; Accounting for censoring using model-based weights</span></span>
<span></span>
<span><span class="co"># 95% Bootstrap CI</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">AUC_per_bootSample_training</span>, probs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.025</span>, <span class="fl">0.975</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;      2.5%     97.5% </span></span>
<span><span class="co">#&gt; 0.7765123 0.8436562</span></span></code></pre></div>
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://www.drizopoulos.com/" class="external-link">Dimitris Rizopoulos</a>, <a href="https://pafonso.com/" class="external-link">Pedro Miranda Afonso</a>, <a href="https://gregpapageorgiou.com/" class="external-link">Grigorios Papageorgiou</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
