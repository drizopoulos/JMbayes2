<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Multi-State Processes • JMbayes2</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/yeti/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><!-- docsearch --><script src="../docsearch.js"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.3/docsearch.min.css" integrity="sha256-QOSRU/ra9ActyXkIBbiIB144aDBdtvXBcNc3OTNuX/Q=" crossorigin="anonymous">
<link href="../docsearch.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script><meta property="og:title" content="Multi-State Processes">
<meta property="og:description" content="JMbayes2">
<meta property="og:image" content="https://drizopoulos.github.io/JMbayes2/reference/figures/square_logo.png">
<meta property="og:image:alt" content="JMbayes2: Extended Joint Models for Longitudinal and Time-to-Event Data">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:creator" content="@drizopoulos">
<meta name="twitter:site" content="@drizopoulos">
<meta name="robots" content="noindex">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-YDBZ5DBBSP"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-YDBZ5DBBSP');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">JMbayes2</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.2-0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/JMbayes2.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Competing_Risks.html">Competing Risks</a>
    </li>
    <li>
      <a href="../articles/Dynamic_Predictions.html">Dynamic Predictions</a>
    </li>
    <li>
      <a href="../articles/Multi_State_Processes.html">Multi-State Processes</a>
    </li>
    <li>
      <a href="../articles/Non_Gaussian_Mixed_Models.html">Non-Gaussian Mixed Models</a>
    </li>
    <li>
      <a href="../articles/Transformation_Functions.html">Transformation Functions for Functional Forms</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/drizopoulos/JMbayes2/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
<form class="navbar-form navbar-right hidden-xs hidden-sm" role="search">
        <div class="form-group">
          <input type="search" class="form-control" name="search-input" id="search-input" placeholder="Search..." aria-label="Search for..." autocomplete="off">
</div>
      </form>
      
    </div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Multi-State Processes</h1>
                        <h4 data-toc-skip class="author">Grigorios Papageorgiou</h4>
            
            <h4 data-toc-skip class="date">2022-02-09</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/drizopoulos/JMbayes2/blob/HEAD/vignettes/Multi_State_Processes.Rmd" class="external-link"><code>vignettes/Multi_State_Processes.Rmd</code></a></small>
      <div class="hidden name"><code>Multi_State_Processes.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="multi-state-processes">Multi-state Processes<a class="anchor" aria-label="anchor" href="#multi-state-processes"></a>
</h2>
<div class="section level3">
<h3 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h3>
<p>It is often the case that a subject may transition between multiple states and we are interested to assess the association of longitudinal marker(s) with each of these transitions. In this vignette we will illustrate how to achieve this using <strong>JMbayes2</strong>.</p>
<p>We will consider a simple case with one longitudinal outcome and a three-state (illness-death) model, but this application can be extended for the cases of multiple longitudinal markers and more than three states.</p>
</div>
<div class="section level3">
<h3 id="data">Data<a class="anchor" aria-label="anchor" href="#data"></a>
</h3>
<p>First we will simulate data from a joint model with a single linear mixed effects model and a multi-state process with three possible states. The multi-state process can be visualized as:</p>
<p><img src="Multi_State_Processes_files/figure-html/ms_figure-1.png" width="700"></p>
<p>where all subjects start from state “Healthy” and then can transition to either state “Illness” and then state “Death” or directly to state “Death”. In this case, states “Healthy” and “Illness” are <em>transient</em> states as the subject, when occupying these states, can still transition to other states whereas “Death” is an absorbing state as when a subject reaches this state then no further transitions can occur. This means that three transitions are possible: <span class="math inline">\(1 \rightarrow 2\)</span>, <span class="math inline">\(1 \rightarrow 3\)</span> and <span class="math inline">\(2 \rightarrow 3\)</span> with transition intensities <span class="math inline">\(h_{12}\left(t\right)\)</span>, <span class="math inline">\(h_{13}\left(t\right)\)</span> and <span class="math inline">\(h_{23}\left(t\right)\)</span> respectively.</p>
<p>For our example the default functional form is assumed, i.e., that the linear predictor <span class="math inline">\(\eta(t)\)</span> of the mixed model is associated with the each transition intensity at time <span class="math inline">\(t\)</span>. The following piece of code simulates the data:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1234</span><span class="op">)</span>
<span class="co"># number of subjects</span>
<span class="va">N</span> <span class="op">&lt;-</span> <span class="fl">500</span>
<span class="co"># number of measurements per subject  </span>
<span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">20</span>
<span class="co"># vector of ids</span>
<span class="va">id</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">N</span>, each <span class="op">=</span> <span class="va">n</span><span class="op">)</span>
<span class="co"># minimum and maximum follow-up times  </span>
<span class="va">min.t</span> <span class="op">&lt;-</span> <span class="fl">0.01</span>
<span class="va">max.t</span> <span class="op">&lt;-</span> <span class="fl">16</span>
<span class="co"># sample time-points</span>
<span class="va">time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">replicate</a></span><span class="op">(</span><span class="va">N</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">n</span> <span class="op">-</span> <span class="fl">1</span>, min <span class="op">=</span> <span class="va">min.t</span>, max <span class="op">=</span> <span class="va">max.t</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, simplify <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="va">time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">c</span>, <span class="va">time</span><span class="op">)</span>
<span class="co"># sample continuous covariate  values</span>
<span class="va">Xcov.s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">N</span>, mean <span class="op">=</span> <span class="fl">4.763</span>, sd <span class="op">=</span> <span class="fl">2.8</span><span class="op">)</span> <span class="co"># wide version</span>
<span class="va">Xcov</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">Xcov.s</span>, each <span class="op">=</span> <span class="va">n</span><span class="op">)</span> <span class="co"># long</span>
<span class="co"># initiate data frame to store results</span>
<span class="va">DF</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="st">"id"</span> <span class="op">=</span> <span class="va">id</span>, <span class="st">"time"</span> <span class="op">=</span> <span class="va">time</span>, <span class="st">"X"</span> <span class="op">=</span> <span class="va">Xcov</span><span class="op">)</span>
<span class="co"># design matrices for fixed and random effects  </span>
<span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/methods.html">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">time</span> <span class="op">+</span> <span class="va">X</span>, data <span class="op">=</span> <span class="va">DF</span><span class="op">)</span>
<span class="va">Z</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/methods.html">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">time</span>, data <span class="op">=</span> <span class="va">DF</span><span class="op">)</span>
<span class="va">D11</span> <span class="op">&lt;-</span> <span class="fl">1.0</span> <span class="co"># variance of random intercepts</span>
<span class="va">D22</span> <span class="op">&lt;-</span> <span class="fl">0.5</span> <span class="co"># variance of random slopes</span>
<span class="co"># we simulate random effects</span>
<span class="va">b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">N</span>, sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">D11</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span>, sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">D22</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="co"># fixed effects coefficients  </span>
<span class="va">true.betas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.482</span>, <span class="fl">0.243</span>, <span class="fl">1.52</span><span class="op">)</span>
<span class="co"># linear predictor  </span>
<span class="va">eta.y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">X</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">true.betas</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">Z</span> <span class="op">*</span> <span class="va">b</span><span class="op">[</span><span class="va">id</span>, <span class="op">]</span><span class="op">)</span><span class="op">)</span>
<span class="co"># residual standard error  </span>
<span class="va">sigma.e</span> <span class="op">&lt;-</span> <span class="fl">1.242</span>
<span class="co"># sample longitudinal outcome values  </span>
<span class="va">DF</span><span class="op">$</span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">N</span> <span class="op">*</span> <span class="va">n</span>, <span class="va">eta.y</span>, <span class="va">sigma.e</span><span class="op">)</span>
<span class="co"># values for the association parameter per transition  </span>
<span class="va">alpha</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"alpha.01"</span> <span class="op">=</span> <span class="fl">0.8</span>, <span class="st">"alpha.02"</span> <span class="op">=</span> <span class="fl">0.55</span>, <span class="st">"alpha.12"</span> <span class="op">=</span> <span class="fl">1.25</span><span class="op">)</span>
<span class="co"># shape of Weibull for each transition  </span>
<span class="va">phi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"phi.01"</span> <span class="op">=</span> <span class="fl">12.325</span>, <span class="st">"phi.02"</span> <span class="op">=</span> <span class="fl">8.216</span>, <span class="st">"phi.12"</span> <span class="op">=</span> <span class="fl">3.243</span><span class="op">)</span>
<span class="co"># regression coefficients for transition intensities  </span>
<span class="va">gammas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"(Intercept)1"</span> <span class="op">=</span> <span class="op">-</span><span class="fl">22.25</span>, <span class="st">"X"</span> <span class="op">=</span> <span class="fl">1.2</span>,  
            <span class="st">"(Intercept)2"</span> <span class="op">=</span> <span class="op">-</span><span class="fl">18.25</span>, <span class="st">"X"</span> <span class="op">=</span> <span class="fl">1.2</span>,
            <span class="st">"(Intercept)3"</span> <span class="op">=</span> <span class="op">-</span><span class="fl">19.25</span>, <span class="st">"X"</span> <span class="op">=</span> <span class="fl">1.2</span><span class="op">)</span>
<span class="co"># design matrix transition intensities</span>
<span class="va">W</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="st">"(Intercept)1"</span><span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">N</span><span class="op">)</span>, <span class="va">Xcov</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, by <span class="op">=</span> <span class="va">n</span>, <span class="va">N</span><span class="op">*</span><span class="va">n</span><span class="op">)</span><span class="op">]</span>, 
           <span class="st">"(Intercept)2"</span><span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">N</span><span class="op">)</span>, <span class="va">Xcov</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, by <span class="op">=</span> <span class="va">n</span>, <span class="va">N</span><span class="op">*</span><span class="va">n</span><span class="op">)</span><span class="op">]</span>,
           <span class="st">"(Intercept)3"</span><span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">N</span><span class="op">)</span>, <span class="va">Xcov</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, by <span class="op">=</span> <span class="va">n</span>, <span class="va">N</span><span class="op">*</span><span class="va">n</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>

<span class="co">## linear predictor for transition: 0 -&gt; 1</span>
<span class="va">eta.t1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">W</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>, drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">gammas</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>
<span class="co">## linear predictor for transition: 0 -&gt; 2</span>
<span class="va">eta.t2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">W</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">4</span><span class="op">)</span>, drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">gammas</span><span class="op">[</span><span class="fl">3</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span>
<span class="co">## linear predictor for transition: 1 -&gt; 2</span>
<span class="va">eta.t3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">W</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">6</span><span class="op">)</span>, drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">gammas</span><span class="op">[</span><span class="fl">5</span><span class="op">:</span><span class="fl">6</span><span class="op">]</span><span class="op">)</span>
<span class="co"># we simulate event times using inverse transform sampling</span>
<span class="va">invS01</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">t</span>, <span class="va">u</span>, <span class="va">i</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">h</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">s</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">XX</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">s</span>, <span class="va">Xcov</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>
    <span class="va">ZZ</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">s</span><span class="op">)</span>
    <span class="va">f1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">XX</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">true.betas</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">ZZ</span> <span class="op">*</span> <span class="va">b</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">i</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">ZZ</span><span class="op">)</span><span class="op">)</span>, <span class="op">]</span><span class="op">)</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">phi</span><span class="op">[</span><span class="st">"phi.01"</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="va">phi</span><span class="op">[</span><span class="st">"phi.01"</span><span class="op">]</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">s</span><span class="op">)</span> <span class="op">+</span> <span class="va">eta.t1</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">+</span> <span class="va">f1</span><span class="op">*</span><span class="va">alpha</span><span class="op">[</span><span class="st">"alpha.01"</span><span class="op">]</span><span class="op">)</span>
  <span class="op">}</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/integrate.html" class="external-link">integrate</a></span><span class="op">(</span><span class="va">h</span>, lower <span class="op">=</span> <span class="fl">0</span>, upper <span class="op">=</span> <span class="va">t</span>, subdivisions <span class="op">=</span> <span class="fl">10000L</span><span class="op">)</span><span class="op">$</span><span class="va">value</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">u</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">invS02</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">t</span>, <span class="va">u</span>, <span class="va">i</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">h</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">s</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">XX</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">s</span>, <span class="va">Xcov</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>
    <span class="va">ZZ</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">s</span><span class="op">)</span>
    <span class="va">f1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">XX</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">true.betas</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">ZZ</span> <span class="op">*</span> <span class="va">b</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">i</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">ZZ</span><span class="op">)</span><span class="op">)</span>, <span class="op">]</span><span class="op">)</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">phi</span><span class="op">[</span><span class="st">"phi.02"</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="va">phi</span><span class="op">[</span><span class="st">"phi.02"</span><span class="op">]</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">s</span><span class="op">)</span> <span class="op">+</span> <span class="va">eta.t2</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">+</span> <span class="va">f1</span><span class="op">*</span><span class="va">alpha</span><span class="op">[</span><span class="st">"alpha.02"</span><span class="op">]</span><span class="op">)</span>
  <span class="op">}</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/integrate.html" class="external-link">integrate</a></span><span class="op">(</span><span class="va">h</span>, lower <span class="op">=</span> <span class="fl">0</span>, upper <span class="op">=</span> <span class="va">t</span>, subdivisions <span class="op">=</span> <span class="fl">10000</span><span class="op">)</span><span class="op">$</span><span class="va">value</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">u</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">invS12</span> <span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="va">t</span>, <span class="va">u</span>, <span class="va">i</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">h</span> <span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="va">s</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">XX</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">s</span>, <span class="va">Xcov</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>
    <span class="va">ZZ</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">s</span><span class="op">)</span>
    <span class="va">f1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">XX</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">true.betas</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">ZZ</span> <span class="op">*</span> <span class="va">b</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">i</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">ZZ</span><span class="op">)</span><span class="op">)</span>, <span class="op">]</span><span class="op">)</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">phi</span><span class="op">[</span><span class="st">"phi.12"</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="va">phi</span><span class="op">[</span><span class="st">"phi.12"</span><span class="op">]</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">s</span><span class="op">)</span> <span class="op">+</span> 
          <span class="va">eta.t3</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">+</span> <span class="va">f1</span> <span class="op">*</span> <span class="va">alpha</span><span class="op">[</span><span class="st">"alpha.12"</span><span class="op">]</span><span class="op">)</span>
  <span class="op">}</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/integrate.html" class="external-link">integrate</a></span><span class="op">(</span><span class="va">h</span>, lower <span class="op">=</span> <span class="fl">0</span>, upper <span class="op">=</span> <span class="va">t</span>, subdivisions <span class="op">=</span> <span class="fl">10000</span><span class="op">)</span><span class="op">$</span><span class="va">value</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">u</span><span class="op">)</span>
<span class="op">}</span>

<span class="co"># Probability for each transition</span>
<span class="va">u01</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">N</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>
<span class="va">u02</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">N</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>
<span class="va">u12</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">N</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>
<span class="co"># initiate vectors to save true event times</span>
<span class="va">trueT01</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span>
<span class="va">trueT02</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span>
<span class="va">trueT12</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span>

<span class="co"># sample censoring times</span>
<span class="va">mean.Cens</span> <span class="op">&lt;-</span> <span class="fl">9</span>
<span class="va">Ctimes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">N</span>, <span class="fl">0</span>, <span class="fl">2</span> <span class="op">*</span> <span class="va">mean.Cens</span><span class="op">)</span>

<span class="co"># simulate time-to-event data</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">N</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">Root01</span> <span class="op">&lt;-</span> <span class="cn">NULL</span>
  <span class="va">Root02</span> <span class="op">&lt;-</span> <span class="cn">NULL</span>
  <span class="va">Root12</span> <span class="op">&lt;-</span> <span class="cn">NULL</span>
  
  <span class="va">Up</span> <span class="op">&lt;-</span> <span class="fl">50</span>
  <span class="va">tries</span> <span class="op">&lt;-</span> <span class="fl">5</span>
  <span class="co"># Transition 0-&gt;1</span>
  <span class="va">Up</span> <span class="op">&lt;-</span> <span class="fl">200</span>
  <span class="va">Root01</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/try.html" class="external-link">try</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/uniroot.html" class="external-link">uniroot</a></span><span class="op">(</span><span class="va">invS01</span>, interval <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1e-05</span>, <span class="va">Up</span><span class="op">)</span>, u <span class="op">=</span> <span class="va">u01</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, i <span class="op">=</span> <span class="va">i</span><span class="op">)</span><span class="op">$</span><span class="va">root</span>, <span class="cn">TRUE</span><span class="op">)</span>
  <span class="va">trueT01</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">inherits</a></span><span class="op">(</span><span class="va">Root01</span>, <span class="st">"try-error"</span><span class="op">)</span><span class="op">)</span> <span class="va">Root01</span> <span class="kw">else</span> <span class="fl">500</span>
  
  <span class="co"># Transition 0-&gt;2</span>
  <span class="va">Up</span> <span class="op">&lt;-</span> <span class="fl">200</span>
  <span class="va">Root02</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/try.html" class="external-link">try</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/uniroot.html" class="external-link">uniroot</a></span><span class="op">(</span><span class="va">invS02</span>, interval <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1e-05</span>, <span class="va">Up</span><span class="op">)</span>, u <span class="op">=</span> <span class="va">u02</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, i <span class="op">=</span> <span class="va">i</span><span class="op">)</span><span class="op">$</span><span class="va">root</span>, <span class="cn">TRUE</span><span class="op">)</span>
  <span class="va">trueT02</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">inherits</a></span><span class="op">(</span><span class="va">Root02</span>, <span class="st">"try-error"</span><span class="op">)</span><span class="op">)</span> <span class="va">Root02</span> <span class="kw">else</span> <span class="fl">500</span>
  
  <span class="co"># Transition 1-&gt;2</span>
  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">trueT01</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">trueT02</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">trueT01</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span> <span class="op">&lt;</span> <span class="va">Ctimes</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">Up</span> <span class="op">&lt;-</span> <span class="va">Up</span> <span class="op">+</span> <span class="fl">200</span>
  <span class="va">Root12</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/try.html" class="external-link">try</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/uniroot.html" class="external-link">uniroot</a></span><span class="op">(</span><span class="va">invS12</span>, interval <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">trueT01</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>, <span class="va">Up</span><span class="op">)</span>, u <span class="op">=</span> <span class="va">u12</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, i <span class="op">=</span> <span class="va">i</span><span class="op">)</span><span class="op">$</span><span class="va">root</span>, <span class="cn">TRUE</span><span class="op">)</span>
  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span><span class="va">Root12</span> <span class="op">&lt;-</span> <span class="fl">500</span><span class="op">}</span>
  <span class="va">trueT12</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">inherits</a></span><span class="op">(</span><span class="va">Root12</span>, <span class="st">"try-error"</span><span class="op">)</span><span class="op">)</span> <span class="va">Root12</span> <span class="kw">else</span> <span class="fl">500</span>
<span class="op">}</span>

<span class="co"># initiate multi-state dataset in wide format</span>
<span class="va">data_mstate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="st">'id'</span> <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">N</span>, <span class="st">'trueT01'</span> <span class="op">=</span> <span class="va">trueT01</span>, <span class="st">'trueT02'</span> <span class="op">=</span> <span class="va">trueT02</span>, <span class="st">'trueT12'</span> <span class="op">=</span> <span class="va">trueT12</span>, 
                          <span class="st">'Ctimes'</span> <span class="op">=</span> <span class="va">Ctimes</span>, <span class="st">'X'</span> <span class="op">=</span> <span class="va">Xcov.s</span><span class="op">)</span>

<span class="co"># split by id</span>
<span class="va">data_mstate_split.by.id</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/split.html" class="external-link">split</a></span><span class="op">(</span><span class="va">data_mstate</span>, <span class="va">data_mstate</span><span class="op">$</span><span class="va">id</span><span class="op">)</span>

<span class="co"># function to pass to lapply to prepare multi-state data per id</span>
<span class="va">ms_arrange</span> <span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw">if</span> <span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">Ctimes</span> <span class="op">&lt;</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">trueT01</span>, <span class="va">x</span><span class="op">$</span><span class="va">trueT02</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">x_new</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="st">'id'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">id</span>, <span class="fl">2</span><span class="op">)</span>, <span class="st">'from_state'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>, <span class="st">'to_state'</span> <span class="op">=</span> <span class="fl">2</span><span class="op">:</span><span class="fl">3</span>, 
                        <span class="st">'transition'</span> <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="st">'Tstart'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span>, <span class="st">'Tstop'</span> <span class="op">=</span> <span class="va">x</span><span class="op">$</span><span class="va">Ctimes</span>, <span class="st">'status'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span>, 
                        <span class="st">'X'</span> <span class="op">=</span> <span class="va">x</span><span class="op">$</span><span class="va">X</span><span class="op">)</span>
  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
    <span class="kw">if</span> <span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">trueT02</span> <span class="op">&lt;</span> <span class="va">x</span><span class="op">$</span><span class="va">trueT01</span><span class="op">)</span> <span class="op">{</span>
      <span class="va">x_new</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="st">'id'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">id</span>, <span class="fl">2</span><span class="op">)</span>, <span class="st">'from_state'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>, <span class="st">'to_state'</span> <span class="op">=</span> <span class="fl">2</span><span class="op">:</span><span class="fl">3</span>, 
                          <span class="st">'transition'</span> <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="st">'Tstart'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span>, <span class="st">'Tstop'</span> <span class="op">=</span> <span class="va">x</span><span class="op">$</span><span class="va">trueT02</span>, <span class="st">'status'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, 
                          <span class="st">'X'</span> <span class="op">=</span> <span class="va">x</span><span class="op">$</span><span class="va">X</span><span class="op">)</span>
    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
      <span class="kw">if</span> <span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">Ctimes</span> <span class="op">&lt;</span> <span class="va">x</span><span class="op">$</span><span class="va">trueT12</span><span class="op">)</span> <span class="op">{</span>
        <span class="va">x_new</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="st">'id'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">id</span>, <span class="fl">3</span><span class="op">)</span>, <span class="st">'from_state'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>, <span class="st">'to_state'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">3</span>, <span class="fl">3</span><span class="op">)</span>, 
                            <span class="st">'transition'</span> <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="st">'Tstart'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span>, <span class="va">x</span><span class="op">$</span><span class="va">trueT01</span><span class="op">)</span>, 
                            <span class="st">'Tstop'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">trueT01</span>, <span class="fl">2</span><span class="op">)</span>, <span class="va">x</span><span class="op">$</span><span class="va">Ctimes</span><span class="op">)</span>, <span class="st">'status'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>, 
                            <span class="st">'X'</span> <span class="op">=</span> <span class="va">x</span><span class="op">$</span><span class="va">X</span><span class="op">)</span>
      <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
        <span class="va">x_new</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="st">'id'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">id</span>, <span class="fl">3</span><span class="op">)</span>, <span class="st">'from_state'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>, <span class="st">'to_state'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">3</span>, <span class="fl">3</span><span class="op">)</span>, 
                            <span class="st">'transition'</span> <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="st">'Tstart'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span>, <span class="va">x</span><span class="op">$</span><span class="va">trueT01</span><span class="op">)</span>, 
                            <span class="st">'Tstop'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">trueT01</span>, <span class="fl">2</span><span class="op">)</span>, <span class="va">x</span><span class="op">$</span><span class="va">trueT12</span><span class="op">)</span>, <span class="st">'status'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, 
                            <span class="st">'X'</span> <span class="op">=</span> <span class="va">x</span><span class="op">$</span><span class="va">X</span><span class="op">)</span>
      <span class="op">}</span>
    <span class="op">}</span> 
  <span class="op">}</span>
<span class="op">}</span>
<span class="va">data_mstate_split.by.id</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">data_mstate_split.by.id</span>, <span class="va">ms_arrange</span><span class="op">)</span>
<span class="va">data_mstate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">data_mstate_split.by.id</span><span class="op">)</span>
<span class="va">data_mstate</span><span class="op">$</span><span class="va">transition</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">data_mstate</span><span class="op">$</span><span class="va">transition</span><span class="op">)</span>

<span class="va">Tstop</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tapply.html" class="external-link">tapply</a></span><span class="op">(</span><span class="va">data_mstate</span><span class="op">$</span><span class="va">Tstop</span>, <span class="va">data_mstate</span><span class="op">$</span><span class="va">id</span>, <span class="va">max</span><span class="op">)</span>
<span class="va">Tstop</span> <span class="op">&lt;-</span> <span class="va">Tstop</span><span class="op">[</span><span class="va">id</span><span class="op">]</span>
<span class="va">DF</span> <span class="op">&lt;-</span> <span class="va">DF</span><span class="op">[</span><span class="va">DF</span><span class="op">$</span><span class="va">time</span> <span class="op">&lt;=</span> <span class="va">Tstop</span>, <span class="op">]</span></code></pre></div>
<p>The data for the multi-state process need to be in the appropriate long format:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">data_mstate</span>, n <span class="op">=</span> <span class="fl">5L</span><span class="op">)</span>
<span class="co">#&gt;     id from_state to_state transition   Tstart    Tstop status        X</span>
<span class="co">#&gt; 1.1  1          1        2          1 0.000000 4.392984      1 1.984455</span>
<span class="co">#&gt; 1.2  1          1        3          2 0.000000 4.392984      0 1.984455</span>
<span class="co">#&gt; 1.3  1          2        3          3 4.392984 9.094447      0 1.984455</span>
<span class="co">#&gt; 2.1  2          1        2          1 0.000000 1.552122      0 7.673231</span>
<span class="co">#&gt; 2.2  2          1        3          2 0.000000 1.552122      0 7.673231</span></code></pre></div>
<p>for example subject 1 experienced the following transition: <span class="math inline">\(1 \rightarrow 2\)</span> and therefore is represented in 3 rows, one for each transition, because all of these transitions were plausible. On the other hand subject 2 is only represented by two rows, only for transitions <span class="math inline">\(1 \rightarrow 2\)</span> and <span class="math inline">\(1 \rightarrow 3\)</span> since these are the only transitions that are possible from state 1. That is, since subject 2 never actually transitioned to state 2, transition <span class="math inline">\(2 \rightarrow 3\)</span> was never possible and therefore no row for this transition is in the dataset. It is also important to note that the time in the dataset follows the counting process formulation with intervals specified by <code>Tstart</code> and <code>Tstop</code> and that there is a variable (in this case <code>transition</code>) which indicates to which transition the row corresponds to.</p>
</div>
<div class="section level3">
<h3 id="fitting-the-model">Fitting the model<a class="anchor" aria-label="anchor" href="#fitting-the-model"></a>
</h3>
<p>As soon data in the appropriate format are available, fitting the model is very straightforward. First we fit a linear mixed model using the <code>lme()</code> function from package <strong>nlme</strong>:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mixedmodel</span> <span class="op">&lt;-</span> <span class="fu">lme</span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">time</span> <span class="op">+</span> <span class="va">X</span>, random <span class="op">=</span> <span class="op">~</span> <span class="va">time</span> <span class="op">|</span> <span class="va">id</span>, data <span class="op">=</span> <span class="va">DF</span><span class="op">)</span></code></pre></div>
<p>then we fit a multi-state model using function <code>coxph()</code> from package <strong>survival</strong> making sure we use the counting process specification and that we add <code>strata(transition)</code> to stratify by the transition indicator variable in the dataset. Furthermore we add an interaction between covariate <code>X</code> and each transition to allow the effect of this covariate to vary across transitions.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">msmodel</span> <span class="op">&lt;-</span> <span class="fu">coxph</span><span class="op">(</span><span class="fu">Surv</span><span class="op">(</span><span class="va">Tstart</span>, <span class="va">Tstop</span>, <span class="va">status</span><span class="op">)</span> <span class="op">~</span> <span class="va">X</span> <span class="op">*</span> <span class="fu">strata</span><span class="op">(</span><span class="va">transition</span><span class="op">)</span>, 
                 data <span class="op">=</span> <span class="va">data_mstate</span><span class="op">)</span></code></pre></div>
<p>Finally, to fit the joint model we simply run:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">jm_ms_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/jm.html">jm</a></span><span class="op">(</span><span class="va">msmodel</span>, <span class="va">mixedmodel</span>, time_var <span class="op">=</span> <span class="st">"time"</span>, 
                  functional_forms <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="../reference/jm.html">value</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">:</span><span class="va">transition</span>, n_iter <span class="op">=</span> <span class="fl">10000L</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">jm_ms_model</span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; jm(Surv_object = msmodel, Mixed_objects = mixedmodel, time_var = "time", </span>
<span class="co">#&gt;     functional_forms = ~value(y):transition, n_iter = 10000L)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Data Descriptives:</span>
<span class="co">#&gt; Number of Groups: 500        Number of events: 514 (39.1%)</span>
<span class="co">#&gt; Number of Observations:</span>
<span class="co">#&gt;   y: 4033</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;                  DIC     WAIC      LPML</span>
<span class="co">#&gt; marginal    17843.26 19494.07 -10740.64</span>
<span class="co">#&gt; conditional 19708.83 20957.42 -13342.78</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Random-effects covariance matrix:</span>
<span class="co">#&gt;                     </span>
<span class="co">#&gt;        StdDev   Corr</span>
<span class="co">#&gt; (Intr) 1.0177 (Intr)</span>
<span class="co">#&gt; time   0.7048 0.0270</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Survival Outcome:</span>
<span class="co">#&gt;                          Mean  StDev    2.5%  97.5%      P   Rhat</span>
<span class="co">#&gt; X                     -0.1028 0.0674 -0.2356 0.0312 0.1293 1.0511</span>
<span class="co">#&gt; X:strata(transition)2  0.3629 0.0970  0.1837 0.5445 0.0000 1.2748</span>
<span class="co">#&gt; X:strata(transition)3 -0.0262 0.0853 -0.1898 0.1455 0.7381 1.1613</span>
<span class="co">#&gt; value(y):transition1   0.2468 0.0374  0.1699 0.3215 0.0000 1.0393</span>
<span class="co">#&gt; value(y):transition2   0.2358 0.0695  0.0931 0.3627 0.0000 1.1096</span>
<span class="co">#&gt; value(y):transition3   0.0086 0.0242 -0.0407 0.0542 0.7253 1.0607</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Longitudinal Outcome: y (family = gaussian, link = identity)</span>
<span class="co">#&gt;                Mean  StDev    2.5%  97.5%      P   Rhat</span>
<span class="co">#&gt; (Intercept) -0.4278 0.4011 -1.2193 0.3788 0.2792 1.0004</span>
<span class="co">#&gt; time         0.3312 0.1053  0.1256 0.5408 0.0027 1.0002</span>
<span class="co">#&gt; X            1.5321 0.0359  1.4617 1.6018 0.0000 1.0013</span>
<span class="co">#&gt; sigma        1.2867 0.0454  1.2245 1.4025 0.0000 1.0002</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; MCMC summary:</span>
<span class="co">#&gt; chains: 3 </span>
<span class="co">#&gt; iterations per chain: 10000 </span>
<span class="co">#&gt; burn-in per chain: 500 </span>
<span class="co">#&gt; thinning: 1 </span>
<span class="co">#&gt; time: 3.2 min</span></code></pre></div>
<p>which differs from a default call to <code><a href="../reference/jm.html">jm()</a></code> by the addition of the <code>functional_forms</code> argument by which we specify that we want an “interaction” between the value of the marker and each transition which translates into a separate association parameter for the longitudinal marker and each transition.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by <a href="http://www.drizopoulos.com/" class="external-link">Dimitris Rizopoulos</a>, <a href="https://gregpapageorgiou.com/" class="external-link">Grigorios Papageorgiou</a>, <a href="https://pafonso.com/" class="external-link">Pedro Miranda Afonso</a>.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.2.</p>
</div>

      </footer>
</div>

  
<script src="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.1/docsearch.min.js" integrity="sha256-GKvGqXDznoRYHCwKXGnuchvKSwmx9SRMrZOTh2g4Sb0=" crossorigin="anonymous"></script><script>
  docsearch({
    
    
    apiKey: '66a8ef39105517ba1ce2f07aa1c70890',
    indexName: 'drizopoulos',
    inputSelector: 'input#search-input.form-control',
    transformData: function(hits) {
      return hits.map(function (hit) {
        hit.url = updateHitURL(hit);
        return hit;
      });
    }
  });
</script>
</body>
</html>
